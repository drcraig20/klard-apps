# 8.1 Format Utilities Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add currency, date, relative date, and card number formatting utilities to the commons package for cross-platform use.

**Architecture:** Extend existing `commons/src/utils/formatting.ts` with Intl.NumberFormat for currency and date-fns for date formatting. All utilities are pure functions with no side effects, following SRP.

**Tech Stack:** TypeScript, date-fns, Intl.NumberFormat (built-in)

---

## Prerequisites

- date-fns must be installed in commons package
- All utilities go in `commons/src/utils/formatting.ts` (extend existing file)

---

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| formatCurrency | Formats currency only | Accepts config options | N/A | Single function | No dependencies |
| formatDate | Formats date only | Accepts format string | N/A | Single function | Depends on date-fns abstraction |
| formatRelativeDate | Formats relative time only | Accepts options | N/A | Single function | Depends on date-fns abstraction |
| formatCardNumber | Formats card numbers only | Accepts separator option | N/A | Single function | No dependencies |

---

## Task 1: Install date-fns in commons package

**Files:**
- Modify: `commons/package.json`

**Step 1: Install date-fns**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps
pnpm --filter @klard-apps/commons add date-fns
```

**Step 2: Verify installation**

Run: `pnpm --filter @klard-apps/commons exec -- cat package.json | grep date-fns`
Expected: `"date-fns": "^X.X.X"`

**Step 3: Commit**

```bash
git add commons/package.json pnpm-lock.yaml
git commit -m "chore(commons): add date-fns dependency"
```

---

## Task 2: Write failing test for formatCurrency

**Files:**
- Create: `commons/src/utils/__tests__/formatting.test.ts`

**Step 1: Write the failing test**

```typescript
import { describe, it, expect } from 'vitest';
import {
  formatCurrency,
  formatCategoryLabel,
  formatCategoryUppercase,
} from '../formatting';

describe('formatCurrency', () => {
  it('formats USD currency with default locale', () => {
    expect(formatCurrency(1234.56)).toBe('$1,234.56');
  });

  it('formats EUR currency', () => {
    expect(formatCurrency(1234.56, 'EUR')).toBe('€1,234.56');
  });

  it('formats GBP currency', () => {
    expect(formatCurrency(99.99, 'GBP')).toBe('£99.99');
  });

  it('handles zero amount', () => {
    expect(formatCurrency(0)).toBe('$0.00');
  });

  it('handles negative amounts', () => {
    expect(formatCurrency(-50.25)).toBe('-$50.25');
  });

  it('handles large numbers with grouping', () => {
    expect(formatCurrency(1000000)).toBe('$1,000,000.00');
  });
});

// Existing tests for formatCategoryLabel and formatCategoryUppercase
describe('formatCategoryLabel', () => {
  it('converts snake_case to Title Case', () => {
    expect(formatCategoryLabel('health_fitness')).toBe('Health Fitness');
  });

  it('handles single word', () => {
    expect(formatCategoryLabel('entertainment')).toBe('Entertainment');
  });
});

describe('formatCategoryUppercase', () => {
  it('converts to uppercase with spaces', () => {
    expect(formatCategoryUppercase('health_fitness')).toBe('HEALTH FITNESS');
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter @klard-apps/commons test src/utils/__tests__/formatting.test.ts --run`
Expected: FAIL with "formatCurrency is not exported"

---

## Task 3: Implement formatCurrency

**Files:**
- Modify: `commons/src/utils/formatting.ts`

**Step 1: Write minimal implementation**

Add to `commons/src/utils/formatting.ts`:

```typescript
/**
 * Formats a number as currency
 * Uses Intl.NumberFormat for localization support
 *
 * @example formatCurrency(1234.56) => '$1,234.56'
 * @example formatCurrency(99.99, 'EUR') => '€99.99'
 */
export function formatCurrency(amount: number, currency = 'USD'): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency,
  }).format(amount);
}
```

**Step 2: Run test to verify it passes**

Run: `pnpm --filter @klard-apps/commons test src/utils/__tests__/formatting.test.ts --run`
Expected: PASS

**Step 3: Commit**

```bash
git add commons/src/utils/formatting.ts commons/src/utils/__tests__/formatting.test.ts
git commit -m "feat(commons): add formatCurrency utility"
```

---

## Task 4: Write failing test for formatDate

**Files:**
- Modify: `commons/src/utils/__tests__/formatting.test.ts`

**Step 1: Write the failing test**

Add to test file:

```typescript
import {
  formatCurrency,
  formatDate,
  formatCategoryLabel,
  formatCategoryUppercase,
} from '../formatting';

describe('formatDate', () => {
  it('formats date with default format (PPP)', () => {
    const date = new Date(2024, 0, 15); // Jan 15, 2024
    expect(formatDate(date)).toBe('January 15th, 2024');
  });

  it('formats date with custom format', () => {
    const date = new Date(2024, 5, 20); // June 20, 2024
    expect(formatDate(date, 'MM/dd/yyyy')).toBe('06/20/2024');
  });

  it('formats date with short format', () => {
    const date = new Date(2024, 11, 25); // Dec 25, 2024
    expect(formatDate(date, 'MMM d')).toBe('Dec 25');
  });

  it('formats date with time', () => {
    const date = new Date(2024, 0, 1, 14, 30); // Jan 1, 2024 2:30 PM
    expect(formatDate(date, 'PPP p')).toBe('January 1st, 2024 at 2:30 PM');
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter @klard-apps/commons test src/utils/__tests__/formatting.test.ts --run`
Expected: FAIL with "formatDate is not exported"

---

## Task 5: Implement formatDate

**Files:**
- Modify: `commons/src/utils/formatting.ts`

**Step 1: Write minimal implementation**

Add to `commons/src/utils/formatting.ts`:

```typescript
import { format as formatFn } from 'date-fns';

/**
 * Formats a date using date-fns format tokens
 * Default format is PPP (localized long date)
 *
 * @example formatDate(new Date()) => 'January 15th, 2024'
 * @example formatDate(new Date(), 'MM/dd/yyyy') => '01/15/2024'
 */
export function formatDate(date: Date, formatStr = 'PPP'): string {
  return formatFn(date, formatStr);
}
```

**Step 2: Run test to verify it passes**

Run: `pnpm --filter @klard-apps/commons test src/utils/__tests__/formatting.test.ts --run`
Expected: PASS

**Step 3: Commit**

```bash
git add commons/src/utils/formatting.ts commons/src/utils/__tests__/formatting.test.ts
git commit -m "feat(commons): add formatDate utility"
```

---

## Task 6: Write failing test for formatRelativeDate

**Files:**
- Modify: `commons/src/utils/__tests__/formatting.test.ts`

**Step 1: Write the failing test**

Add to test file:

```typescript
import {
  formatCurrency,
  formatDate,
  formatRelativeDate,
  formatCategoryLabel,
  formatCategoryUppercase,
} from '../formatting';

describe('formatRelativeDate', () => {
  it('formats date in the past with suffix', () => {
    const pastDate = new Date();
    pastDate.setDate(pastDate.getDate() - 3);
    expect(formatRelativeDate(pastDate)).toBe('3 days ago');
  });

  it('formats date in the future with suffix', () => {
    const futureDate = new Date();
    futureDate.setDate(futureDate.getDate() + 5);
    expect(formatRelativeDate(futureDate)).toBe('in 5 days');
  });

  it('formats recent time as less than a minute ago', () => {
    const now = new Date();
    expect(formatRelativeDate(now)).toBe('less than a minute ago');
  });

  it('formats hours ago', () => {
    const hoursAgo = new Date();
    hoursAgo.setHours(hoursAgo.getHours() - 2);
    expect(formatRelativeDate(hoursAgo)).toBe('about 2 hours ago');
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter @klard-apps/commons test src/utils/__tests__/formatting.test.ts --run`
Expected: FAIL with "formatRelativeDate is not exported"

---

## Task 7: Implement formatRelativeDate

**Files:**
- Modify: `commons/src/utils/formatting.ts`

**Step 1: Write minimal implementation**

Add to `commons/src/utils/formatting.ts`:

```typescript
import { format as formatFn, formatDistanceToNow } from 'date-fns';

/**
 * Formats a date as a relative time string (e.g., "3 days ago")
 * Always includes suffix for clarity
 *
 * @example formatRelativeDate(pastDate) => '3 days ago'
 * @example formatRelativeDate(futureDate) => 'in 5 days'
 */
export function formatRelativeDate(date: Date): string {
  return formatDistanceToNow(date, { addSuffix: true });
}
```

**Step 2: Run test to verify it passes**

Run: `pnpm --filter @klard-apps/commons test src/utils/__tests__/formatting.test.ts --run`
Expected: PASS

**Step 3: Commit**

```bash
git add commons/src/utils/formatting.ts commons/src/utils/__tests__/formatting.test.ts
git commit -m "feat(commons): add formatRelativeDate utility"
```

---

## Task 8: Write failing test for formatCardNumber

**Files:**
- Modify: `commons/src/utils/__tests__/formatting.test.ts`

**Step 1: Write the failing test**

Add to test file:

```typescript
import {
  formatCurrency,
  formatDate,
  formatRelativeDate,
  formatCardNumber,
  formatCategoryLabel,
  formatCategoryUppercase,
} from '../formatting';

describe('formatCardNumber', () => {
  it('formats last four digits with bullet points', () => {
    expect(formatCardNumber('1234')).toBe('•••• •••• •••• 1234');
  });

  it('handles different last four digits', () => {
    expect(formatCardNumber('5678')).toBe('•••• •••• •••• 5678');
  });

  it('handles edge case with less than 4 digits', () => {
    expect(formatCardNumber('12')).toBe('•••• •••• •••• 12');
  });

  it('handles empty string', () => {
    expect(formatCardNumber('')).toBe('•••• •••• •••• ');
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter @klard-apps/commons test src/utils/__tests__/formatting.test.ts --run`
Expected: FAIL with "formatCardNumber is not exported"

---

## Task 9: Implement formatCardNumber

**Files:**
- Modify: `commons/src/utils/formatting.ts`

**Step 1: Write minimal implementation**

Add to `commons/src/utils/formatting.ts`:

```typescript
/**
 * Formats a card number showing only the last four digits
 * Uses bullet points to mask the first 12 digits
 *
 * @example formatCardNumber('1234') => '•••• •••• •••• 1234'
 */
export function formatCardNumber(lastFour: string): string {
  return `•••• •••• •••• ${lastFour}`;
}
```

**Step 2: Run test to verify it passes**

Run: `pnpm --filter @klard-apps/commons test src/utils/__tests__/formatting.test.ts --run`
Expected: PASS

**Step 3: Commit**

```bash
git add commons/src/utils/formatting.ts commons/src/utils/__tests__/formatting.test.ts
git commit -m "feat(commons): add formatCardNumber utility"
```

---

## Task 10: Verify exports and build

**Files:**
- Verify: `commons/src/utils/index.ts`

**Step 1: Ensure utils/index.ts exports formatting**

Check that `commons/src/utils/index.ts` has:

```typescript
export * from './formatting';
```

**Step 2: Build commons**

Run: `pnpm --filter @klard-apps/commons build`
Expected: Build succeeds

**Step 3: Run all tests**

Run: `pnpm --filter @klard-apps/commons test --run`
Expected: All tests pass

**Step 4: Type check**

Run: `pnpm --filter @klard-apps/commons exec tsc --noEmit`
Expected: No type errors

**Step 5: Final commit**

```bash
git add -A
git commit -m "feat(commons): complete format utilities implementation"
```

---

## Task 11: Mark spec as DONE

**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md`

**Step 1: Update spec marker**

Find: `<!-- SECTION:START:8.1-format-utilities -->`
Add after: `<!-- DONE:8.1-format-utilities -->`

**Step 2: Commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 8.1-format-utilities as DONE"
```

---

## Verification Checklist

- [ ] date-fns installed in commons package
- [ ] All four format functions implemented
- [ ] All tests pass
- [ ] TypeScript compiles without errors
- [ ] Functions exported from commons package
- [ ] Spec marked as DONE