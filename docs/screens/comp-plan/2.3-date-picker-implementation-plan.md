# 2.3 DatePicker Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a cross-platform DatePicker that lets users pick dates (and time/datetime modes), respects min/max bounds, shows label/error/placeholder states, and matches Klard's design system on web (shadcn + Tailwind) and mobile (Expo native pickers).

**Architecture:** Web: client component using shadcn `Popover` + `Calendar` (react-day-picker) with `date-fns` formatting, wrapped in FormField-like structure for label/error, exporting through `@/components/ui`. Mobile: React Native component using Expo `@expo/ui` DateTimePicker (SwiftUI/Jetpack Compose) with fallback to community picker, haptic feedback, FormField styling, and accessibility props. Shared props surface ensures parity; min/max enforced in picker callbacks.

**Tech Stack:**
- Web: Next.js 16, React 19, TypeScript strict, Tailwind CSS 4, shadcn/ui Calendar + Popover, date-fns, lucide-react
- Mobile: React Native 0.81, Expo SDK 54, TypeScript strict, @expo/ui/swift-ui (iOS), @expo/ui/jetpack-compose (Android), @react-native-community/datetimepicker fallback, expo-haptics

---

## Pre-Implementation Checklist

Before starting, verify these skills are loaded:
- [ ] `superpowers:test-driven-development` - TDD workflow
- [ ] `superpowers:testing-anti-patterns` - Avoid common test mistakes
- [ ] `solid-design-principles` - SOLID compliance

---

## Component Specification

- **Component:** `DatePicker` — controlled date/time input with label/error/help, min/max bounds, and placeholder.
- **Targets:** Web (Next.js/shadcn) and Mobile (Expo/React Native).

### Props Interface

```typescript
// Web & Mobile (shared interface)
interface DatePickerProps {
  /** Currently selected date */
  value: Date | null;
  /** Callback when date changes */
  onChange: (date: Date | null) => void;
  /** Label text displayed above the picker */
  label?: string;
  /** Error message - displays in red below picker */
  error?: string;
  /** Minimum selectable date */
  minDate?: Date;
  /** Maximum selectable date */
  maxDate?: Date;
  /** Placeholder text when no date selected */
  placeholder?: string;
  /** Selection mode */
  mode?: 'date' | 'time' | 'datetime';
  /** Disables the picker */
  disabled?: boolean;
  /** Shows required asterisk after label */
  required?: boolean;
  /** Custom id for the trigger button (Web only) */
  id?: string;
  /** Additional className for the wrapper (Web only) */
  className?: string;
  /** Container style override (Mobile only) */
  containerStyle?: StyleProp<ViewStyle>;
}
```

### Visual States

| State | Description |
|-------|-------------|
| Default (placeholder/empty) | Trigger button with calendar icon and placeholder text |
| Selected | Shows formatted date in trigger |
| Hover/Focus (web) | Hover border change, focus ring primary/30 |
| Open | Popover with calendar visible (web) / Native picker modal (mobile) |
| Error | Red border, error message below with role="alert" |
| Disabled | Reduced opacity, non-interactive |
| Constrained | Dates outside minDate/maxDate are disabled/unselectable |
| Time-only | Shows time format (p) when mode='time' |
| Datetime | Shows combined format (PPPp) when mode='datetime' |

### Size Variants

Single default control height:
- Web: ~48px using existing input sizing (h-12)
- Mobile: 48px trigger height

No additional sizes; extend via className/style in future.

### Date Format Mapping

| Mode | Web Display (date-fns) | Mobile Display |
|------|------------------------|----------------|
| date | `PPP` → "June 15th, 2024" | `toLocaleDateString()` |
| time | `p` → "12:00 PM" | `toLocaleTimeString()` |
| datetime | `PPPp` → "June 15th, 2024 at 12:00 PM" | Combined toLocaleDateString + toLocaleTimeString |

### Design Tokens (Klard Design System)

| Token | Light Mode | Dark Mode | Usage |
|-------|------------|-----------|-------|
| Primary | #0D7C7A | #15B5B0 | CTAs, interactive, focus ring |
| Error | #DC2626 | #EF4444 | Error border, error text |
| Border | #CBD5E1 | #334155 | Default border |
| Text | #0F172A | #F8FAFC | Value text |
| Placeholder | #94A3B8 | #64748B | Placeholder text, muted |
| Background | #FFFFFF | #0F172A | Base background |
| Disabled BG | #F1F5F9 | #1E293B | Disabled state background |
| Focus Ring | primary/30 | primary/30 | Focus ring opacity |

### Accessibility

**Web:**
- `aria-invalid` when error present
- `aria-haspopup="dialog"` on trigger
- `aria-expanded` based on popover state
- `aria-required` when required=true
- `aria-describedby` linking to error message
- `data-slot="date-picker"` for styling hooks
- Keyboard focusable trigger
- Label linked via htmlFor

**Mobile:**
- `accessibilityRole="button"` on trigger
- `accessibilityLabel` from label prop
- `accessibilityState` { disabled, expanded }
- `accessibilityRole="alert"` on error message
- `testID="date-picker-trigger"` for testing
- `testID="date-picker-modal"` for picker modal

---

## SOLID Compliance

| Principle | Web Implementation | Mobile Implementation |
|-----------|-------------------|----------------------|
| **SRP** | Renders date/time input with popover calendar | Manages native pickers + trigger rendering |
| **OCP** | Styles/config extend via props/className; min/max/date/time handled via props | Picker modes extensible via props; styles via style props |
| **LSP** | Accepts any Date/null without stricter preconditions | Accepts shared props without narrowing |
| **ISP** | Props only for display/selection; no unused methods | Props focused on selection UI; no extra controls |
| **DIP** | Depends on abstractions (props callbacks, shadcn primitives) not concrete data sources | Uses injected props/haptics; depends on platform APIs via interfaces |

---

## Dependencies

### Web
- `react-day-picker` - Calendar primitives (via shadcn/ui Calendar)
- `@radix-ui/react-popover` - Popover primitives (via shadcn/ui Popover)
- `date-fns` - Date formatting
- `lucide-react` - Calendar icon

### Mobile
- `@expo/ui` - Native UI components (includes DateTimePicker)
- `@expo/vector-icons` - Ionicons for calendar icon
- `@react-native-community/datetimepicker` - Fallback picker if @expo/ui unavailable
- `expo-haptics` - Haptic feedback on selection

---

# PART 1: WEB IMPLEMENTATION

## Task 1: Install shadcn/ui Dependencies

**Files:**
- Create: `klard-web/src/components/ui/calendar.tsx` (via CLI)
- Create: `klard-web/src/components/ui/popover.tsx` (via CLI)

**Step 1: Check if Calendar and Popover exist**

```bash
ls /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-web/src/components/ui/ | grep -E "(calendar|popover)"
```

If missing, proceed to Step 2.

**Step 2: Run shadcn CLI to add components**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-web
npx shadcn@latest add calendar popover
```

**Step 3: Verify date-fns is installed**

```bash
grep "date-fns" /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-web/package.json
```

If missing:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-web && pnpm add date-fns
```

**Step 4: Verify installation**

```bash
ls -la /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-web/src/components/ui/calendar.tsx
ls -la /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-web/src/components/ui/popover.tsx
```

Expected: Both files exist

---

## Task 2: Write Failing Tests for DatePicker Rendering

**Files:**
- Create: `klard-web/src/__tests__/components/ui/date-picker.test.tsx`

**Step 1: Create test file with rendering tests**

```tsx
/**
 * Tests for DatePicker Component
 *
 * TDD: Write failing tests first, then implement to pass.
 * Tests verify: rendering, date display, popover behavior, accessibility
 */

import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { DatePicker } from '@/components/ui/date-picker';

describe('DatePicker', () => {
  const mockOnChange = vi.fn();

  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('Rendering', () => {
    it('should render with label', () => {
      render(<DatePicker label="Date of Birth" value={null} onChange={mockOnChange} />);

      expect(screen.getByText('Date of Birth')).toBeTruthy();
    });

    it('should render with placeholder when no value', () => {
      render(
        <DatePicker
          placeholder="Select a date"
          value={null}
          onChange={mockOnChange}
        />
      );

      expect(screen.getByText('Select a date')).toBeTruthy();
    });

    it('should render default placeholder when none provided', () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      expect(screen.getByText('Pick a date')).toBeTruthy();
    });

    it('should render calendar icon', () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      expect(screen.getByTestId('calendar-icon')).toBeTruthy();
    });

    it('should render as button role', () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      expect(screen.getByRole('button')).toBeTruthy();
    });

    it('should have data-slot attribute', () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      const trigger = screen.getByRole('button');
      expect(trigger.getAttribute('data-slot')).toBe('date-picker');
    });
  });
});
```

**Step 2: Run tests to verify they fail**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps
pnpm --filter klard-web test src/__tests__/components/ui/date-picker.test.tsx --run
```

Expected: FAIL - DatePicker component doesn't exist

---

## Task 3: Write Failing Tests for Date Display

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/date-picker.test.tsx`

**Step 1: Add date display tests**

```tsx
  describe('Date Display', () => {
    it('should display formatted date when value is provided', () => {
      const testDate = new Date(2024, 5, 15); // June 15, 2024
      render(<DatePicker value={testDate} onChange={mockOnChange} />);

      // date-fns format "PPP" = "June 15th, 2024"
      expect(screen.getByText(/June 15/)).toBeTruthy();
    });

    it('should display placeholder when value is null', () => {
      render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          placeholder="Choose date"
        />
      );

      expect(screen.getByText('Choose date')).toBeTruthy();
    });

    it('should handle invalid date gracefully', () => {
      const invalidDate = new Date('invalid');
      render(<DatePicker value={invalidDate} onChange={mockOnChange} />);

      // Should show placeholder for invalid date
      expect(screen.getByText('Pick a date')).toBeTruthy();
    });

    it('should format time when mode is time', () => {
      const testDate = new Date(2024, 5, 15, 14, 30); // 2:30 PM
      render(<DatePicker value={testDate} onChange={mockOnChange} mode="time" />);

      // date-fns format "p" = "2:30 PM"
      expect(screen.getByText(/2:30/)).toBeTruthy();
    });

    it('should format datetime when mode is datetime', () => {
      const testDate = new Date(2024, 5, 15, 14, 30);
      render(<DatePicker value={testDate} onChange={mockOnChange} mode="datetime" />);

      // date-fns format "PPPp" = "June 15th, 2024 at 2:30 PM"
      expect(screen.getByText(/June 15.*2:30/)).toBeTruthy();
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/date-picker.test.tsx --run
```

Expected: FAIL - Date display not implemented

---

## Task 4: Write Failing Tests for Required and Error States

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/date-picker.test.tsx`

**Step 1: Add required and error tests**

```tsx
  describe('Required Indicator', () => {
    it('should show asterisk when required', () => {
      render(
        <DatePicker
          label="Required Date"
          value={null}
          onChange={mockOnChange}
          required
        />
      );

      expect(screen.getByText('*')).toBeTruthy();
    });

    it('should not show asterisk when not required', () => {
      render(
        <DatePicker
          label="Optional Date"
          value={null}
          onChange={mockOnChange}
        />
      );

      expect(screen.queryByText('*')).toBeNull();
    });
  });

  describe('Error State', () => {
    it('should display error message', () => {
      render(
        <DatePicker
          label="Date"
          value={null}
          onChange={mockOnChange}
          error="Date is required"
        />
      );

      expect(screen.getByText('Date is required')).toBeTruthy();
    });

    it('should have error role on error message', () => {
      render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          error="Invalid date"
        />
      );

      expect(screen.getByRole('alert')).toBeTruthy();
    });

    it('should set aria-invalid when error is present', () => {
      render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          error="Error"
        />
      );

      const trigger = screen.getByRole('button');
      expect(trigger.getAttribute('aria-invalid')).toBe('true');
    });

    it('should link error to trigger via aria-describedby', () => {
      render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          error="Error message"
          id="test-picker"
        />
      );

      const trigger = screen.getByRole('button');
      expect(trigger.getAttribute('aria-describedby')).toBe('test-picker-error');
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/date-picker.test.tsx --run
```

Expected: FAIL - Required/Error states not implemented

---

## Task 5: Write Failing Tests for Disabled State and Accessibility

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/date-picker.test.tsx`

**Step 1: Add disabled and accessibility tests**

```tsx
  describe('Disabled State', () => {
    it('should be disabled when disabled prop is true', () => {
      render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          disabled
        />
      );

      const trigger = screen.getByRole('button');
      expect(trigger).toBeDisabled();
    });

    it('should not open calendar when disabled', () => {
      render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          disabled
        />
      );

      const trigger = screen.getByRole('button');
      fireEvent.click(trigger);

      expect(screen.queryByRole('grid')).toBeNull();
    });
  });

  describe('Accessibility', () => {
    it('should link label to trigger via htmlFor', () => {
      render(
        <DatePicker
          label="Start Date"
          value={null}
          onChange={mockOnChange}
          id="start-date"
        />
      );

      const label = screen.getByText('Start Date');
      expect(label.getAttribute('for')).toBe('start-date');
    });

    it('should have aria-haspopup on trigger', () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      const trigger = screen.getByRole('button');
      expect(trigger.getAttribute('aria-haspopup')).toBe('dialog');
    });

    it('should have aria-expanded based on open state', () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      const trigger = screen.getByRole('button');
      expect(trigger.getAttribute('aria-expanded')).toBe('false');

      fireEvent.click(trigger);
      expect(trigger.getAttribute('aria-expanded')).toBe('true');
    });

    it('should have aria-required when required', () => {
      render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          required
        />
      );

      const trigger = screen.getByRole('button');
      expect(trigger.getAttribute('aria-required')).toBe('true');
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/date-picker.test.tsx --run
```

Expected: FAIL - Disabled/Accessibility not implemented

---

## Task 6: Write Failing Tests for Popover and Date Constraints

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/date-picker.test.tsx`

**Step 1: Add popover behavior and date constraint tests**

```tsx
  describe('Popover Behavior', () => {
    it('should open calendar when trigger is clicked', async () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      const trigger = screen.getByRole('button');
      fireEvent.click(trigger);

      // Calendar should be visible in popover
      expect(screen.getByRole('grid')).toBeTruthy(); // Calendar renders as grid
    });

    it('should close calendar after date selection', async () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      const trigger = screen.getByRole('button');
      fireEvent.click(trigger);

      // Click a day in the calendar
      const dayButtons = screen.getAllByRole('gridcell');
      const selectableDay = dayButtons.find(
        (btn) => !btn.hasAttribute('disabled') && btn.textContent === '15'
      );
      if (selectableDay) {
        fireEvent.click(selectableDay);
      }

      expect(mockOnChange).toHaveBeenCalled();
    });
  });

  describe('Date Constraints', () => {
    it('should disable dates before minDate', () => {
      const minDate = new Date(2024, 5, 10); // June 10, 2024
      const currentMonth = new Date(2024, 5, 15);

      render(
        <DatePicker
          value={currentMonth}
          onChange={mockOnChange}
          minDate={minDate}
        />
      );

      const trigger = screen.getByRole('button');
      fireEvent.click(trigger);

      // Days before June 10 should be disabled
      const day5 = screen.getByText('5');
      expect(day5.closest('button')).toHaveAttribute('disabled');
    });

    it('should disable dates after maxDate', () => {
      const maxDate = new Date(2024, 5, 20); // June 20, 2024
      const currentMonth = new Date(2024, 5, 15);

      render(
        <DatePicker
          value={currentMonth}
          onChange={mockOnChange}
          maxDate={maxDate}
        />
      );

      const trigger = screen.getByRole('button');
      fireEvent.click(trigger);

      // Days after June 20 should be disabled
      const day25 = screen.getByText('25');
      expect(day25.closest('button')).toHaveAttribute('disabled');
    });
  });

  describe('onChange Callback', () => {
    it('should call onChange with selected date', () => {
      render(<DatePicker value={null} onChange={mockOnChange} />);

      const trigger = screen.getByRole('button');
      fireEvent.click(trigger);

      const dayButtons = screen.getAllByRole('gridcell');
      const day15 = dayButtons.find((btn) => btn.textContent === '15');
      if (day15) {
        fireEvent.click(day15);
      }

      expect(mockOnChange).toHaveBeenCalledWith(expect.any(Date));
    });
  });

  describe('Edge Cases', () => {
    it('should handle undefined value as null', () => {
      render(<DatePicker value={undefined as unknown as Date | null} onChange={mockOnChange} />);

      expect(screen.getByText('Pick a date')).toBeTruthy();
    });

    it('should merge custom className', () => {
      const { container } = render(
        <DatePicker value={null} onChange={mockOnChange} className="custom-class" />
      );

      // The wrapper div should have the custom class
      expect(container.firstChild).toHaveClass('custom-class');
    });
  });
```

**Step 2: Run all tests to verify they fail**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/date-picker.test.tsx --run
```

Expected: Multiple FAIL

---

## Task 7: Implement Web DatePicker Component

**Files:**
- Create: `klard-web/src/components/ui/date-picker.tsx`

**Step 1: Create the DatePicker component**

```tsx
'use client';

import { forwardRef, useState, useId } from 'react';
import { format, isValid } from 'date-fns';
import { Calendar as CalendarIcon } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Calendar } from '@/components/ui/calendar';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';

export interface DatePickerProps {
  /** Currently selected date */
  value: Date | null;
  /** Callback when date changes */
  onChange: (date: Date | null) => void;
  /** Label text displayed above the picker */
  label?: string;
  /** Error message - displays in red below picker */
  error?: string;
  /** Minimum selectable date */
  minDate?: Date;
  /** Maximum selectable date */
  maxDate?: Date;
  /** Placeholder text when no date selected */
  placeholder?: string;
  /** Selection mode */
  mode?: 'date' | 'time' | 'datetime';
  /** Disables the picker */
  disabled?: boolean;
  /** Shows required asterisk after label */
  required?: boolean;
  /** Custom id for the trigger button */
  id?: string;
  /** Additional className for the wrapper */
  className?: string;
}

export const DatePicker = forwardRef<HTMLButtonElement, DatePickerProps>(
  function DatePicker(
    {
      value,
      onChange,
      label,
      error,
      minDate,
      maxDate,
      placeholder = 'Pick a date',
      mode = 'date',
      disabled = false,
      required = false,
      id: providedId,
      className,
    },
    ref
  ) {
    const generatedId = useId();
    const id = providedId ?? generatedId;
    const [open, setOpen] = useState(false);

    // Validate the value is a valid date
    const validValue = value && isValid(value) ? value : null;

    // Format the display date based on mode
    const getDisplayFormat = () => {
      if (!validValue) return null;
      switch (mode) {
        case 'time':
          return format(validValue, 'p');
        case 'datetime':
          return format(validValue, 'PPPp');
        default:
          return format(validValue, 'PPP');
      }
    };

    const displayDate = getDisplayFormat();

    // Handle date selection
    const handleSelect = (date: Date | undefined) => {
      onChange(date ?? null);
      setOpen(false);
    };

    // Create disabled date matcher for Calendar
    const disabledMatcher = (date: Date) => {
      if (minDate && date < minDate) return true;
      if (maxDate && date > maxDate) return true;
      return false;
    };

    return (
      <div className={cn('w-full', className)}>
        {/* Label */}
        {label && (
          <label
            htmlFor={id}
            className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >
            {label}
            {required && (
              <span className="text-red-500 ml-1" aria-hidden="true">
                *
              </span>
            )}
          </label>
        )}

        {/* Popover with Calendar */}
        <Popover open={open} onOpenChange={setOpen}>
          <PopoverTrigger asChild>
            <Button
              ref={ref}
              id={id}
              type="button"
              variant="outline"
              disabled={disabled}
              data-slot="date-picker"
              aria-invalid={!!error}
              aria-haspopup="dialog"
              aria-expanded={open}
              aria-required={required}
              aria-describedby={error ? `${id}-error` : undefined}
              className={cn(
                'w-full h-12 justify-start text-left font-normal',
                // Default border
                !error && 'border-slate-300 dark:border-slate-700 hover:border-slate-400 dark:hover:border-slate-600',
                // Error styles
                error && 'border-red-500 focus:ring-red-500/30 focus:border-red-500',
                // Placeholder text color
                !validValue && 'text-slate-500 dark:text-slate-400',
                // Disabled styles
                disabled && 'opacity-50 cursor-not-allowed'
              )}
            >
              <CalendarIcon
                className="mr-2 h-4 w-4 text-slate-400"
                data-testid="calendar-icon"
              />
              {displayDate ?? placeholder}
            </Button>
          </PopoverTrigger>
          <PopoverContent className="w-auto p-0" align="start">
            <Calendar
              mode="single"
              selected={validValue ?? undefined}
              onSelect={handleSelect}
              disabled={disabledMatcher}
              defaultMonth={validValue ?? undefined}
            />
          </PopoverContent>
        </Popover>

        {/* Error message */}
        {error && (
          <p
            id={`${id}-error`}
            className="mt-2 text-sm text-red-500"
            role="alert"
          >
            {error}
          </p>
        )}
      </div>
    );
  }
);
```

**Step 2: Run tests to verify they pass**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/date-picker.test.tsx --run
```

Expected: All tests PASS

---

## Task 8: Export DatePicker from Index

**Files:**
- Modify: `klard-web/src/components/ui/index.ts`

**Step 1: Add DatePicker export**

Add this line to the exports:

```typescript
export { DatePicker, type DatePickerProps } from './date-picker';
```

**Step 2: Verify TypeScript compiles**

```bash
pnpm --filter klard-web exec tsc --noEmit
```

Expected: No TypeScript errors

**Step 3: Commit Web implementation**

```bash
git add klard-web/src/components/ui/date-picker.tsx klard-web/src/components/ui/calendar.tsx klard-web/src/components/ui/popover.tsx klard-web/src/components/ui/index.ts klard-web/src/__tests__/components/ui/date-picker.test.tsx
git commit -m "feat(web): add DatePicker component with TDD

- Add DatePicker component using shadcn/ui Calendar + Popover
- date-fns formatting for date display (PPP, p, PPPp modes)
- Support minDate/maxDate constraints
- Label, error, disabled, required states
- Full accessibility: aria-invalid, aria-haspopup, aria-expanded, aria-required, aria-describedby
- data-slot attribute for styling hooks
- Comprehensive test coverage"
```

---

# PART 2: MOBILE IMPLEMENTATION

## Task 9: Install Expo UI Dependencies

**Files:**
- Modify: `klard-mobile/package.json`

**Step 1: Check if @expo/ui is installed**

```bash
grep "@expo/ui" /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-mobile/package.json
```

If missing, proceed to Step 2.

**Step 2: Install @expo/ui and haptics**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-mobile
pnpm add @expo/ui expo-haptics
```

**Step 3: Verify installation**

```bash
grep -E "@expo/ui|expo-haptics" /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-mobile/package.json
```

Expected: Packages in dependencies

---

## Task 10: Write Failing Tests for Mobile DatePicker Rendering

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/DatePicker.test.tsx`

**Step 1: Create test file with rendering tests**

```tsx
/**
 * Tests for DatePicker Component (Mobile)
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import React from 'react';
import { render, fireEvent, waitFor } from '@testing-library/react-native';
import { DatePicker } from '@/components/ui/DatePicker';

// Mock @expo/vector-icons
jest.mock('@expo/vector-icons', () => ({
  Ionicons: ({ name, ...props }: { name: string }) => {
    const { Text } = require('react-native');
    return <Text {...props}>{name}</Text>;
  },
}));

// Mock expo-haptics
const mockImpactAsync = jest.fn();
jest.mock('expo-haptics', () => ({
  impactAsync: mockImpactAsync,
  ImpactFeedbackStyle: {
    Light: 'light',
    Medium: 'medium',
    Heavy: 'heavy',
  },
}));

// Mock @expo/ui packages (native components)
jest.mock('@expo/ui/swift-ui', () => ({
  DateTimePicker: ({ onDateSelected, ...props }: any) => {
    const { View, Text, Pressable } = require('react-native');
    return (
      <View testID="ios-date-picker" {...props}>
        <Pressable
          testID="mock-date-select"
          onPress={() => onDateSelected?.(new Date(2024, 5, 15).toISOString())}
        >
          <Text>Select Date</Text>
        </Pressable>
      </View>
    );
  },
  Host: ({ children }: any) => children,
}));

jest.mock('@expo/ui/jetpack-compose', () => ({
  DateTimePicker: ({ onDateSelected, ...props }: any) => {
    const { View, Text, Pressable } = require('react-native');
    return (
      <View testID="android-date-picker" {...props}>
        <Pressable
          testID="mock-date-select"
          onPress={() => onDateSelected?.(new Date(2024, 5, 15).toISOString())}
        >
          <Text>Select Date</Text>
        </Pressable>
      </View>
    );
  },
}));

describe('DatePicker', () => {
  const mockOnChange = jest.fn();

  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('Rendering', () => {
    it('should render with label', () => {
      const { getByText } = render(
        <DatePicker label="Date of Birth" value={null} onChange={mockOnChange} />
      );

      expect(getByText('Date of Birth')).toBeTruthy();
    });

    it('should render with placeholder when no value', () => {
      const { getByText } = render(
        <DatePicker
          placeholder="Select a date"
          value={null}
          onChange={mockOnChange}
        />
      );

      expect(getByText('Select a date')).toBeTruthy();
    });

    it('should render default placeholder when none provided', () => {
      const { getByText } = render(
        <DatePicker value={null} onChange={mockOnChange} />
      );

      expect(getByText('Pick a date')).toBeTruthy();
    });

    it('should render calendar icon', () => {
      const { getByText } = render(
        <DatePicker value={null} onChange={mockOnChange} />
      );

      expect(getByText('calendar-outline')).toBeTruthy();
    });

    it('should render the trigger pressable', () => {
      const { getByTestId } = render(
        <DatePicker value={null} onChange={mockOnChange} />
      );

      expect(getByTestId('date-picker-trigger')).toBeTruthy();
    });
  });
});
```

**Step 2: Run tests to verify they fail**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps
pnpm --filter klard-mobile test src/__tests__/components/ui/DatePicker.test.tsx --run
```

Expected: FAIL - DatePicker component doesn't exist

---

## Task 11: Write Failing Tests for Mobile Date Display

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/DatePicker.test.tsx`

**Step 1: Add date display tests**

```tsx
  describe('Date Display', () => {
    it('should display formatted date when value is provided', () => {
      const testDate = new Date(2024, 5, 15); // June 15, 2024
      const { getByText } = render(
        <DatePicker value={testDate} onChange={mockOnChange} />
      );

      // Should show localized date format
      expect(getByText(/6\/15\/2024|15\/6\/2024|Jun/)).toBeTruthy();
    });

    it('should display placeholder when value is null', () => {
      const { getByText } = render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          placeholder="Choose date"
        />
      );

      expect(getByText('Choose date')).toBeTruthy();
    });

    it('should handle invalid date gracefully', () => {
      const invalidDate = new Date('invalid');
      const { getByText } = render(
        <DatePicker value={invalidDate} onChange={mockOnChange} />
      );

      // Should show placeholder for invalid date
      expect(getByText('Pick a date')).toBeTruthy();
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/DatePicker.test.tsx --run
```

Expected: FAIL - Date display not implemented

---

## Task 12: Write Failing Tests for Mobile Required and Error States

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/DatePicker.test.tsx`

**Step 1: Add required and error tests**

```tsx
  describe('Required Indicator', () => {
    it('should show asterisk when required', () => {
      const { getByText } = render(
        <DatePicker
          label="Required Date"
          value={null}
          onChange={mockOnChange}
          required
        />
      );

      expect(getByText('*')).toBeTruthy();
    });

    it('should not show asterisk when not required', () => {
      const { queryByText } = render(
        <DatePicker
          label="Optional Date"
          value={null}
          onChange={mockOnChange}
        />
      );

      expect(queryByText('*')).toBeNull();
    });
  });

  describe('Error State', () => {
    it('should display error message', () => {
      const { getByText } = render(
        <DatePicker
          label="Date"
          value={null}
          onChange={mockOnChange}
          error="Date is required"
        />
      );

      expect(getByText('Date is required')).toBeTruthy();
    });

    it('should have alert accessibility role on error message', () => {
      const { getByRole } = render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          error="Invalid date"
        />
      );

      expect(getByRole('alert')).toBeTruthy();
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/DatePicker.test.tsx --run
```

Expected: FAIL - Required/Error states not implemented

---

## Task 13: Write Failing Tests for Mobile Disabled and Picker Behavior

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/DatePicker.test.tsx`

**Step 1: Add disabled and picker behavior tests**

```tsx
  describe('Disabled State', () => {
    it('should have disabled accessibility state when disabled', () => {
      const { getByTestId } = render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          disabled
        />
      );

      const trigger = getByTestId('date-picker-trigger');
      expect(trigger.props.accessibilityState?.disabled).toBe(true);
    });

    it('should not show picker when disabled', () => {
      const { getByTestId, queryByTestId } = render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          disabled
        />
      );

      const trigger = getByTestId('date-picker-trigger');
      fireEvent.press(trigger);

      expect(queryByTestId('ios-date-picker')).toBeNull();
      expect(queryByTestId('android-date-picker')).toBeNull();
    });
  });

  describe('Picker Behavior', () => {
    it('should show picker when trigger is pressed', async () => {
      const { getByTestId, queryByTestId } = render(
        <DatePicker value={null} onChange={mockOnChange} />
      );

      // Initially picker should not be visible
      expect(queryByTestId('ios-date-picker')).toBeNull();
      expect(queryByTestId('android-date-picker')).toBeNull();

      const trigger = getByTestId('date-picker-trigger');
      fireEvent.press(trigger);

      // One of the pickers should now be visible
      await waitFor(() => {
        const iosPicker = queryByTestId('ios-date-picker');
        const androidPicker = queryByTestId('android-date-picker');
        expect(iosPicker || androidPicker).toBeTruthy();
      });
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/DatePicker.test.tsx --run
```

Expected: FAIL - Disabled/Picker behavior not implemented

---

## Task 14: Write Failing Tests for Mobile Accessibility, Callbacks, and Haptics

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/DatePicker.test.tsx`

**Step 1: Add accessibility, callback, and haptics tests**

```tsx
  describe('Accessibility', () => {
    it('should have accessibilityLabel from label prop', () => {
      const { getByTestId } = render(
        <DatePicker
          label="Start Date"
          value={null}
          onChange={mockOnChange}
        />
      );

      const trigger = getByTestId('date-picker-trigger');
      expect(trigger.props.accessibilityLabel).toBe('Start Date');
    });

    it('should have accessibilityRole of button', () => {
      const { getByTestId } = render(
        <DatePicker value={null} onChange={mockOnChange} />
      );

      const trigger = getByTestId('date-picker-trigger');
      expect(trigger.props.accessibilityRole).toBe('button');
    });
  });

  describe('onChange Callback', () => {
    it('should call onChange when date is selected', async () => {
      const { getByTestId, queryByTestId } = render(
        <DatePicker value={null} onChange={mockOnChange} />
      );

      const trigger = getByTestId('date-picker-trigger');
      fireEvent.press(trigger);

      await waitFor(() => {
        const mockSelect = queryByTestId('mock-date-select');
        expect(mockSelect).toBeTruthy();
        if (mockSelect) {
          fireEvent.press(mockSelect);
        }
      });

      expect(mockOnChange).toHaveBeenCalledWith(expect.any(Date));
    });
  });

  describe('Haptic Feedback', () => {
    it('should trigger haptic feedback on date selection', async () => {
      const { getByTestId, queryByTestId } = render(
        <DatePicker value={null} onChange={mockOnChange} />
      );

      const trigger = getByTestId('date-picker-trigger');
      fireEvent.press(trigger);

      await waitFor(() => {
        const mockSelect = queryByTestId('mock-date-select');
        if (mockSelect) {
          fireEvent.press(mockSelect);
        }
      });

      expect(mockImpactAsync).toHaveBeenCalled();
    });
  });

  describe('Edge Cases', () => {
    it('should handle undefined value as null', () => {
      const { getByText } = render(
        <DatePicker
          value={undefined as unknown as Date | null}
          onChange={mockOnChange}
        />
      );

      expect(getByText('Pick a date')).toBeTruthy();
    });

    it('should apply custom containerStyle', () => {
      const customStyle = { marginTop: 20 };
      const { getByTestId } = render(
        <DatePicker
          value={null}
          onChange={mockOnChange}
          containerStyle={customStyle}
        />
      );

      expect(getByTestId('date-picker-trigger')).toBeTruthy();
    });
  });
```

**Step 2: Run all tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/DatePicker.test.tsx --run
```

Expected: Multiple FAIL

---

## Task 15: Implement Mobile DatePicker Component

**Files:**
- Create: `klard-mobile/src/components/ui/DatePicker.tsx`

**Step 1: Create the DatePicker component**

```tsx
import React, { useState } from 'react';
import {
  View,
  Text,
  Pressable,
  Platform,
  StyleSheet,
  type StyleProp,
  type ViewStyle,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';

// Platform-specific imports
let SwiftUIDateTimePicker: any;
let Host: any;
let JetpackDateTimePicker: any;

if (Platform.OS === 'ios') {
  const swiftUI = require('@expo/ui/swift-ui');
  SwiftUIDateTimePicker = swiftUI.DateTimePicker;
  Host = swiftUI.Host;
} else if (Platform.OS === 'android') {
  const jetpack = require('@expo/ui/jetpack-compose');
  JetpackDateTimePicker = jetpack.DateTimePicker;
}

export interface DatePickerProps {
  /** Currently selected date */
  value: Date | null;
  /** Callback when date changes */
  onChange: (date: Date | null) => void;
  /** Label text displayed above the picker */
  label?: string;
  /** Error message - displays in red below picker */
  error?: string;
  /** Minimum selectable date */
  minDate?: Date;
  /** Maximum selectable date */
  maxDate?: Date;
  /** Placeholder text when no date selected */
  placeholder?: string;
  /** Selection mode */
  mode?: 'date' | 'time' | 'datetime';
  /** Disables the picker */
  disabled?: boolean;
  /** Shows required asterisk after label */
  required?: boolean;
  /** Container style override */
  containerStyle?: StyleProp<ViewStyle>;
}

// Helper to check if date is valid
function isValidDate(date: Date | null | undefined): date is Date {
  return date instanceof Date && !isNaN(date.getTime());
}

// Map mode to displayed components
function getDisplayedComponents(mode: 'date' | 'time' | 'datetime'): string {
  switch (mode) {
    case 'time':
      return 'hourAndMinute';
    case 'datetime':
      return 'date'; // For now, just date (datetime needs more complex handling)
    default:
      return 'date';
  }
}

export function DatePicker({
  value,
  onChange,
  label,
  error,
  minDate,
  maxDate,
  placeholder = 'Pick a date',
  mode = 'date',
  disabled = false,
  required = false,
  containerStyle,
}: DatePickerProps) {
  const [showPicker, setShowPicker] = useState(false);

  // Validate the value
  const validValue = isValidDate(value) ? value : null;

  // Format for display
  const displayDate = validValue
    ? mode === 'time'
      ? validValue.toLocaleTimeString()
      : validValue.toLocaleDateString()
    : null;

  // Handle date selection
  const handleDateSelected = async (dateString: string) => {
    const selectedDate = new Date(dateString);
    if (isValidDate(selectedDate)) {
      // Enforce min/max constraints
      if (minDate && selectedDate < minDate) return;
      if (maxDate && selectedDate > maxDate) return;

      onChange(selectedDate);
      await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    }
    setShowPicker(false);
  };

  // Handle trigger press
  const handlePress = () => {
    if (!disabled) {
      setShowPicker(true);
    }
  };

  const displayedComponents = getDisplayedComponents(mode);

  return (
    <View style={[styles.container, containerStyle]}>
      {/* Label */}
      {label && (
        <Text style={[styles.label, disabled && styles.labelDisabled]}>
          {label}
          {required && <Text style={styles.required}> *</Text>}
        </Text>
      )}

      {/* Trigger */}
      <Pressable
        onPress={handlePress}
        disabled={disabled}
        testID="date-picker-trigger"
        accessibilityLabel={label}
        accessibilityRole="button"
        accessibilityState={{ disabled }}
        style={[
          styles.trigger,
          {
            borderColor: error ? colors.error : colors.border,
            borderWidth: error ? 2 : 1,
          },
          disabled && styles.triggerDisabled,
        ]}
      >
        <Ionicons
          name="calendar-outline"
          size={20}
          color={disabled ? colors.iconDisabled : colors.icon}
        />
        <Text
          style={[
            styles.value,
            !validValue && styles.placeholder,
            disabled && styles.valueDisabled,
          ]}
        >
          {displayDate ?? placeholder}
        </Text>
      </Pressable>

      {/* Platform-specific DateTimePicker */}
      {showPicker && Platform.OS === 'ios' && SwiftUIDateTimePicker && Host && (
        <View style={styles.pickerContainer}>
          <Host matchContents>
            <SwiftUIDateTimePicker
              onDateSelected={handleDateSelected}
              displayedComponents={displayedComponents}
              initialDate={(validValue || new Date()).toISOString()}
              variant="wheel"
              minimumDate={minDate?.toISOString()}
              maximumDate={maxDate?.toISOString()}
            />
          </Host>
        </View>
      )}

      {showPicker && Platform.OS === 'android' && JetpackDateTimePicker && (
        <JetpackDateTimePicker
          onDateSelected={handleDateSelected}
          displayedComponents={displayedComponents}
          initialDate={(validValue || new Date()).toISOString()}
          variant="picker"
          minimumDate={minDate?.toISOString()}
          maximumDate={maxDate?.toISOString()}
        />
      )}

      {/* Error message */}
      {error && (
        <Text style={styles.error} accessibilityRole="alert">
          {error}
        </Text>
      )}
    </View>
  );
}

// Color constants aligned with Klard design system
const colors = {
  primary: '#0D7C7A',
  error: '#DC2626',
  border: '#CBD5E1',
  placeholder: '#94A3B8',
  icon: '#64748B',
  iconDisabled: '#94A3B8',
  text: '#0F172A',
  textSecondary: '#475569',
  background: '#FFFFFF',
  backgroundDisabled: '#F1F5F9',
};

const styles = StyleSheet.create({
  container: {
    width: '100%',
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    color: colors.textSecondary,
    marginBottom: 8,
  },
  labelDisabled: {
    opacity: 0.5,
  },
  required: {
    color: colors.error,
  },
  trigger: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.background,
    borderRadius: 12,
    height: 48,
    paddingHorizontal: 16,
    gap: 12,
  },
  triggerDisabled: {
    backgroundColor: colors.backgroundDisabled,
    opacity: 0.7,
  },
  value: {
    flex: 1,
    fontSize: 16,
    color: colors.text,
  },
  placeholder: {
    color: colors.placeholder,
  },
  valueDisabled: {
    color: colors.icon,
  },
  pickerContainer: {
    marginTop: 8,
    backgroundColor: colors.background,
    borderRadius: 12,
    overflow: 'hidden',
  },
  error: {
    fontSize: 14,
    color: colors.error,
    marginTop: 8,
  },
});
```

**Step 2: Run tests to verify they pass**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/DatePicker.test.tsx --run
```

Expected: All tests PASS

---

## Task 16: Export Mobile DatePicker from Index

**Files:**
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Add DatePicker export**

Add this line to the exports:

```typescript
export { DatePicker, type DatePickerProps } from './DatePicker';
```

**Step 2: Verify TypeScript compiles**

```bash
pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No TypeScript errors

**Step 3: Commit Mobile implementation**

```bash
git add klard-mobile/src/components/ui/DatePicker.tsx klard-mobile/src/components/ui/index.ts klard-mobile/src/__tests__/components/ui/DatePicker.test.tsx
git commit -m "feat(mobile): add DatePicker component with TDD

- Add DatePicker component using native Expo UI pickers
- @expo/ui/swift-ui for iOS, @expo/ui/jetpack-compose for Android
- expo-haptics feedback on date selection
- Support mode (date/time/datetime), minDate/maxDate constraints
- Label, error, disabled, required states
- Full accessibility support
- Comprehensive test coverage"
```

---

# PART 3: VERIFICATION & COMPLETION

## Task 17: Run Full Test Suite

**Step 1: Run all web tests**

```bash
pnpm --filter klard-web test --run
```

Expected: All tests PASS

**Step 2: Run all mobile tests**

```bash
pnpm --filter klard-mobile test --run
```

Expected: All tests PASS

**Step 3: Run TypeScript check on both**

```bash
pnpm --filter klard-web exec tsc --noEmit && pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No TypeScript errors

---

## Task 18: Verification Checklist

Complete this checklist before marking component as DONE:

**Web DatePicker:**
- [ ] Component renders without errors
- [ ] All props implemented and typed
- [ ] Label displays when provided
- [ ] Required asterisk shows when required=true
- [ ] Error message displays and has role="alert"
- [ ] aria-describedby links trigger to error
- [ ] Disabled state prevents opening
- [ ] Date constraints (minDate/maxDate) work
- [ ] Popover opens/closes correctly
- [ ] Date formatting works (date-fns PPP, p, PPPp)
- [ ] Invalid dates handled gracefully
- [ ] Custom className merges correctly
- [ ] data-slot="date-picker" attribute present
- [ ] Accessibility: aria-invalid, aria-haspopup, aria-expanded, aria-required
- [ ] TypeScript compiles with no errors
- [ ] All tests passing
- [ ] Exported from index.ts

**Mobile DatePicker:**
- [ ] Component renders without errors
- [ ] All props implemented and typed
- [ ] Label displays when provided
- [ ] Required asterisk shows when required=true
- [ ] Error message displays and has accessibilityRole="alert"
- [ ] Disabled state prevents opening
- [ ] Native picker opens correctly (iOS/Android)
- [ ] Date formatting works (toLocaleDateString/toLocaleTimeString)
- [ ] minDate/maxDate constraints enforced
- [ ] Haptic feedback on selection
- [ ] Invalid dates handled gracefully
- [ ] Custom containerStyle applies
- [ ] Accessibility: accessibilityLabel, accessibilityRole, accessibilityState
- [ ] testID="date-picker-trigger" present
- [ ] TypeScript compiles with no errors
- [ ] All tests passing
- [ ] Exported from index.ts

---

## Task 19: Mark Component as DONE

**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md`

**Step 1: Update spec marker**

Replace:
```
<!-- IN-PROGRESS:2.3-date-picker -->
```

With:
```
<!-- DONE:2.3-date-picker -->
```

**Step 2: Final commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 2.3-date-picker component as DONE"
```

---

## Summary

| Task | Platform | Description |
|------|----------|-------------|
| 1 | Web | Install shadcn/ui calendar + popover |
| 2-6 | Web | Write failing tests (TDD RED phase) |
| 7 | Web | Implement DatePicker component (TDD GREEN phase) |
| 8 | Web | Export from index.ts |
| 9 | Mobile | Install @expo/ui + expo-haptics |
| 10-14 | Mobile | Write failing tests (TDD RED phase) |
| 15 | Mobile | Implement DatePicker component (TDD GREEN phase) |
| 16 | Mobile | Export from index.ts |
| 17 | Both | Run full test suite |
| 18 | Both | Verification checklist |
| 19 | Docs | Mark component as DONE |

**Total Tasks:** 19

---

## File Structure

### Web
```
klard-web/src/
├── components/ui/
│   ├── calendar.tsx        # shadcn base (from CLI)
│   ├── popover.tsx         # shadcn base (from CLI)
│   ├── date-picker.tsx     # Klard component
│   └── index.ts            # Export added
└── __tests__/components/ui/
    └── date-picker.test.tsx # Test file
```

### Mobile
```
klard-mobile/src/
├── components/ui/
│   ├── DatePicker.tsx      # Component
│   └── index.ts            # Export added
└── __tests__/components/ui/
    └── DatePicker.test.tsx # Test file
```

---

## Execution Options

**Plan complete and saved to `docs/screens/comp-plan/2.3-date-picker-implementation-plan-merged.md`.**

**Two execution options:**

1. **Subagent-Driven (this session)** - Dispatch fresh subagent per task, review between tasks, fast iteration

2. **Parallel Session (separate)** - Open new session with executing-plans, batch execution with checkpoints

**Which approach?**