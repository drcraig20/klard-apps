# Alert Banner Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a versatile AlertBanner component for prominent inline messages with success, error, warning, and info variants across web and mobile.

**Architecture:** Extend shadcn/ui Alert primitives for web with CVA-based variants for Klard design system. For mobile, create a native component with StyleSheet and theme integration. Both platforms share the same prop interface for consistency.

**Tech Stack:** React, TypeScript, Tailwind CSS, CVA (web), React Native, StyleSheet, expo-haptics (mobile)

---

## Component Overview

**Name:** AlertBanner (web: `alert-banner.tsx`, mobile: `AlertBanner.tsx`)

**Purpose:** Display prominent inline messages for success, error, warning, and info states with optional dismiss capability and actions.

**Used In:** Screens 4, 17, 21, 25, 32

---

## Props Interface

```typescript
// Shared interface for both platforms
interface AlertBannerProps {
  /** Alert type determines icon and styling */
  type: 'success' | 'error' | 'warning' | 'info';
  /** Optional title for the alert */
  title?: string;
  /** Alert message content */
  children: React.ReactNode;
  /** Whether the alert can be dismissed */
  dismissible?: boolean;
  /** Callback when dismiss button is clicked */
  onDismiss?: () => void;
  /** Optional action element (button, link) */
  action?: React.ReactNode;
  /** Additional CSS/style overrides */
  className?: string; // web
  style?: StyleProp<ViewStyle>; // mobile
  /** Test ID for testing */
  testID?: string; // mobile
}
```

---

## Visual States

| State | Description |
|-------|-------------|
| Success | Green tones - checkmark icon |
| Error | Red tones - alert circle icon |
| Warning | Amber tones - warning triangle icon |
| Info | Teal tones - info circle icon |
| Dismissible | Shows X button when dismissible=true |
| With Action | Renders action element below description |

---

## Color Tokens (Klard Design System)

### Light Theme
| Type | Background | Border | Text/Icon |
|------|------------|--------|-----------|
| Success | `bg-green-50` | `border-green-500` | `text-green-800` |
| Error | `bg-red-50` | `border-red-500` | `text-red-800` |
| Warning | `bg-amber-50` | `border-amber-500` | `text-amber-800` |
| Info | `bg-teal-50` | `border-teal-500` | `text-teal-800` |

### Dark Theme
| Type | Background | Border | Text/Icon |
|------|------------|--------|-----------|
| Success | `bg-green-900/20` | `border-green-500` | `text-green-400` |
| Error | `bg-red-900/20` | `border-red-500` | `text-red-400` |
| Warning | `bg-amber-900/20` | `border-amber-500` | `text-amber-400` |
| Info | `bg-teal-900/20` | `border-teal-500` | `text-teal-400` |

---

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| AlertBanner | Renders alert message only | Types via CVA/variants | Handles all type values | Single AlertBannerProps | Depends on type abstractions |

**SRP:** One responsibility - render an alert with styling based on type
**OCP:** New types can be added via variant config without modifying component logic
**LSP:** All type variants are substitutable
**ISP:** Single focused interface with optional props
**DIP:** Depends on type prop abstraction, not concrete implementations

---

## Test Strategy (TDD)

### Web Tests (`alert-banner.test.tsx`)
1. Renders with children text
2. Has data-slot attribute
3. Renders all type variants (success, error, warning, info)
4. Shows correct icon for each type
5. Renders title when provided
6. Shows dismiss button when dismissible=true
7. Hides dismiss button by default
8. Calls onDismiss when dismiss clicked
9. Renders action element when provided
10. Applies custom className
11. Has role="alert" for accessibility

### Mobile Tests (`AlertBanner.test.tsx`)
1. Renders with children text
2. Has correct accessibility role
3. Renders all type variants
4. Shows correct icon for each type
5. Renders title when provided
6. Shows dismiss button when dismissible=true
7. Hides dismiss button by default
8. Calls onDismiss when dismiss pressed
9. Triggers haptic feedback on dismiss
10. Renders action element when provided

---

## Task Breakdown

### Task 1: Web - Create test file with failing tests

**Files:**
- Create: `klard-web/src/__tests__/components/ui/alert-banner.test.tsx`

**Step 1: Write the failing tests**

```tsx
/**
 * Tests for AlertBanner Component
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import { describe, it, expect, vi } from "vitest";
import { render, screen, fireEvent } from "@testing-library/react";
import { AlertBanner } from "@/components/ui/alert-banner";

describe("AlertBanner", () => {
  describe("Rendering", () => {
    it("should render with children text", () => {
      render(<AlertBanner type="info">Test message</AlertBanner>);

      expect(screen.getByText("Test message")).toBeInTheDocument();
    });

    it("should have data-slot attribute", () => {
      render(<AlertBanner type="info">Message</AlertBanner>);

      expect(
        document.querySelector('[data-slot="alert-banner"]')
      ).toBeInTheDocument();
    });

    it("should have role=alert for accessibility", () => {
      render(<AlertBanner type="info">Message</AlertBanner>);

      expect(screen.getByRole("alert")).toBeInTheDocument();
    });

    it("should render title when provided", () => {
      render(
        <AlertBanner type="info" title="Alert Title">
          Message
        </AlertBanner>
      );

      expect(screen.getByText("Alert Title")).toBeInTheDocument();
    });
  });

  describe("Type Variants", () => {
    const types = ["success", "error", "warning", "info"] as const;

    types.forEach((type) => {
      it(`should render ${type} variant without error`, () => {
        render(<AlertBanner type={type}>{type} message</AlertBanner>);

        expect(screen.getByText(`${type} message`)).toBeInTheDocument();
      });
    });

    it("should apply success variant with green colors", () => {
      render(<AlertBanner type="success">Success</AlertBanner>);

      const alert = screen.getByRole("alert");
      expect(alert.className).toMatch(/green/);
    });

    it("should apply error variant with red colors", () => {
      render(<AlertBanner type="error">Error</AlertBanner>);

      const alert = screen.getByRole("alert");
      expect(alert.className).toMatch(/red/);
    });

    it("should apply warning variant with amber colors", () => {
      render(<AlertBanner type="warning">Warning</AlertBanner>);

      const alert = screen.getByRole("alert");
      expect(alert.className).toMatch(/amber/);
    });

    it("should apply info variant with teal colors", () => {
      render(<AlertBanner type="info">Info</AlertBanner>);

      const alert = screen.getByRole("alert");
      expect(alert.className).toMatch(/teal/);
    });
  });

  describe("Icons", () => {
    it("should render checkmark icon for success type", () => {
      render(<AlertBanner type="success">Success</AlertBanner>);

      expect(document.querySelector("svg")).toBeInTheDocument();
    });

    it("should render alert icon for error type", () => {
      render(<AlertBanner type="error">Error</AlertBanner>);

      expect(document.querySelector("svg")).toBeInTheDocument();
    });
  });

  describe("Dismissible", () => {
    it("should show dismiss button when dismissible is true", () => {
      render(
        <AlertBanner type="info" dismissible>
          Message
        </AlertBanner>
      );

      expect(
        screen.getByRole("button", { name: /dismiss/i })
      ).toBeInTheDocument();
    });

    it("should not show dismiss button by default", () => {
      render(<AlertBanner type="info">Message</AlertBanner>);

      expect(screen.queryByRole("button")).not.toBeInTheDocument();
    });

    it("should call onDismiss when dismiss button is clicked", () => {
      const handleDismiss = vi.fn();
      render(
        <AlertBanner type="info" dismissible onDismiss={handleDismiss}>
          Message
        </AlertBanner>
      );

      fireEvent.click(screen.getByRole("button", { name: /dismiss/i }));

      expect(handleDismiss).toHaveBeenCalledTimes(1);
    });
  });

  describe("Action", () => {
    it("should render action element when provided", () => {
      render(
        <AlertBanner
          type="info"
          action={<button type="button">Take Action</button>}
        >
          Message
        </AlertBanner>
      );

      expect(
        screen.getByRole("button", { name: "Take Action" })
      ).toBeInTheDocument();
    });
  });

  describe("Custom className", () => {
    it("should merge custom className with default classes", () => {
      render(
        <AlertBanner type="info" className="custom-class">
          Message
        </AlertBanner>
      );

      const alert = screen.getByRole("alert");
      expect(alert.className).toContain("custom-class");
    });
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-banner.test.tsx --run`
Expected: FAIL with "Cannot find module '@/components/ui/alert-banner'"

---

### Task 2: Web - Implement AlertBanner component

**Files:**
- Create: `klard-web/src/components/ui/alert-banner.tsx`
- Modify: `klard-web/src/components/ui/index.ts`

**Step 1: Implement the component**

```tsx
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";
import {
  CheckCircle,
  AlertCircle,
  AlertTriangle,
  Info,
  X,
} from "lucide-react";
import { cn } from "@/lib/utils";

const alertBannerVariants = cva(
  "relative w-full rounded-lg border p-4 flex items-start gap-3",
  {
    variants: {
      type: {
        success:
          "border-green-500 bg-green-50 text-green-800 dark:bg-green-900/20 dark:text-green-400",
        error:
          "border-red-500 bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-400",
        warning:
          "border-amber-500 bg-amber-50 text-amber-800 dark:bg-amber-900/20 dark:text-amber-400",
        info: "border-teal-500 bg-teal-50 text-teal-800 dark:bg-teal-900/20 dark:text-teal-400",
      },
    },
    defaultVariants: {
      type: "info",
    },
  }
);

const icons = {
  success: CheckCircle,
  error: AlertCircle,
  warning: AlertTriangle,
  info: Info,
} as const;

export interface AlertBannerProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof alertBannerVariants> {
  /** Alert type determines icon and styling */
  type: "success" | "error" | "warning" | "info";
  /** Optional title for the alert */
  title?: string;
  /** Whether the alert can be dismissed */
  dismissible?: boolean;
  /** Callback when dismiss button is clicked */
  onDismiss?: () => void;
  /** Optional action element (button, link) */
  action?: React.ReactNode;
}

function AlertBanner({
  type,
  title,
  children,
  dismissible,
  onDismiss,
  action,
  className,
  ...props
}: AlertBannerProps) {
  const Icon = icons[type];

  return (
    <div
      data-slot="alert-banner"
      role="alert"
      className={cn(alertBannerVariants({ type }), className)}
      {...props}
    >
      <Icon className="h-5 w-5 flex-shrink-0 mt-0.5" />
      <div className="flex-1 min-w-0">
        {title && (
          <div data-slot="alert-banner-title" className="font-medium mb-1">
            {title}
          </div>
        )}
        <div data-slot="alert-banner-description" className="text-sm">
          {children}
        </div>
        {action && <div className="mt-2">{action}</div>}
      </div>
      {dismissible && (
        <button
          type="button"
          onClick={onDismiss}
          className="flex-shrink-0 p-1 rounded hover:opacity-70 focus:outline-none focus:ring-2 focus:ring-offset-2"
          aria-label="Dismiss alert"
        >
          <X className="h-4 w-4" />
        </button>
      )}
    </div>
  );
}

export { AlertBanner, alertBannerVariants };
```

**Step 2: Update index.ts exports**

Add to `klard-web/src/components/ui/index.ts`:
```tsx
export { AlertBanner, alertBannerVariants, type AlertBannerProps } from './alert-banner';
```

**Step 3: Run tests to verify they pass**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-banner.test.tsx --run`
Expected: PASS

**Step 4: TypeScript check**

Run: `pnpm --filter klard-web exec tsc --noEmit`
Expected: No errors

**Step 5: Commit**

```bash
git add klard-web/src/components/ui/alert-banner.tsx klard-web/src/components/ui/index.ts klard-web/src/__tests__/components/ui/alert-banner.test.tsx
git commit -m "feat(web): add AlertBanner component with variants"
```

---

### Task 3: Mobile - Create test file with failing tests

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/AlertBanner.test.tsx`

**Step 1: Write the failing tests**

```tsx
/**
 * Tests for AlertBanner Component (Mobile)
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react-native';
import { Text } from 'react-native';
import { AlertBanner } from '@/components/ui/AlertBanner';
import * as Haptics from 'expo-haptics';

// Mock expo-haptics
jest.mock('expo-haptics', () => ({
  impactAsync: jest.fn(),
  ImpactFeedbackStyle: {
    Light: 'light',
    Medium: 'medium',
    Heavy: 'heavy',
  },
}));

// Mock vector icons
jest.mock('@expo/vector-icons', () => {
  const React = require('react');
  const { Text } = require('react-native');
  return {
    Ionicons: ({ name }: { name: string }) => (
      <Text testID="vector-icon">{name}</Text>
    ),
  };
});

describe('AlertBanner', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('Rendering', () => {
    it('should render with children text', () => {
      render(<AlertBanner type="info">Test message</AlertBanner>);

      expect(screen.getByText('Test message')).toBeTruthy();
    });

    it('should have correct accessibility role', () => {
      render(
        <AlertBanner type="info" testID="alert">
          Message
        </AlertBanner>
      );

      const alert = screen.getByTestId('alert');
      expect(alert.props.accessibilityRole).toBe('alert');
    });

    it('should render title when provided', () => {
      render(
        <AlertBanner type="info" title="Alert Title">
          Message
        </AlertBanner>
      );

      expect(screen.getByText('Alert Title')).toBeTruthy();
    });
  });

  describe('Type Variants', () => {
    const types = ['success', 'error', 'warning', 'info'] as const;

    types.forEach((type) => {
      it(`should render ${type} variant without error`, () => {
        render(<AlertBanner type={type}>{type} message</AlertBanner>);

        expect(screen.getByText(`${type} message`)).toBeTruthy();
      });
    });
  });

  describe('Icons', () => {
    it('should render icon for each type', () => {
      render(<AlertBanner type="success">Success</AlertBanner>);

      expect(screen.getByTestId('vector-icon')).toBeTruthy();
    });
  });

  describe('Dismissible', () => {
    it('should show dismiss button when dismissible is true', () => {
      render(
        <AlertBanner type="info" dismissible>
          Message
        </AlertBanner>
      );

      expect(screen.getByLabelText(/dismiss/i)).toBeTruthy();
    });

    it('should not show dismiss button by default', () => {
      render(<AlertBanner type="info">Message</AlertBanner>);

      expect(screen.queryByLabelText(/dismiss/i)).toBeNull();
    });

    it('should call onDismiss when dismiss button is pressed', async () => {
      const handleDismiss = jest.fn();
      render(
        <AlertBanner type="info" dismissible onDismiss={handleDismiss}>
          Message
        </AlertBanner>
      );

      fireEvent.press(screen.getByLabelText(/dismiss/i));

      await waitFor(() => {
        expect(handleDismiss).toHaveBeenCalledTimes(1);
      });
    });

    it('should trigger haptic feedback on dismiss', async () => {
      const handleDismiss = jest.fn();
      render(
        <AlertBanner type="info" dismissible onDismiss={handleDismiss}>
          Message
        </AlertBanner>
      );

      fireEvent.press(screen.getByLabelText(/dismiss/i));

      await waitFor(() => {
        expect(Haptics.impactAsync).toHaveBeenCalledWith(
          Haptics.ImpactFeedbackStyle.Light
        );
      });
    });
  });

  describe('Action', () => {
    it('should render action element when provided', () => {
      render(
        <AlertBanner
          type="info"
          action={<Text testID="action-button">Take Action</Text>}
        >
          Message
        </AlertBanner>
      );

      expect(screen.getByTestId('action-button')).toBeTruthy();
    });
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/AlertBanner.test.tsx --run`
Expected: FAIL with "Cannot find module '@/components/ui/AlertBanner'"

---

### Task 4: Mobile - Implement AlertBanner component

**Files:**
- Create: `klard-mobile/src/components/ui/AlertBanner.tsx`
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Implement the component**

```tsx
import React from 'react';
import {
  View,
  Text,
  Pressable,
  StyleSheet,
  useColorScheme,
  type ViewStyle,
  type StyleProp,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';
import { Colors } from '@/styles';
import { spacing, borderRadius } from '@/styles';

export type AlertBannerType = 'success' | 'error' | 'warning' | 'info';

export interface AlertBannerProps {
  /** Alert type determines icon and styling */
  type: AlertBannerType;
  /** Optional title for the alert */
  title?: string;
  /** Alert message content */
  children: React.ReactNode;
  /** Whether the alert can be dismissed */
  dismissible?: boolean;
  /** Callback when dismiss button is clicked */
  onDismiss?: () => void;
  /** Optional action element (button, link) */
  action?: React.ReactNode;
  /** Additional style overrides */
  style?: StyleProp<ViewStyle>;
  /** Test ID for testing */
  testID?: string;
}

const iconMap: Record<AlertBannerType, keyof typeof Ionicons.glyphMap> = {
  success: 'checkmark-circle',
  error: 'alert-circle',
  warning: 'warning',
  info: 'information-circle',
};

function AlertBanner({
  type,
  title,
  children,
  dismissible,
  onDismiss,
  action,
  style,
  testID,
}: AlertBannerProps) {
  const colorScheme = useColorScheme() ?? 'light';
  const colors = Colors[colorScheme];

  const typeColors = getTypeColors(type, colorScheme);

  const handleDismiss = async () => {
    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    onDismiss?.();
  };

  return (
    <View
      testID={testID}
      accessibilityRole="alert"
      style={[
        styles.container,
        {
          backgroundColor: typeColors.background,
          borderColor: typeColors.border,
        },
        style,
      ]}
    >
      <Ionicons
        name={iconMap[type]}
        size={20}
        color={typeColors.icon}
        style={styles.icon}
      />
      <View style={styles.content}>
        {title && (
          <Text style={[styles.title, { color: typeColors.text }]}>{title}</Text>
        )}
        <Text style={[styles.description, { color: typeColors.text }]}>
          {children}
        </Text>
        {action && <View style={styles.action}>{action}</View>}
      </View>
      {dismissible && (
        <Pressable
          onPress={handleDismiss}
          style={styles.dismissButton}
          accessibilityLabel="Dismiss alert"
          accessibilityRole="button"
        >
          <Ionicons name="close" size={20} color={typeColors.icon} />
        </Pressable>
      )}
    </View>
  );
}

function getTypeColors(
  type: AlertBannerType,
  colorScheme: 'light' | 'dark'
): { background: string; border: string; text: string; icon: string } {
  const isLight = colorScheme === 'light';

  const colorMap: Record<
    AlertBannerType,
    { light: typeof lightSuccess; dark: typeof darkSuccess }
  > = {
    success: { light: lightSuccess, dark: darkSuccess },
    error: { light: lightError, dark: darkError },
    warning: { light: lightWarning, dark: darkWarning },
    info: { light: lightInfo, dark: darkInfo },
  };

  return isLight ? colorMap[type].light : colorMap[type].dark;
}

// Light theme colors
const lightSuccess = {
  background: '#F0FDF4',
  border: '#22C55E',
  text: '#166534',
  icon: '#22C55E',
};

const lightError = {
  background: '#FEF2F2',
  border: '#EF4444',
  text: '#991B1B',
  icon: '#EF4444',
};

const lightWarning = {
  background: '#FFFBEB',
  border: '#F59E0B',
  text: '#92400E',
  icon: '#F59E0B',
};

const lightInfo = {
  background: '#F0FDFA',
  border: '#14B8A6',
  text: '#134E4A',
  icon: '#14B8A6',
};

// Dark theme colors
const darkSuccess = {
  background: 'rgba(34, 197, 94, 0.15)',
  border: '#22C55E',
  text: '#4ADE80',
  icon: '#4ADE80',
};

const darkError = {
  background: 'rgba(239, 68, 68, 0.15)',
  border: '#EF4444',
  text: '#F87171',
  icon: '#F87171',
};

const darkWarning = {
  background: 'rgba(245, 158, 11, 0.15)',
  border: '#F59E0B',
  text: '#FBBF24',
  icon: '#FBBF24',
};

const darkInfo = {
  background: 'rgba(20, 184, 166, 0.15)',
  border: '#14B8A6',
  text: '#2DD4BF',
  icon: '#2DD4BF',
};

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    padding: spacing.md,
    borderRadius: borderRadius.lg,
    borderWidth: 1,
  },
  icon: {
    marginRight: spacing.sm,
    marginTop: 2,
  },
  content: {
    flex: 1,
  },
  title: {
    fontSize: 14,
    fontWeight: '600',
    marginBottom: spacing.xs,
  },
  description: {
    fontSize: 14,
    lineHeight: 20,
  },
  action: {
    marginTop: spacing.sm,
  },
  dismissButton: {
    padding: spacing.xs,
    marginLeft: spacing.sm,
  },
});

export { AlertBanner };
```

**Step 2: Update index.ts exports**

Add to `klard-mobile/src/components/ui/index.ts`:
```tsx
export { AlertBanner, type AlertBannerProps, type AlertBannerType } from './AlertBanner';
```

**Step 3: Run tests to verify they pass**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/AlertBanner.test.tsx --run`
Expected: PASS

**Step 4: TypeScript check**

Run: `pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 5: Commit**

```bash
git add klard-mobile/src/components/ui/AlertBanner.tsx klard-mobile/src/components/ui/index.ts klard-mobile/src/__tests__/components/ui/AlertBanner.test.tsx
git commit -m "feat(mobile): add AlertBanner component with variants"
```

---

### Task 5: Update spec marker to DONE

**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md`

**Step 1: Update the marker**

Replace:
```
<!-- IN-PROGRESS:4.2-alert-banner -->
```

With:
```
<!-- DONE:4.2-alert-banner -->
```

**Step 2: Commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 4.2-alert-banner spec as done"
```

---

## Verification Checklist

Before marking complete, verify:

- [ ] Component renders without errors (web)
- [ ] Component renders without errors (mobile)
- [ ] All props implemented + typed
- [ ] All type variants functional (success, error, warning, info)
- [ ] Matches design specification visually
- [ ] Accessibility attributes included (role="alert", aria-label)
- [ ] TypeScript passes: `pnpm --filter klard-web exec tsc --noEmit`
- [ ] TypeScript passes: `pnpm --filter klard-mobile exec tsc --noEmit`
- [ ] All web tests passing
- [ ] All mobile tests passing
- [ ] Exported from components/ui/index.ts (both)
- [ ] Spec marker updated to DONE
