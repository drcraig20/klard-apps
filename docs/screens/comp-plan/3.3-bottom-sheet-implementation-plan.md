# 3.3 BottomSheet Component Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a production-ready BottomSheet component for klard-mobile using @gorhom/bottom-sheet with Klard design system styling, full accessibility support, and haptic feedback.

**Architecture:** Mobile-only component wrapping @gorhom/bottom-sheet v5 with Klard-specific styling (handle indicator, backdrop colors, safe area padding). Controlled component (open/onClose props) with configurable snap points and drag behavior.

**Tech Stack:**
- Mobile: Expo SDK 54, TypeScript strict, @gorhom/bottom-sheet v5, react-native-reanimated v3, react-native-gesture-handler, expo-haptics, react-native-safe-area-context

---

## Pre-Implementation Checklist

Before starting, verify these skills are loaded:
- [ ] `superpowers:test-driven-development` - TDD workflow
- [ ] `superpowers:testing-anti-patterns` - Avoid common test mistakes
- [ ] `solid-design-principles` - SOLID compliance

---

## Component Specification

### Props Interface

```typescript
interface BottomSheetProps {
  /** Whether the bottom sheet is open */
  open: boolean;
  /** Callback when the bottom sheet is closed */
  onClose: () => void;
  /** Snap points for the bottom sheet (e.g., ['25%', '50%', '90%']) */
  snapPoints?: string[];
  /** Children to render inside the bottom sheet */
  children: React.ReactNode;
  /** Whether dragging to close is enabled */
  enableDrag?: boolean;
}
```

### Visual Elements

- **Handle Indicator**: Pill-shaped drag handle at top
- **Backdrop**: Semi-transparent overlay that dismisses on tap
- **Content Container**: Padded area with safe area insets
- **Background**: Card-style background with rounded top corners

### Klard Design System Colors

| Element | Light Mode | Dark Mode |
|---------|------------|-----------|
| Handle Indicator | rgba(148, 163, 184, 0.2) (border) | rgba(148, 163, 184, 0.12) |
| Backdrop | rgba(15, 23, 42, 0.5) | rgba(15, 23, 42, 0.5) |
| Background | #FFFFFF (card) | #1E293B (card) |
| Content | #0F172A (foreground) | #F8FAFC (foreground) |

---

## SOLID Compliance

| Principle | Implementation |
|-----------|----------------|
| **SRP** | BottomSheet only handles sheet display - content delegated to children |
| **OCP** | Extended via children prop, no modification needed |
| **LSP** | All prop combinations produce valid sheets |
| **ISP** | Minimal interface with only necessary props |
| **DIP** | Component depends on BottomSheet ref interface abstraction |

---

## Dependencies

### Mobile (Must Install)
- `@gorhom/bottom-sheet` v5 - Bottom sheet primitives
- `react-native-reanimated` - Animation library (peer dependency)

### Mobile (Already Present)
- `react-native-gesture-handler` - Gesture handling
- `react-native-safe-area-context` - Safe area insets
- `expo-haptics` - Haptic feedback

---

# PART 1: MOBILE IMPLEMENTATION (Mobile Only Component)

## Task 1: Install Mobile Dependencies

**Step 1: Install @gorhom/bottom-sheet and react-native-reanimated**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps
pnpm --filter klard-mobile add @gorhom/bottom-sheet react-native-reanimated
```

**Step 2: Verify both packages installed**

```bash
grep -E "bottom-sheet|reanimated" /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-mobile/package.json
```

Expected: Both packages in dependencies

**Step 3: Check babel.config.js for reanimated plugin**

Ensure `react-native-reanimated/plugin` is in the plugins array (must be last):

```js
module.exports = function (api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [
      // ... other plugins
      'react-native-reanimated/plugin', // MUST BE LAST
    ],
  };
};
```

**Step 4: Commit dependency changes**

```bash
git add klard-mobile/package.json pnpm-lock.yaml klard-mobile/babel.config.js
git commit -m "chore(mobile): add @gorhom/bottom-sheet and react-native-reanimated"
```

---

## Task 2: Write Failing Tests for BottomSheet Rendering

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/BottomSheet.test.tsx`

**Step 1: Create test file with rendering tests**

```tsx
/**
 * Tests for BottomSheet Component (Mobile)
 *
 * TDD: Write failing tests first, then implement to pass.
 * Tests verify: rendering, open/close behavior, snap points, backdrop, accessibility
 */

import React from 'react';
import { render, screen } from '@testing-library/react-native';
import { Text } from 'react-native';
import { BottomSheet } from '@/components/ui/BottomSheet';

// Mock @gorhom/bottom-sheet
jest.mock('@gorhom/bottom-sheet', () => {
  const React = require('react');
  const { View } = require('react-native');

  const MockBottomSheet = React.forwardRef(
    (
      {
        children,
        index,
        snapPoints,
        onChange,
        onClose,
        backdropComponent,
        enablePanDownToClose,
        handleIndicatorStyle,
        backgroundStyle,
      }: any,
      ref: any
    ) => {
      const [currentIndex, setCurrentIndex] = React.useState(index);

      React.useImperativeHandle(ref, () => ({
        expand: () => {
          setCurrentIndex(0);
          onChange?.(0);
        },
        close: () => {
          setCurrentIndex(-1);
          onChange?.(-1);
          onClose?.();
        },
        snapToIndex: (i: number) => {
          setCurrentIndex(i);
          onChange?.(i);
        },
      }));

      if (currentIndex === -1) {
        return null;
      }

      const Backdrop = backdropComponent;

      return (
        <View testID="bottom-sheet-container">
          {Backdrop && (
            <Backdrop
              animatedIndex={{ value: currentIndex }}
              style={{}}
            />
          )}
          <View testID="bottom-sheet-content">{children}</View>
        </View>
      );
    }
  );

  const BottomSheetView = ({ children, style }: any) => (
    <View testID="bottom-sheet-view" style={style}>
      {children}
    </View>
  );

  const BottomSheetBackdrop = ({ onPress, testID, ...props }: any) => (
    <View testID={testID || 'bottom-sheet-backdrop'} onTouchEnd={onPress} {...props} />
  );

  return {
    __esModule: true,
    default: MockBottomSheet,
    BottomSheetView,
    BottomSheetBackdrop,
  };
});

// Mock react-native-safe-area-context
jest.mock('react-native-safe-area-context', () => ({
  useSafeAreaInsets: () => ({ top: 0, bottom: 34, left: 0, right: 0 }),
}));

// Mock expo-haptics
jest.mock('expo-haptics', () => ({
  impactAsync: jest.fn(),
  ImpactFeedbackStyle: {
    Light: 'light',
    Medium: 'medium',
  },
}));

describe('BottomSheet', () => {
  const mockOnClose = jest.fn();

  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('Rendering', () => {
    it('should render children when open', () => {
      render(
        <BottomSheet open={true} onClose={mockOnClose}>
          <Text>Sheet Content</Text>
        </BottomSheet>
      );

      expect(screen.getByText('Sheet Content')).toBeTruthy();
    });

    it('should not render content when closed', () => {
      render(
        <BottomSheet open={false} onClose={mockOnClose}>
          <Text>Sheet Content</Text>
        </BottomSheet>
      );

      expect(screen.queryByText('Sheet Content')).toBeNull();
    });

    it('should render container with testID when open', () => {
      render(
        <BottomSheet open={true} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-container')).toBeTruthy();
    });
  });
});
```

**Step 2: Run tests to verify they fail**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps
pnpm --filter klard-mobile test src/__tests__/components/ui/BottomSheet.test.tsx --run
```

Expected: FAIL - BottomSheet component doesn't exist

---

## Task 3: Write Failing Tests for Open/Close Behavior

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/BottomSheet.test.tsx`

**Step 1: Add open/close behavior tests**

```tsx
  describe('Open/Close Behavior', () => {
    it('should call onClose when sheet is closed', () => {
      render(
        <BottomSheet open={true} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-container')).toBeTruthy();
    });

    it('should expand when open prop changes to true', () => {
      const { rerender } = render(
        <BottomSheet open={false} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.queryByTestId('bottom-sheet-container')).toBeNull();

      rerender(
        <BottomSheet open={true} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-container')).toBeTruthy();
    });

    it('should close when open prop changes to false', () => {
      const { rerender } = render(
        <BottomSheet open={true} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-container')).toBeTruthy();

      rerender(
        <BottomSheet open={false} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.queryByTestId('bottom-sheet-container')).toBeNull();
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/BottomSheet.test.tsx --run
```

Expected: FAIL - Component not implemented

---

## Task 4: Write Failing Tests for Snap Points and Drag

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/BottomSheet.test.tsx`

**Step 1: Add snap points and drag behavior tests**

```tsx
  describe('Snap Points', () => {
    it('should accept custom snap points', () => {
      const customSnapPoints = ['25%', '50%', '90%'];
      render(
        <BottomSheet
          open={true}
          onClose={mockOnClose}
          snapPoints={customSnapPoints}
        >
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-container')).toBeTruthy();
    });

    it('should use default snap points when not provided', () => {
      render(
        <BottomSheet open={true} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-container')).toBeTruthy();
    });
  });

  describe('Drag Behavior', () => {
    it('should allow disabling drag to close', () => {
      render(
        <BottomSheet open={true} onClose={mockOnClose} enableDrag={false}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-container')).toBeTruthy();
    });

    it('should enable drag to close by default', () => {
      render(
        <BottomSheet open={true} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-container')).toBeTruthy();
    });
  });
```

**Step 2: Run all tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/BottomSheet.test.tsx --run
```

Expected: Multiple FAIL

---

## Task 5: Write Failing Tests for Backdrop

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/BottomSheet.test.tsx`

**Step 1: Add backdrop tests**

```tsx
  describe('Backdrop', () => {
    it('should render backdrop when open', () => {
      render(
        <BottomSheet open={true} onClose={mockOnClose}>
          <Text>Content</Text>
        </BottomSheet>
      );

      expect(screen.getByTestId('bottom-sheet-backdrop')).toBeTruthy();
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/BottomSheet.test.tsx --run
```

Expected: FAIL - Backdrop not rendered

---

## Task 6: Write Failing Tests for Haptic Feedback

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/BottomSheet.test.tsx`

**Step 1: Add haptic feedback test**

```tsx
import * as Haptics from 'expo-haptics';

  describe('Haptic Feedback', () => {
    it('should have haptic feedback capability', () => {
      // Haptic feedback is triggered in handleSheetChanges when index is -1
      expect(Haptics.impactAsync).toBeDefined();
    });
  });
```

**Step 2: Run all tests**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/BottomSheet.test.tsx --run
```

Expected: Multiple FAIL

---

## Task 7: Create BottomSheet Styles File

**Files:**
- Create: `klard-mobile/src/components/ui/BottomSheet/bottom-sheet.styles.ts`

**Step 1: Create styles file**

```typescript
// klard-mobile/src/components/ui/BottomSheet/bottom-sheet.styles.ts
import { StyleSheet } from 'react-native';
import { Colors } from '@/styles/colors';

export const styles = StyleSheet.create({
  contentContainer: {
    flex: 1,
    paddingHorizontal: 16,
  },
  handleIndicator: {
    backgroundColor: Colors.light.border,
    width: 40,
    height: 4,
    borderRadius: 2,
  },
  background: {
    backgroundColor: Colors.light.card,
    borderTopLeftRadius: 24,
    borderTopRightRadius: 24,
  },
});

export const backdropColor = 'rgba(15, 23, 42, 0.5)'; // slate-900 with 50% opacity
```

---

## Task 8: Implement BottomSheet Component

**Files:**
- Create: `klard-mobile/src/components/ui/BottomSheet/BottomSheet.tsx`
- Create: `klard-mobile/src/components/ui/BottomSheet/index.ts`

**Step 1: Create the BottomSheet component**

```tsx
// klard-mobile/src/components/ui/BottomSheet/BottomSheet.tsx
import React, { useRef, useEffect, useCallback } from 'react';
import BottomSheetLib, {
  BottomSheetView,
  BottomSheetBackdrop,
  BottomSheetBackdropProps,
} from '@gorhom/bottom-sheet';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import * as Haptics from 'expo-haptics';
import { styles, backdropColor } from './bottom-sheet.styles';

export interface BottomSheetProps {
  /** Whether the bottom sheet is open */
  open: boolean;
  /** Callback when the bottom sheet is closed */
  onClose: () => void;
  /** Snap points for the bottom sheet (e.g., ['25%', '50%', '90%']) */
  snapPoints?: string[];
  /** Children to render inside the bottom sheet */
  children: React.ReactNode;
  /** Whether dragging to close is enabled */
  enableDrag?: boolean;
}

export function BottomSheet({
  open,
  onClose,
  snapPoints = ['50%'],
  children,
  enableDrag = true,
}: BottomSheetProps) {
  const bottomSheetRef = useRef<BottomSheetLib>(null);
  const insets = useSafeAreaInsets();

  useEffect(() => {
    if (open) {
      bottomSheetRef.current?.expand();
    } else {
      bottomSheetRef.current?.close();
    }
  }, [open]);

  const handleSheetChanges = useCallback(
    (index: number) => {
      if (index === -1) {
        Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
        onClose();
      }
    },
    [onClose]
  );

  const renderBackdrop = useCallback(
    (props: BottomSheetBackdropProps) => (
      <BottomSheetBackdrop
        {...props}
        testID="bottom-sheet-backdrop"
        disappearsOnIndex={-1}
        appearsOnIndex={0}
        opacity={0.5}
        pressBehavior="close"
        style={[props.style, { backgroundColor: backdropColor }]}
      />
    ),
    []
  );

  return (
    <BottomSheetLib
      ref={bottomSheetRef}
      index={-1}
      snapPoints={snapPoints}
      enablePanDownToClose={enableDrag}
      onChange={handleSheetChanges}
      enableDynamicSizing={false}
      backdropComponent={renderBackdrop}
      handleIndicatorStyle={styles.handleIndicator}
      backgroundStyle={styles.background}
    >
      <BottomSheetView
        style={[styles.contentContainer, { paddingBottom: insets.bottom + 16 }]}
      >
        {children}
      </BottomSheetView>
    </BottomSheetLib>
  );
}
```

**Step 2: Create index file**

```typescript
// klard-mobile/src/components/ui/BottomSheet/index.ts
export { BottomSheet, type BottomSheetProps } from './BottomSheet';
```

**Step 3: Run tests to verify they pass**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/BottomSheet.test.tsx --run
```

Expected: All tests PASS

---

## Task 9: Export BottomSheet from Index

**Files:**
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Add BottomSheet export**

Add this line to the exports:

```typescript
export { BottomSheet, type BottomSheetProps } from './BottomSheet';
```

**Step 2: Verify TypeScript compiles**

```bash
pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No TypeScript errors

**Step 3: Commit implementation**

```bash
git add klard-mobile/src/components/ui/BottomSheet/ klard-mobile/src/components/ui/index.ts klard-mobile/src/__tests__/components/ui/BottomSheet.test.tsx
git commit -m "feat(mobile): add BottomSheet component with TDD

- Add BottomSheet component using @gorhom/bottom-sheet
- Support configurable snap points and drag behavior
- Klard design system styling for handle, backdrop, background
- Haptic feedback on close
- Safe area insets for content
- Comprehensive test coverage"
```

---

# PART 2: VERIFICATION & COMPLETION

## Task 10: Run Full Test Suite

**Step 1: Run all mobile tests**

```bash
pnpm --filter klard-mobile test --run
```

Expected: All tests PASS

**Step 2: Run TypeScript check**

```bash
pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No TypeScript errors

---

## Task 11: Verification Checklist

Complete this checklist before marking component as DONE:

**Mobile BottomSheet:**
- [ ] Component renders without errors
- [ ] Opens when open={true}
- [ ] Closes when open={false}
- [ ] Supports custom snap points
- [ ] Default snap points work (50%)
- [ ] enableDrag={false} disables swipe to close
- [ ] Backdrop renders when open
- [ ] Backdrop tap closes sheet
- [ ] Haptic feedback on close
- [ ] Safe area insets applied to content
- [ ] Handle indicator styled with Klard colors
- [ ] Background styled with rounded corners
- [ ] TypeScript compiles with no errors
- [ ] All tests passing
- [ ] Exported from index.ts

---

## Task 12: Mark Component as DONE

**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md`

**Step 1: Update spec marker**

Replace:
```
<!-- IN-PROGRESS:3.3-bottom-sheet -->
```

With:
```
<!-- DONE:3.3-bottom-sheet -->
```

**Step 2: Final commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 3.3-bottom-sheet component as DONE"
```

---

## Summary

| Task | Description |
|------|-------------|
| 1 | Install @gorhom/bottom-sheet and react-native-reanimated |
| 2-6 | Write failing tests (TDD RED phase) |
| 7 | Create styles file |
| 8 | Implement BottomSheet component (TDD GREEN phase) |
| 9 | Export from index.ts |
| 10 | Run full test suite |
| 11 | Verification checklist |
| 12 | Mark component as DONE |

**Total Tasks:** 12
**Estimated Time:** 25-35 minutes

---

## File Structure

### Mobile
```
klard-mobile/src/
├── components/ui/
│   ├── BottomSheet/
│   │   ├── BottomSheet.tsx          # Component
│   │   ├── bottom-sheet.styles.ts   # Styles
│   │   └── index.ts                 # Barrel export
│   └── index.ts                     # Export added
└── __tests__/components/ui/
    └── BottomSheet.test.tsx         # Test file
```

---

## Implementation Notes

### @gorhom/bottom-sheet Configuration

Key props used:
- `index={-1}` - Start closed
- `enablePanDownToClose` - Allows swipe down to close
- `enableDynamicSizing={false}` - Use explicit snap points
- `backdropComponent` - Custom backdrop with Klard styling
- `handleIndicatorStyle` - Custom handle pill
- `backgroundStyle` - Rounded top corners

### Safe Area Handling

Content automatically gets `paddingBottom: insets.bottom + 16` to account for:
- Home indicator on newer iPhones
- Navigation bar on Android
- Additional 16px spacing for visual comfort

### Haptic Feedback

Triggered via `expo-haptics` with `ImpactFeedbackStyle.Light` when:
- Sheet is dismissed (index becomes -1)

---

## Execution Options

**Plan complete and saved to `docs/screens/comp-plan/3.3-bottom-sheet-implementation-plan.md`.**

**Two execution options:**

1. **Subagent-Driven (this session)** - Dispatch fresh subagent per task, review between tasks, fast iteration

2. **Parallel Session (separate)** - Open new session with executing-plans, batch execution with checkpoints

**Which approach?**