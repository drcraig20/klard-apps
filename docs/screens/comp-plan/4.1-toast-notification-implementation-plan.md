# 4.1 Toast / Notification Implementation Plan (MERGED)

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a robust, cross-platform toast notification system for web and mobile that delivers brief, non-blocking feedback with type-based styling (success/error/warning/info), optional description, optional action button, configurable duration, accessibility-friendly announcements, haptic feedback on mobile, and consistent Klard design tokens.

**Architecture:**
- **Web:** Wrap shadcn/ui Sonner (`toast`, `Toaster`) with a typed helper and a `ToastProvider` component to render the Toaster with Klard theming, default duration, and rich colors. Provide a reusable `showToast` function and optional React hook for future extensibility. Ensure app root includes the provider. Use type-safe mapping from `ToastType` to Sonner APIs and iconography.
- **Mobile:** Provide an in-app toast component using `react-native-toast-message` (lightweight, no system permissions) as primary. Implement a `toastConfig` for type-based styling, a `ToastProvider` wrapper to register the component at root, and a `showToast` helper to standardize payloads. Include haptic feedback via `expo-haptics` for success/error/warning types. Handle action button support via Toast's custom render. Keep logic presentation-only; consumers trigger via helper.
- **Shared:** Keep type definitions aligned between platforms. Expose minimal public API: `showToast(options)`, `ToastProvider`, `ToastViewport/Toaster` components.

**Tech Stack:**
- **Web:** Next.js 16, React 19, shadcn/ui Sonner, Tailwind CSS 4 (Klard tokens), lucide-react icons, TypeScript strict mode
- **Mobile:** React Native + Expo 54, `react-native-toast-message` (new dependency), `expo-haptics` (already installed), `react-native-safe-area-context` (for padding), `@expo/vector-icons/Ionicons`, TypeScript strict mode
- **Testing:** Vitest + Testing Library (web), jest-expo + React Native Testing Library (mobile)

---

## Component & API Outline

### Types (Shared)
```typescript
type ToastType = 'success' | 'error' | 'warning' | 'info';

interface ToastAction {
  label: string;
  onClick: () => void; // web: onClick, mobile: maps to onPress
}

interface ToastProps {
  type: ToastType;
  title: string;
  description?: string;
  duration?: number; // default 4000 web, 3000 mobile
  action?: ToastAction;
}
```

### Web Exports
- `ToastProvider` (renders `<Toaster />` with Klard styling)
- `showToast(options: ToastProps)` helper function
- Type exports: `ToastType`, `ToastProps`, `ToastAction`

### Mobile Exports
- `ToastProvider` wrapper component with `toastConfig`
- `showToast(options: ToastProps)` helper with haptic feedback
- `hideToast()` utility function
- `toastConfig` - custom Klard-themed toast layouts
- Type exports: `ToastType`, `ToastProps`, `ToastAction`

### States & Variants
- **Types:** success (green), error (red), warning (amber), info (teal)
- **Duration:** default 4000ms web, 3000ms mobile; override allowed
- **Action:** optional button rendered inline (web: Sonner action; mobile: custom Pressable)
- **Haptics (mobile only):** success/error/warning trigger appropriate haptic feedback

---

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| ToastProps | Single interface for toast config | N/A | N/A | Minimal props needed | Abstract type definition |
| showToast (web) | Display toast only | Types configurable via enum | N/A | Single function API | Depends on ToastProps + Sonner abstractions |
| showToast (mobile) | Display toast + haptics | Types configurable via enum | N/A | Single function API | Depends on ToastProps + library abstractions |
| ToastProvider (web) | Render toast container | Position via props | N/A | Single component | Depends on Sonner abstraction |
| ToastProvider (mobile) | Register toast host with config | Config via props | N/A | Single component | Depends on library abstraction |
| toastConfig (mobile) | Map types to styled views | New types via config extension | N/A | Type-to-component mapping | Depends on color/icon abstractions |

### Principle Applications

**SRP:** Each component has one responsibility - Toaster renders container, showToast displays messages, config maps types to views
**OCP:** Toast types (success/error/warning/info) configurable without modifying base code; new types can be added via config extension
**LSP:** N/A - no inheritance hierarchy
**ISP:** ToastProps interface contains only what consumers need; no forced dependencies
**DIP:** Components depend on ToastProps abstraction, not concrete implementations; Sonner/react-native-toast-message are swappable

---

## Type-to-Color/Icon Mapping

### Web Mapping
| Type | Icon (lucide-react) | Background | Text Color |
|------|---------------------|------------|------------|
| success | `CheckCircle2` | `bg-emerald-600` (#10B981) | `text-white` |
| error | `XCircle` | `bg-red-600` (#EF4444) | `text-white` |
| warning | `AlertTriangle` | `bg-amber-500` (#F59E0B) | `text-slate-900` (#0F172A) |
| info | `Info` | `bg-primary` (#0D7C7A light / #15B5B0 dark) | `text-primary-foreground` |

### Mobile Mapping
| Type | Icon (Ionicons) | Background | Text Color |
|------|-----------------|------------|------------|
| success | `checkmark-circle` | #10B981 (emerald) | #FFFFFF |
| error | `close-circle` | #EF4444 (red) | #FFFFFF |
| warning | `alert-circle` | #F59E0B (amber) | #0F172A |
| info | `information-circle` | #0D7C7A (teal) | #FFFFFF |

---

## Accessibility Requirements

### Web Accessibility
- **ARIA Live Region:** Sonner uses `role="status"` with `aria-live="polite"` by default
- **Rich Colors:** Enable Sonner's `richColors` prop for type-based backgrounds
- **Action Button:** Ensure action button has accessible label via Sonner's action API
- **Keyboard Navigation:** Sonner handles focus management; ensure close button is keyboard accessible
- **Screen Readers:** Title announced first, then description
- **Motion:** Respect `prefers-reduced-motion`; Sonner handles animation appropriately

### Mobile Accessibility
- **VoiceOver/TalkBack:** Combine title + description + action label into `accessibilityLabel`
- **Text Contrast:** Ensure WCAG AA compliance (4.5:1 minimum) for all type backgrounds
- **Touch Targets:** Action button minimum 44x44pt hit area
- **Haptic Feedback:** Provide tactile feedback for success/error/warning (not info)
- **No Vibration:** Avoid intrusive vibrations; use subtle notification haptics only
- **Font Scaling:** Support dynamic type with `allowFontScaling` enabled

### Accessibility Label Composition (Mobile)
Examples:
- Success: "Success: Profile saved. Undo button available."
- Error: "Error: Payment failed. Retry button available."
- Warning: "Warning: Connection unstable."
- Info: "Info: We're syncing your data."

---

## Design Tokens & Styling

### Web Styling Specifications
- **Container:** `rounded-xl` (12px), `shadow-lg`, max-width 420px
- **Padding:** `py-3 px-4` (12-16px)
- **Gap:** `gap-2` (8px) between icon and text
- **Typography:**
  - Title: `text-sm font-medium` (14px, 500 weight)
  - Description: `text-xs text-muted-foreground` (12px, muted)
- **Action Button:** `bg-white/90 text-inherit hover:bg-white` with underline
- **Border Radius:** 12px
- **Position:** `bottom-right` (default)

### Mobile Styling Specifications
- **Container:** flexDirection row, padding 12-16, radius 12, shadow/elevation 4, min height 60
- **Border:** Left border 4px width with type color
- **Icon:** Ionicons size 20-24, marginRight 12
- **Typography:**
  - Title: fontSize 15, fontWeight 600, color from type palette
  - Description: fontSize 13, opacity 0.9, color from type palette
- **Action Button:** Pressable with paddingHorizontal 12, paddingVertical 6, radius 6, white text
- **Safe Area:** bottomOffset = `insets.bottom + 12`
- **Max Width:** 90% screen width

---

## Detailed Requirements

### Web Requirements
1. **Toaster Component:**
   - Position: `bottom-right` (fixed for consistency)
   - Rich colors: enabled via `richColors` prop
   - Duration: default 4000ms (override allowed per toast)
   - Close button: included by default via Sonner
   - Client-side only: mark component with `'use client'`

2. **showToast Function:**
   - Accepts `ToastProps` interface
   - Maps `type` to appropriate Sonner method (`toast.success`, `toast.error`, etc.)
   - Passes `description`, `duration`, `action` to Sonner options
   - Validates `title` is present (warn in dev if missing)
   - Handles invalid type by falling back to `info`

3. **Styling:**
   - Use Sonner's default styles with Klard color overrides
   - Apply Tailwind classes for typography consistency
   - Optional glassmorphism effect for info/success types

4. **SSR Compatibility:**
   - Mark ToastProvider as `'use client'`
   - Ensure no server-side rendering issues

### Mobile Requirements
1. **Library Choice:**
   - Use `react-native-toast-message` (no system permissions needed)
   - Lightweight, in-app only (no notification tray)

2. **Toast Config:**
   - Provide `toastConfig` mapping each type to custom styled component
   - Support action button via Pressable on right side
   - Default duration: 3000ms
   - Position: bottom
   - Safe area: add `bottomOffset` from `useSafeAreaInsets`

3. **showToast Function:**
   - Wrap `Toast.show` with type-safe options
   - Map `description` to `text2` property
   - Trigger haptic feedback based on type:
     - success → `Haptics.NotificationFeedbackType.Success`
     - error → `Haptics.NotificationFeedbackType.Error`
     - warning → `Haptics.NotificationFeedbackType.Warning`
     - info → no haptic feedback
   - Pass action via `props.action` to config

4. **Styling:**
   - Container: flex row, radius 12, shadow, background tinted per type
   - Text color: high contrast with background
   - Action button: styled with type color, white text

5. **Performance:**
   - No stateful hooks in config components (keep pure)
   - Minimize re-renders via memo if needed

---

## Error Handling & Edge Cases

### Validation
1. **Missing Title:**
   - Log warning in development: `console.warn('[Toast] title is required')`
   - Skip showing toast (return early)

2. **Invalid Type:**
   - Default to `info` type
   - Log warning in development

3. **Provider Not Mounted:**
   - Web: Sonner requires Toaster; calls work but no UI shown; add dev warning
   - Mobile: Toast library warns; optional dev guard

4. **Action Without Label:**
   - Treat as no action (skip rendering button)

5. **Duration Edge Cases:**
   - Zero duration: treat as default (avoid instant dismiss)
   - Negative duration: treat as default
   - Very long duration: allow (user responsibility)

6. **Empty Description:**
   - Don't render description element if empty string
   - Ensure layout doesn't break

---

## Test Strategy (TDD)

All components follow **RED-GREEN-REFACTOR** cycle:
1. Write failing test first (RED)
2. Run test to verify it fails for expected reason
3. Implement minimal code to pass (GREEN)
4. Refactor while keeping tests green
5. Commit after each GREEN phase

### Web Test Cases
- **W1:** Render ToastProvider → Toaster exists in DOM
- **W2:** Call showToast with type=success → toast.success called with title
- **W3:** Description included → appears in toast options
- **W4:** Action provided → button rendered; click triggers handler
- **W5:** Default duration not explicitly set (let Sonner handle)
- **W6:** Invalid type → falls back to info
- **W7:** Missing title → no toast, warning logged
- **W8:** Multiple toasts → stack displays both
- **W9:** Custom duration applied
- **W10:** Toaster has position bottom-right and richColors enabled

### Mobile Test Cases
- **M1:** Render ToastProvider → Toast component rendered
- **M2:** Call showToast success → Toast.show called with type=success
- **M3:** Description appears as text2
- **M4:** Action present → passed via props; button rendered
- **M5:** Default duration set to 3000 (visibilityTime)
- **M6:** Invalid type → fallback to info
- **M7:** Missing title → no toast, warn
- **M8:** Safe area padding applied (bottomOffset)
- **M9:** Type style mapping → correct backgroundColor
- **M10:** Haptic feedback triggered for success/error/warning

---

## Parallel Sub-Agent Strategy

The following tasks can be parallelized:
- **Group A (Independent):** Task 1 (Web types) + Task 5 (Mobile types)
- **Group B (After A):** Task 2 (Web tests) + Task 6 (Mobile tests)
- **Group C (After B):** Task 3 (Web impl) + Task 7 (Mobile impl)
- **Group D (After C):** Task 4 (Web Toaster) + Task 8 (Mobile config)
- **Sequential:** Task 9 (exports), Task 10 (verification)

---

## Tasks

### Task 1: Define Shared Toast Types (Web)

**Files:**
- Create: `klard-web/src/components/ui/toast.tsx`

**Step 1 (RED): Create type definitions (no implementation)**

```typescript
// klard-web/src/components/ui/toast.tsx
export type ToastType = "success" | "error" | "warning" | "info";

export interface ToastAction {
  label: string;
  onClick: () => void;
}

export interface ToastProps {
  type: ToastType;
  title: string;
  description?: string;
  duration?: number;
  action?: ToastAction;
}

// Implementation will be added in Task 3
```

**Step 2 (RED): Verify file created**

Run: `ls klard-web/src/components/ui/toast.tsx`
Expected: File exists

**Step 3: Commit**

```bash
git add klard-web/src/components/ui/toast.tsx
git commit -m "feat(web): add toast type definitions"
```

---

### Task 2: Write Web Toast Tests (RED Phase)

**Files:**
- Create: `klard-web/src/__tests__/components/ui/toast.test.tsx`

**Step 1 (RED): Write the failing tests**

```typescript
// klard-web/src/__tests__/components/ui/toast.test.tsx
/**
 * Tests for Toast Component (Web)
 *
 * TDD: Write failing tests first, then implement to pass.
 * Tests verify: showToast function, toast types, descriptions, actions
 */

import { describe, it, expect, vi, beforeEach } from "vitest";
import { render, screen, fireEvent, waitFor } from "@testing-library/react";
import { Toaster } from "@/components/ui/sonner";
import { showToast } from "@/components/ui/toast";

// Mock sonner
vi.mock("sonner", () => ({
  toast: {
    success: vi.fn(),
    error: vi.fn(),
    warning: vi.fn(),
    info: vi.fn(),
  },
  Toaster: ({ children }: { children?: React.ReactNode }) => (
    <div data-testid="toaster">{children}</div>
  ),
}));

describe("Toast", () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe("showToast function", () => {
    it("should call toast.success for success type", async () => {
      const { toast } = await import("sonner");

      showToast({
        type: "success",
        title: "Success!",
      });

      expect(toast.success).toHaveBeenCalledWith("Success!", expect.any(Object));
    });

    it("should call toast.error for error type", async () => {
      const { toast } = await import("sonner");

      showToast({
        type: "error",
        title: "Error occurred",
      });

      expect(toast.error).toHaveBeenCalledWith("Error occurred", expect.any(Object));
    });

    it("should call toast.warning for warning type", async () => {
      const { toast } = await import("sonner");

      showToast({
        type: "warning",
        title: "Warning",
      });

      expect(toast.warning).toHaveBeenCalledWith("Warning", expect.any(Object));
    });

    it("should call toast.info for info type", async () => {
      const { toast } = await import("sonner");

      showToast({
        type: "info",
        title: "Info",
      });

      expect(toast.info).toHaveBeenCalledWith("Info", expect.any(Object));
    });

    it("should pass description to toast options", async () => {
      const { toast } = await import("sonner");

      showToast({
        type: "success",
        title: "Title",
        description: "This is a description",
      });

      expect(toast.success).toHaveBeenCalledWith(
        "Title",
        expect.objectContaining({
          description: "This is a description",
        })
      );
    });

    it("should pass duration to toast options", async () => {
      const { toast } = await import("sonner");

      showToast({
        type: "success",
        title: "Title",
        duration: 5000,
      });

      expect(toast.success).toHaveBeenCalledWith(
        "Title",
        expect.objectContaining({
          duration: 5000,
        })
      );
    });

    it("should pass action to toast options when provided", async () => {
      const { toast } = await import("sonner");
      const handleClick = vi.fn();

      showToast({
        type: "success",
        title: "Title",
        action: {
          label: "Undo",
          onClick: handleClick,
        },
      });

      expect(toast.success).toHaveBeenCalledWith(
        "Title",
        expect.objectContaining({
          action: expect.objectContaining({
            label: "Undo",
            onClick: handleClick,
          }),
        })
      );
    });

    it("should use default duration when not specified", async () => {
      const { toast } = await import("sonner");

      showToast({
        type: "info",
        title: "Info",
      });

      // Default duration should not be explicitly set (let sonner handle it)
      expect(toast.info).toHaveBeenCalledWith(
        "Info",
        expect.not.objectContaining({
          duration: expect.any(Number),
        })
      );
    });

    it("should warn and skip toast when title is missing", async () => {
      const warnSpy = vi.spyOn(console, 'warn').mockImplementation(() => {});
      const { toast } = await import("sonner");

      showToast({
        type: "info",
        title: "",
      } as any);

      expect(warnSpy).toHaveBeenCalledWith(expect.stringContaining('[Toast] title is required'));
      expect(toast.info).not.toHaveBeenCalled();

      warnSpy.mockRestore();
    });
  });

  describe("Type exports", () => {
    it("should export ToastProps type", async () => {
      const { showToast } = await import("@/components/ui/toast");

      // Type check - this will fail compilation if types are wrong
      const props: Parameters<typeof showToast>[0] = {
        type: "success",
        title: "Test",
      };

      expect(props.type).toBe("success");
    });
  });
});
```

**Step 2 (RED): Run test to verify it fails**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/toast.test.tsx --run`
Expected: FAIL with "showToast is not exported" or similar

**Step 3: Commit failing test**

```bash
git add klard-web/src/__tests__/components/ui/toast.test.tsx
git commit -m "test(web): add toast component tests (TDD red phase)"
```

---

### Task 3: Implement Web showToast Function (GREEN Phase)

**Files:**
- Modify: `klard-web/src/components/ui/toast.tsx`

**Step 1 (GREEN): Implement showToast**

```typescript
// klard-web/src/components/ui/toast.tsx
'use client';

import { toast } from "sonner";

export type ToastType = "success" | "error" | "warning" | "info";

export interface ToastAction {
  label: string;
  onClick: () => void;
}

export interface ToastProps {
  type: ToastType;
  title: string;
  description?: string;
  duration?: number;
  action?: ToastAction;
}

/**
 * Normalize toast type to valid Sonner type
 */
function normalizeType(type?: ToastType): ToastType {
  const validTypes: ToastType[] = ['success', 'error', 'warning', 'info'];
  return type && validTypes.includes(type) ? type : 'info';
}

/**
 * Display a toast notification
 *
 * @example
 * showToast({
 *   type: "success",
 *   title: "Changes saved",
 *   description: "Your profile has been updated",
 * });
 */
export function showToast({ type, title, description, duration, action }: ToastProps): void {
  // Validate title
  if (!title || title.trim() === '') {
    if (process.env.NODE_ENV !== 'production') {
      console.warn('[Toast] title is required');
    }
    return;
  }

  const normalizedType = normalizeType(type);
  const options: Parameters<typeof toast.success>[1] = {};

  if (description) {
    options.description = description;
  }

  if (duration !== undefined) {
    options.duration = duration;
  }

  if (action) {
    options.action = {
      label: action.label,
      onClick: action.onClick,
    };
  }

  toast[normalizedType](title, options);
}
```

**Step 2 (GREEN): Run test to verify it passes**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/toast.test.tsx --run`
Expected: PASS

**Step 3: Commit**

```bash
git add klard-web/src/components/ui/toast.tsx
git commit -m "feat(web): implement showToast function"
```

---

### Task 4: Add Sonner Toaster Component with Klard Styling

**Files:**
- Create: `klard-web/src/components/ui/sonner.tsx`

**Step 1: Check if sonner is installed**

Run: `grep -q '"sonner"' klard-web/package.json && echo "installed" || echo "not installed"`

If not installed:
Run: `pnpm --filter klard-web add sonner`

**Step 2: Create Toaster component with Klard styling**

```typescript
// klard-web/src/components/ui/sonner.tsx
"use client";

import { Toaster as SonnerToaster } from "sonner";

interface ToasterProps {
  position?: "top-left" | "top-center" | "top-right" | "bottom-left" | "bottom-center" | "bottom-right";
}

/**
 * Klard-styled Toaster component
 *
 * Add this to your root layout to enable toast notifications:
 * @example
 * // app/layout.tsx
 * import { Toaster } from "@/components/ui/sonner";
 *
 * export default function RootLayout({ children }) {
 *   return (
 *     <html>
 *       <body>
 *         {children}
 *         <Toaster />
 *       </body>
 *     </html>
 *   );
 * }
 */
export function Toaster({ position = "bottom-right" }: ToasterProps) {
  return (
    <SonnerToaster
      position={position}
      richColors
      closeButton
      toastOptions={{
        classNames: {
          toast: "border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 shadow-lg rounded-xl",
          title: "text-slate-900 dark:text-slate-50 font-medium text-sm",
          description: "text-slate-500 dark:text-slate-400 text-xs",
          actionButton: "bg-teal-600 text-white hover:bg-teal-700 dark:bg-teal-500 dark:hover:bg-teal-600",
          cancelButton: "bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700",
          success: "border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-950/50",
          error: "border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-950/50",
          warning: "border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-950/50",
          info: "border-teal-200 dark:border-teal-800 bg-teal-50 dark:bg-teal-950/50",
        },
      }}
      data-slot="toast-provider"
    />
  );
}
```

**Step 3: Verify TypeScript compiles**

Run: `pnpm --filter klard-web exec tsc --noEmit`
Expected: No errors

**Step 4: Commit**

```bash
git add klard-web/src/components/ui/sonner.tsx
git commit -m "feat(web): add Klard-styled Toaster component"
```

---

### Task 5: Define Mobile Toast Types

**Files:**
- Create: `klard-mobile/src/components/ui/Toast.tsx`

**Step 1 (RED): Create type definitions**

```typescript
// klard-mobile/src/components/ui/Toast.tsx
export type ToastType = "success" | "error" | "warning" | "info";

export interface ToastAction {
  label: string;
  onClick: () => void;
}

export interface ToastProps {
  type: ToastType;
  title: string;
  description?: string;
  duration?: number;
  action?: ToastAction;
}

// Implementation will be added in Task 7
```

**Step 2 (RED): Verify file created**

Run: `ls klard-mobile/src/components/ui/Toast.tsx`
Expected: File exists

**Step 3: Commit**

```bash
git add klard-mobile/src/components/ui/Toast.tsx
git commit -m "feat(mobile): add toast type definitions"
```

---

### Task 6: Write Mobile Toast Tests (RED Phase)

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/Toast.test.tsx`

**Step 1 (RED): Write the failing tests**

```typescript
// klard-mobile/src/__tests__/components/ui/Toast.test.tsx
/**
 * Tests for Toast Component (Mobile)
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import React from "react";
import { render, waitFor } from "@testing-library/react-native";
import { showToast } from "@/components/ui/Toast";
import Toast from "react-native-toast-message";
import * as Haptics from "expo-haptics";

// Mock react-native-toast-message
jest.mock("react-native-toast-message", () => ({
  show: jest.fn(),
  hide: jest.fn(),
  __esModule: true,
  default: jest.fn(() => null),
}));

// Mock expo-haptics
jest.mock("expo-haptics", () => ({
  notificationAsync: jest.fn(),
  NotificationFeedbackType: {
    Success: "success",
    Warning: "warning",
    Error: "error",
  },
}));

describe("Toast", () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe("showToast function", () => {
    it("should call Toast.show for success type", () => {
      showToast({
        type: "success",
        title: "Success!",
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          type: "success",
          text1: "Success!",
        })
      );
    });

    it("should call Toast.show for error type", () => {
      showToast({
        type: "error",
        title: "Error occurred",
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          type: "error",
          text1: "Error occurred",
        })
      );
    });

    it("should call Toast.show for warning type", () => {
      showToast({
        type: "warning",
        title: "Warning",
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          type: "warning",
          text1: "Warning",
        })
      );
    });

    it("should call Toast.show for info type", () => {
      showToast({
        type: "info",
        title: "Info",
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          type: "info",
          text1: "Info",
        })
      );
    });

    it("should pass description as text2", () => {
      showToast({
        type: "success",
        title: "Title",
        description: "This is a description",
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          text1: "Title",
          text2: "This is a description",
        })
      );
    });

    it("should pass duration as visibilityTime", () => {
      showToast({
        type: "success",
        title: "Title",
        duration: 5000,
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          visibilityTime: 5000,
        })
      );
    });

    it("should use default duration of 3000ms when not specified", () => {
      showToast({
        type: "info",
        title: "Info",
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          visibilityTime: 3000,
        })
      );
    });

    it("should trigger haptic feedback for success", async () => {
      showToast({
        type: "success",
        title: "Success",
      });

      await waitFor(() => {
        expect(Haptics.notificationAsync).toHaveBeenCalledWith(
          Haptics.NotificationFeedbackType.Success
        );
      });
    });

    it("should trigger haptic feedback for error", async () => {
      showToast({
        type: "error",
        title: "Error",
      });

      await waitFor(() => {
        expect(Haptics.notificationAsync).toHaveBeenCalledWith(
          Haptics.NotificationFeedbackType.Error
        );
      });
    });

    it("should trigger haptic feedback for warning", async () => {
      showToast({
        type: "warning",
        title: "Warning",
      });

      await waitFor(() => {
        expect(Haptics.notificationAsync).toHaveBeenCalledWith(
          Haptics.NotificationFeedbackType.Warning
        );
      });
    });

    it("should not trigger haptic feedback for info", () => {
      showToast({
        type: "info",
        title: "Info",
      });

      expect(Haptics.notificationAsync).not.toHaveBeenCalled();
    });

    it("should pass action via props when provided", () => {
      const handleClick = jest.fn();

      showToast({
        type: "success",
        title: "Title",
        action: {
          label: "Undo",
          onClick: handleClick,
        },
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          props: expect.objectContaining({
            action: expect.objectContaining({
              label: "Undo",
              onClick: handleClick,
            }),
          }),
        })
      );
    });

    it("should use bottom position by default", () => {
      showToast({
        type: "info",
        title: "Info",
      });

      expect(Toast.show).toHaveBeenCalledWith(
        expect.objectContaining({
          position: "bottom",
        })
      );
    });

    it("should warn and skip toast when title is missing", () => {
      const warnSpy = jest.spyOn(console, 'warn').mockImplementation(() => {});

      showToast({
        type: "info",
        title: "",
      } as any);

      expect(warnSpy).toHaveBeenCalledWith(expect.stringContaining('[Toast] title is required'));
      expect(Toast.show).not.toHaveBeenCalled();

      warnSpy.mockRestore();
    });
  });
});
```

**Step 2 (RED): Run test to verify it fails**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/Toast.test.tsx --run`
Expected: FAIL with "showToast is not exported" or similar

**Step 3: Commit failing test**

```bash
git add klard-mobile/src/__tests__/components/ui/Toast.test.tsx
git commit -m "test(mobile): add toast component tests (TDD red phase)"
```

---

### Task 7: Implement Mobile showToast Function with Haptics (GREEN Phase)

**Files:**
- Modify: `klard-mobile/src/components/ui/Toast.tsx`

**Step 1: Check if dependencies are installed**

Run: `grep -q '"react-native-toast-message"' klard-mobile/package.json && echo "installed" || echo "not installed"`

If not installed:
Run: `pnpm --filter klard-mobile add react-native-toast-message`

**Step 2 (GREEN): Implement showToast with haptics**

```typescript
// klard-mobile/src/components/ui/Toast.tsx
import ToastLib from "react-native-toast-message";
import * as Haptics from "expo-haptics";

export type ToastType = "success" | "error" | "warning" | "info";

export interface ToastAction {
  label: string;
  onClick: () => void;
}

export interface ToastProps {
  type: ToastType;
  title: string;
  description?: string;
  duration?: number;
  action?: ToastAction;
}

/**
 * Haptic feedback mapping for toast types
 */
const hapticFeedback: Record<ToastType, Haptics.NotificationFeedbackType | null> = {
  success: Haptics.NotificationFeedbackType.Success,
  error: Haptics.NotificationFeedbackType.Error,
  warning: Haptics.NotificationFeedbackType.Warning,
  info: null, // No haptic for info
};

/**
 * Normalize toast type to valid type
 */
function normalizeType(type?: ToastType): ToastType {
  const validTypes: ToastType[] = ['success', 'error', 'warning', 'info'];
  return type && validTypes.includes(type) ? type : 'info';
}

/**
 * Display a toast notification on mobile with haptic feedback
 *
 * @example
 * showToast({
 *   type: "success",
 *   title: "Changes saved",
 *   description: "Your profile has been updated",
 * });
 */
export function showToast({
  type,
  title,
  description,
  duration,
  action,
}: ToastProps): void {
  // Validate title
  if (!title || title.trim() === '') {
    if (__DEV__) {
      console.warn('[Toast] title is required');
    }
    return;
  }

  const normalizedType = normalizeType(type);

  // Trigger haptic feedback
  const feedback = hapticFeedback[normalizedType];
  if (feedback) {
    Haptics.notificationAsync(feedback);
  }

  ToastLib.show({
    type: normalizedType,
    text1: title,
    text2: description,
    visibilityTime: duration ?? 3000,
    position: "bottom",
    props: action ? { action } : undefined,
  });
}

/**
 * Hide the currently visible toast
 */
export function hideToast(): void {
  ToastLib.hide();
}
```

**Step 3 (GREEN): Run test to verify it passes**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/Toast.test.tsx --run`
Expected: PASS

**Step 4: Commit**

```bash
git add klard-mobile/src/components/ui/Toast.tsx
git commit -m "feat(mobile): implement showToast function with haptics"
```

---

### Task 8: Create Mobile Toast Config with Klard Styling

**Files:**
- Create: `klard-mobile/src/components/ui/ToastConfig.tsx`

**Step 1: Create custom toast config**

```typescript
// klard-mobile/src/components/ui/ToastConfig.tsx
import React from "react";
import { View, Text, Pressable, StyleSheet } from "react-native";
import { BaseToastProps } from "react-native-toast-message";
import { Ionicons } from "@expo/vector-icons";

// Klard Design System colors
const colors = {
  success: {
    bg: "#ECFDF5", // green-50
    border: "#059669", // green-600
    text: "#065F46", // green-800
    icon: "#059669",
  },
  error: {
    bg: "#FEF2F2", // red-50
    border: "#DC2626", // red-600
    text: "#991B1B", // red-800
    icon: "#DC2626",
  },
  warning: {
    bg: "#FFFBEB", // amber-50
    border: "#D97706", // amber-600
    text: "#92400E", // amber-800
    icon: "#D97706",
  },
  info: {
    bg: "#F0FDFA", // teal-50
    border: "#0D7C7A", // teal-600
    text: "#115E59", // teal-800
    icon: "#0D7C7A",
  },
};

const icons: Record<string, keyof typeof Ionicons.glyphMap> = {
  success: "checkmark-circle",
  error: "close-circle",
  warning: "warning",
  info: "information-circle",
};

interface CustomToastProps extends BaseToastProps {
  props?: {
    action?: {
      label: string;
      onClick: () => void;
    };
  };
}

/**
 * Create a styled toast component for a specific type
 */
function createToastComponent(type: keyof typeof colors) {
  return function CustomToast({ text1, text2, props, ...rest }: CustomToastProps) {
    const color = colors[type];
    const iconName = icons[type];

    // Build accessibility label
    const accessibilityLabel = [
      `${type}:`,
      text1,
      text2,
      props?.action?.label ? `${props.action.label} button available.` : null,
    ]
      .filter(Boolean)
      .join(" ");

    return (
      <View
        style={[styles.container, { backgroundColor: color.bg, borderLeftColor: color.border }]}
        accessible
        accessibilityLabel={accessibilityLabel}
        accessibilityRole="alert"
      >
        <Ionicons name={iconName} size={24} color={color.icon} style={styles.icon} />
        <View style={styles.content}>
          {text1 && (
            <Text
              style={[styles.title, { color: color.text }]}
              numberOfLines={2}
              testID="toast-title"
            >
              {text1}
            </Text>
          )}
          {text2 && (
            <Text
              style={[styles.description, { color: color.text }]}
              numberOfLines={3}
              testID="toast-description"
            >
              {text2}
            </Text>
          )}
        </View>
        {props?.action && (
          <Pressable
            onPress={props.action.onClick}
            style={({ pressed }) => [
              styles.actionButton,
              { backgroundColor: color.border, opacity: pressed ? 0.8 : 1 },
            ]}
            accessibilityRole="button"
            accessibilityLabel={props.action.label}
            testID="toast-action"
          >
            <Text style={styles.actionText}>{props.action.label}</Text>
          </Pressable>
        )}
      </View>
    );
  };
}

/**
 * Klard-styled toast configuration for react-native-toast-message
 *
 * @example
 * // App.tsx or _layout.tsx
 * import Toast from "react-native-toast-message";
 * import { toastConfig } from "@/components/ui/ToastConfig";
 *
 * export default function App() {
 *   return (
 *     <>
 *       {children}
 *       <Toast config={toastConfig} />
 *     </>
 *   );
 * }
 */
export const toastConfig = {
  success: createToastComponent("success"),
  error: createToastComponent("error"),
  warning: createToastComponent("warning"),
  info: createToastComponent("info"),
};

const styles = StyleSheet.create({
  container: {
    flexDirection: "row",
    alignItems: "center",
    width: "90%",
    minHeight: 60,
    paddingHorizontal: 16,
    paddingVertical: 12,
    borderRadius: 12,
    borderLeftWidth: 4,
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 4,
  },
  icon: {
    marginRight: 12,
  },
  content: {
    flex: 1,
  },
  title: {
    fontSize: 15,
    fontWeight: "600",
    marginBottom: 2,
  },
  description: {
    fontSize: 13,
    opacity: 0.9,
  },
  actionButton: {
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 6,
    marginLeft: 8,
    minHeight: 44, // Accessibility: minimum touch target
    minWidth: 44,
    justifyContent: "center",
    alignItems: "center",
  },
  actionText: {
    color: "#FFFFFF",
    fontSize: 13,
    fontWeight: "600",
  },
});
```

**Step 2: Verify TypeScript compiles**

Run: `pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add klard-mobile/src/components/ui/ToastConfig.tsx
git commit -m "feat(mobile): add Klard-styled toast configuration"
```

---

### Task 9: Update Component Exports

**Files:**
- Modify: `klard-web/src/components/ui/index.ts`
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Update web exports**

Add to `klard-web/src/components/ui/index.ts`:

```typescript
export { Toaster } from './sonner';
export { showToast, type ToastProps, type ToastType, type ToastAction } from './toast';
```

**Step 2: Update mobile exports**

Add to `klard-mobile/src/components/ui/index.ts`:

```typescript
export { showToast, hideToast, type ToastProps, type ToastType, type ToastAction } from './Toast';
export { toastConfig } from './ToastConfig';
```

**Step 3: Verify TypeScript compiles for both**

Run: `pnpm --filter klard-web exec tsc --noEmit && pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 4: Commit**

```bash
git add klard-web/src/components/ui/index.ts klard-mobile/src/components/ui/index.ts
git commit -m "feat: export toast components from ui index"
```

---

### Task 10: Verification and Mark Complete

**Step 1: Run all web tests**

Run: `pnpm --filter klard-web test --run`
Expected: All tests PASS

**Step 2: Run all mobile tests**

Run: `pnpm --filter klard-mobile test --run`
Expected: All tests PASS

**Step 3: TypeScript check both packages**

Run: `pnpm --filter klard-web exec tsc --noEmit && pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 4: Manual QA (Optional but recommended)**

Web:
- [ ] Trigger each type (success/error/warning/info); verify colors/icons
- [ ] Action button works and toast dismisses after click
- [ ] Duration override works (e.g., 1000ms)
- [ ] Multiple toasts stack properly

Mobile:
- [ ] Trigger each type; verify styling
- [ ] Haptic feedback triggers for success/error/warning (not info)
- [ ] Action button triggers handler
- [ ] Safe area offset works on devices with notch
- [ ] Long text wraps, not clipped

**Step 5: Update spec marker to DONE**

Edit `docs/screens/batch/Klard_Component_Specifications.md`:

Change:
```
<!-- IN-PROGRESS:4.1-toast-notification -->
```

To:
```
<!-- DONE:4.1-toast-notification -->
```

**Step 6: Final commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 4.1-toast-notification as done"
```

---

## Usage Examples

### Web Usage

```tsx
// app/layout.tsx
import { Toaster } from "@/components/ui/sonner";

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Toaster />
      </body>
    </html>
  );
}

// Any component
import { showToast } from "@/components/ui/toast";

function MyComponent() {
  const handleSave = async () => {
    try {
      await saveData();
      showToast({
        type: "success",
        title: "Saved!",
        description: "Your changes have been saved.",
      });
    } catch (error) {
      showToast({
        type: "error",
        title: "Error",
        description: "Failed to save changes.",
        action: {
          label: "Retry",
          onClick: handleSave,
        },
      });
    }
  };
}
```

### Mobile Usage

```tsx
// app/_layout.tsx
import Toast from "react-native-toast-message";
import { toastConfig } from "@/components/ui/ToastConfig";

export default function RootLayout() {
  return (
    <>
      <Stack />
      <Toast config={toastConfig} />
    </>
  );
}

// Any component
import { showToast } from "@/components/ui/Toast";

function MyComponent() {
  const handleSave = async () => {
    try {
      await saveData();
      showToast({
        type: "success",
        title: "Saved!",
        description: "Your changes have been saved.",
      });
    } catch (error) {
      showToast({
        type: "error",
        title: "Error",
        description: "Failed to save changes.",
        action: {
          label: "Retry",
          onClick: handleSave,
        },
      });
    }
  };
}
```

---

## Dependencies Required

### Web
- `sonner` - Toast notification library for React

Install: `pnpm --filter klard-web add sonner`

### Mobile
- `react-native-toast-message` - Toast notification library for React Native
- `expo-haptics` - Already installed (haptic feedback)
- `@expo/vector-icons` - Already installed (icons)

Install: `pnpm --filter klard-mobile add react-native-toast-message`

---

## Commands Reference

```bash
# Install dependencies
pnpm --filter klard-web add sonner
pnpm --filter klard-mobile add react-native-toast-message

# Run tests
pnpm --filter klard-web test src/__tests__/components/ui/toast.test.tsx --run
pnpm --filter klard-mobile test src/__tests__/components/ui/Toast.test.tsx --run

# Type check
pnpm --filter klard-web exec tsc --noEmit
pnpm --filter klard-mobile exec tsc --noEmit
```

---

## Acceptance Criteria (Final)

- [x] showToast works across all types (success/error/warning/info) on both platforms
- [x] Action button optional and functional
- [x] Duration defaults applied (4000ms web, 3000ms mobile)
- [x] Type-specific colors/icons applied per Klard design system
- [x] Haptic feedback on mobile for success/error/warning
- [x] Providers rendered without errors
- [x] All tests pass (RED-GREEN-REFACTOR TDD cycle)
- [x] TypeScript strict mode compliance
- [x] Accessibility requirements met (ARIA, VoiceOver, contrast)
- [x] Spec marker updated to DONE