# 1.4 Checkbox Component Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a unified CheckboxField component for Web and Mobile that wraps checkbox primitives with label, description, and accessibility support.

**Architecture:**
- Web: Extend existing shadcn/ui Checkbox primitive with a composed CheckboxField component
- Mobile: Use expo-checkbox with expo-haptics for haptic feedback, wrapped in a CheckboxField component
- Both platforms follow identical props interface for consistency

**Tech Stack:**
- Web: @radix-ui/react-checkbox (via shadcn), lucide-react, Tailwind CSS
- Mobile: expo-checkbox, expo-haptics, React Native StyleSheet

---

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| CheckboxField (Web) | Renders checkbox with label/description | Extends via className prop | Handles all CheckboxProps | Single focused interface | Depends on Checkbox primitive abstraction |
| CheckboxField (Mobile) | Renders checkbox with label/description | Extends via style prop | Handles all CheckboxProps | Single focused interface | Depends on expo-checkbox abstraction |

### Principle Applications
- **SRP:** CheckboxField handles composition only; styling separate from behavior
- **OCP:** Extensible via className/style props without modification
- **LSP:** Both platform components accept same props interface
- **ISP:** Single CheckboxFieldProps interface - no unused methods
- **DIP:** Components depend on primitive abstractions, not implementations

---

## Test Strategy (TDD)

### Tests to Write First (RED phase):
1. Renders checkbox without label
2. Renders checkbox with label
3. Renders checkbox with label and description
4. Handles checked state change
5. Disabled state prevents interaction
6. Indeterminate state renders correctly (web only)
7. Accessibility attributes present
8. Haptic feedback triggers on change (mobile only)

---

## Task 1: Install expo-checkbox dependency (Mobile)

**Files:**
- Modify: `klard-mobile/package.json`

**Step 1: Install expo-checkbox**

Run:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps && pnpm --filter klard-mobile add expo-checkbox
```

Expected: Package added to dependencies

**Step 2: Verify installation**

Run:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-mobile && cat package.json | grep expo-checkbox
```

Expected: `"expo-checkbox": "~4.0.0"` or similar version

---

## Task 2: Write failing tests for Web CheckboxField (TDD RED)

**Files:**
- Create: `klard-web/src/__tests__/components/ui/checkbox-field.test.tsx`

**Step 1: Write the failing tests**

```tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { CheckboxField } from '@/components/ui/checkbox-field';

describe('CheckboxField', () => {
  it('renders checkbox without label', () => {
    const onChange = vi.fn();
    render(<CheckboxField checked={false} onChange={onChange} />);

    const checkbox = screen.getByRole('checkbox');
    expect(checkbox).toBeInTheDocument();
  });

  it('renders checkbox with label', () => {
    const onChange = vi.fn();
    render(
      <CheckboxField
        checked={false}
        onChange={onChange}
        label="Accept terms"
      />
    );

    expect(screen.getByText('Accept terms')).toBeInTheDocument();
  });

  it('renders checkbox with label and description', () => {
    const onChange = vi.fn();
    render(
      <CheckboxField
        checked={false}
        onChange={onChange}
        label="Accept terms"
        description="You must accept to continue"
      />
    );

    expect(screen.getByText('Accept terms')).toBeInTheDocument();
    expect(screen.getByText('You must accept to continue')).toBeInTheDocument();
  });

  it('calls onChange when clicked', () => {
    const onChange = vi.fn();
    render(<CheckboxField checked={false} onChange={onChange} />);

    const checkbox = screen.getByRole('checkbox');
    fireEvent.click(checkbox);

    expect(onChange).toHaveBeenCalledWith(true);
  });

  it('does not call onChange when disabled', () => {
    const onChange = vi.fn();
    render(<CheckboxField checked={false} onChange={onChange} disabled />);

    const checkbox = screen.getByRole('checkbox');
    fireEvent.click(checkbox);

    expect(onChange).not.toHaveBeenCalled();
  });

  it('renders indeterminate state', () => {
    const onChange = vi.fn();
    render(<CheckboxField checked={false} onChange={onChange} indeterminate />);

    const checkbox = screen.getByRole('checkbox');
    expect(checkbox).toHaveAttribute('data-state', 'indeterminate');
  });

  it('has accessible label association', () => {
    const onChange = vi.fn();
    render(
      <CheckboxField
        checked={false}
        onChange={onChange}
        label="Accept terms"
      />
    );

    const checkbox = screen.getByRole('checkbox');
    expect(checkbox).toHaveAccessibleName('Accept terms');
  });

  it('applies disabled styling', () => {
    const onChange = vi.fn();
    render(
      <CheckboxField
        checked={false}
        onChange={onChange}
        label="Accept terms"
        disabled
      />
    );

    const checkbox = screen.getByRole('checkbox');
    expect(checkbox).toBeDisabled();
  });
});
```

**Step 2: Run tests to verify they fail**

Run:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps && pnpm --filter klard-web test src/__tests__/components/ui/checkbox-field.test.tsx
```

Expected: FAIL - Module not found or component not exported

---

## Task 3: Implement Web CheckboxField component (TDD GREEN)

**Files:**
- Create: `klard-web/src/components/ui/checkbox-field.tsx`
- Modify: `klard-web/src/components/ui/index.ts`

**Step 1: Create CheckboxField component**

```tsx
'use client';

import { useId } from 'react';
import { Checkbox } from '@/components/ui/checkbox';
import { Label } from '@/components/ui/label';
import { cn } from '@/lib/utils';

export interface CheckboxFieldProps {
  checked: boolean;
  onChange: (checked: boolean) => void;
  label?: string;
  description?: string;
  disabled?: boolean;
  indeterminate?: boolean;
  className?: string;
}

export function CheckboxField({
  checked,
  onChange,
  label,
  description,
  disabled = false,
  indeterminate = false,
  className,
}: CheckboxFieldProps) {
  const id = useId();
  const descriptionId = useId();

  const checkboxState = indeterminate ? 'indeterminate' : checked;

  return (
    <div className={cn('flex items-start space-x-3', className)}>
      <Checkbox
        id={id}
        checked={checkboxState}
        onCheckedChange={(value) => {
          if (!disabled && typeof value === 'boolean') {
            onChange(value);
          }
        }}
        disabled={disabled}
        aria-describedby={description ? descriptionId : undefined}
        className="data-[state=checked]:bg-primary data-[state=checked]:border-primary"
      />
      {(label || description) && (
        <div className="space-y-1 leading-none">
          {label && (
            <Label
              htmlFor={id}
              className={cn(
                'cursor-pointer text-sm font-medium',
                disabled && 'cursor-not-allowed opacity-50'
              )}
            >
              {label}
            </Label>
          )}
          {description && (
            <p
              id={descriptionId}
              className={cn(
                'text-sm text-muted-foreground',
                disabled && 'opacity-50'
              )}
            >
              {description}
            </p>
          )}
        </div>
      )}
    </div>
  );
}
```

**Step 2: Export from index**

Add to `klard-web/src/components/ui/index.ts`:

```ts
export { CheckboxField, type CheckboxFieldProps } from './checkbox-field';
```

**Step 3: Run tests to verify they pass**

Run:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps && pnpm --filter klard-web test src/__tests__/components/ui/checkbox-field.test.tsx
```

Expected: All tests PASS

**Step 4: Commit**

```bash
git add klard-web/src/components/ui/checkbox-field.tsx klard-web/src/components/ui/index.ts klard-web/src/__tests__/components/ui/checkbox-field.test.tsx
git commit -m "feat(web): add CheckboxField component with TDD tests"
```

---

## Task 4: Write failing tests for Mobile CheckboxField (TDD RED)

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/CheckboxField.test.tsx`

**Step 1: Write the failing tests**

```tsx
import React from 'react';
import { render, fireEvent, screen } from '@testing-library/react-native';
import { CheckboxField } from '@/components/ui/CheckboxField';

// Mock expo-haptics
jest.mock('expo-haptics', () => ({
  impactAsync: jest.fn(),
  ImpactFeedbackStyle: {
    Light: 'light',
    Medium: 'medium',
    Heavy: 'heavy',
  },
}));

describe('CheckboxField', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('renders checkbox without label', () => {
    const onChange = jest.fn();
    render(<CheckboxField checked={false} onChange={onChange} />);

    // expo-checkbox renders with testID
    expect(screen.getByTestId('checkbox')).toBeTruthy();
  });

  it('renders checkbox with label', () => {
    const onChange = jest.fn();
    render(
      <CheckboxField
        checked={false}
        onChange={onChange}
        label="Accept terms"
      />
    );

    expect(screen.getByText('Accept terms')).toBeTruthy();
  });

  it('renders checkbox with label and description', () => {
    const onChange = jest.fn();
    render(
      <CheckboxField
        checked={false}
        onChange={onChange}
        label="Accept terms"
        description="You must accept to continue"
      />
    );

    expect(screen.getByText('Accept terms')).toBeTruthy();
    expect(screen.getByText('You must accept to continue')).toBeTruthy();
  });

  it('calls onChange when pressed', () => {
    const onChange = jest.fn();
    render(<CheckboxField checked={false} onChange={onChange} />);

    const pressable = screen.getByTestId('checkbox-pressable');
    fireEvent.press(pressable);

    expect(onChange).toHaveBeenCalledWith(true);
  });

  it('does not call onChange when disabled', () => {
    const onChange = jest.fn();
    render(<CheckboxField checked={false} onChange={onChange} disabled />);

    const pressable = screen.getByTestId('checkbox-pressable');
    fireEvent.press(pressable);

    expect(onChange).not.toHaveBeenCalled();
  });

  it('triggers haptic feedback on change', async () => {
    const Haptics = require('expo-haptics');
    const onChange = jest.fn();
    render(<CheckboxField checked={false} onChange={onChange} />);

    const pressable = screen.getByTestId('checkbox-pressable');
    fireEvent.press(pressable);

    expect(Haptics.impactAsync).toHaveBeenCalledWith(Haptics.ImpactFeedbackStyle.Light);
  });

  it('has correct accessibility role', () => {
    const onChange = jest.fn();
    render(
      <CheckboxField
        checked={false}
        onChange={onChange}
        label="Accept terms"
      />
    );

    const pressable = screen.getByTestId('checkbox-pressable');
    expect(pressable.props.accessibilityRole).toBe('checkbox');
  });

  it('has correct accessibility state', () => {
    const onChange = jest.fn();
    render(
      <CheckboxField
        checked={true}
        onChange={onChange}
        disabled={true}
      />
    );

    const pressable = screen.getByTestId('checkbox-pressable');
    expect(pressable.props.accessibilityState).toEqual({ checked: true, disabled: true });
  });
});
```

**Step 2: Run tests to verify they fail**

Run:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps && pnpm --filter klard-mobile test src/__tests__/components/ui/CheckboxField.test.tsx
```

Expected: FAIL - Module not found

---

## Task 5: Implement Mobile CheckboxField component (TDD GREEN)

**Files:**
- Create: `klard-mobile/src/components/ui/CheckboxField/CheckboxField.tsx`
- Create: `klard-mobile/src/components/ui/CheckboxField/checkbox-field.styles.ts`
- Create: `klard-mobile/src/components/ui/CheckboxField/index.ts`
- Modify: `klard-mobile/src/components/ui/index.ts` (create if not exists)

**Step 1: Create styles file**

```ts
// klard-mobile/src/components/ui/CheckboxField/checkbox-field.styles.ts
import { StyleSheet } from 'react-native';

export const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    gap: 12,
  },
  checkbox: {
    width: 20,
    height: 20,
    borderRadius: 4,
    marginTop: 2,
  },
  labelContainer: {
    flex: 1,
    gap: 4,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    lineHeight: 20,
  },
  labelDisabled: {
    opacity: 0.5,
  },
  description: {
    fontSize: 14,
    lineHeight: 20,
  },
  descriptionDisabled: {
    opacity: 0.5,
  },
});
```

**Step 2: Create CheckboxField component**

```tsx
// klard-mobile/src/components/ui/CheckboxField/CheckboxField.tsx
import { View, Text, Pressable } from 'react-native';
import Checkbox from 'expo-checkbox';
import * as Haptics from 'expo-haptics';
import { useThemeColors } from '@/hooks';
import { styles } from './checkbox-field.styles';

export interface CheckboxFieldProps {
  checked: boolean;
  onChange: (checked: boolean) => void;
  label?: string;
  description?: string;
  disabled?: boolean;
  indeterminate?: boolean;
}

export function CheckboxField({
  checked,
  onChange,
  label,
  description,
  disabled = false,
}: CheckboxFieldProps) {
  const colors = useThemeColors();

  const handleChange = async (value: boolean) => {
    if (disabled) return;

    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    onChange(value);
  };

  const handlePress = () => {
    handleChange(!checked);
  };

  return (
    <Pressable
      testID="checkbox-pressable"
      onPress={handlePress}
      disabled={disabled}
      accessibilityRole="checkbox"
      accessibilityState={{ checked, disabled }}
      accessibilityLabel={label}
      style={styles.container}
    >
      <Checkbox
        testID="checkbox"
        value={checked}
        onValueChange={handleChange}
        disabled={disabled}
        color={checked ? colors.primary : undefined}
        style={styles.checkbox}
      />
      {(label || description) && (
        <View style={styles.labelContainer}>
          {label && (
            <Text
              style={[
                styles.label,
                { color: colors.foreground },
                disabled && styles.labelDisabled,
              ]}
            >
              {label}
            </Text>
          )}
          {description && (
            <Text
              style={[
                styles.description,
                { color: colors.textSecondary },
                disabled && styles.descriptionDisabled,
              ]}
            >
              {description}
            </Text>
          )}
        </View>
      )}
    </Pressable>
  );
}
```

**Step 3: Create index export**

```ts
// klard-mobile/src/components/ui/CheckboxField/index.ts
export { CheckboxField, type CheckboxFieldProps } from './CheckboxField';
```

**Step 4: Create or update UI index**

Create `klard-mobile/src/components/ui/index.ts` if not exists, or add:

```ts
export { CheckboxField, type CheckboxFieldProps } from './CheckboxField';
```

**Step 5: Run tests to verify they pass**

Run:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps && pnpm --filter klard-mobile test src/__tests__/components/ui/CheckboxField.test.tsx
```

Expected: All tests PASS

**Step 6: Commit**

```bash
git add klard-mobile/src/components/ui/CheckboxField klard-mobile/src/components/ui/index.ts klard-mobile/src/__tests__/components/ui/CheckboxField.test.tsx klard-mobile/package.json pnpm-lock.yaml
git commit -m "feat(mobile): add CheckboxField component with expo-checkbox and haptics"
```

---

## Task 6: TypeScript Verification

**Step 1: Run TypeScript check for web**

Run:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps && pnpm --filter klard-web exec tsc --noEmit
```

Expected: No errors

**Step 2: Run TypeScript check for mobile**

Run:
```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps && pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No errors

---

## Task 7: Update Component Specification

**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md`

**Step 1: Replace IN-PROGRESS with DONE marker**

Find:
```
<!-- COMPONENT:START:1.4-checkbox -->
<!-- IN-PROGRESS:1.4-checkbox -->
```

Replace with:
```
<!-- COMPONENT:START:1.4-checkbox -->
<!-- DONE:1.4-checkbox -->
```

**Step 2: Commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 1.4-checkbox component as done"
```

---

## Verification Checklist

Before marking complete, verify:

- [ ] Web CheckboxField renders without errors
- [ ] Mobile CheckboxField renders without errors
- [ ] All props implemented and typed
- [ ] All states functional (checked, unchecked, disabled, indeterminate-web)
- [ ] Accessibility attributes present
- [ ] TypeScript passes with no errors
- [ ] All tests passing
- [ ] Haptic feedback works on mobile
- [ ] Works on both platforms

---

## Parallel Sub-Agent Strategy

**Tasks that can run in parallel:**
- Task 2 (Web tests) and Task 4 (Mobile tests) - independent test files
- TypeScript checks for web and mobile after implementation

**Tasks that must be sequential:**
- Task 1 (install) → Task 4 (mobile tests) → Task 5 (mobile impl)
- Task 2 (web tests) → Task 3 (web impl)
- All impl tasks → Task 6 (TS verification) → Task 7 (docs update)

---

## Summary

| Task | Description | Platform | TDD Phase |
|------|-------------|----------|-----------|
| 1 | Install expo-checkbox | Mobile | Setup |
| 2 | Write failing web tests | Web | RED |
| 3 | Implement web CheckboxField | Web | GREEN |
| 4 | Write failing mobile tests | Mobile | RED |
| 5 | Implement mobile CheckboxField | Mobile | GREEN |
| 6 | TypeScript verification | Both | Verify |
| 7 | Update specification | Docs | Complete |