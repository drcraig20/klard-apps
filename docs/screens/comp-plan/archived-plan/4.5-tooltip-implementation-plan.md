# Tooltip Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Deliver a cross-platform Tooltip that provides contextual help on hover/focus (web) and long-press (mobile) with configurable placement, timing, animation, and accessibility that matches Klard design tokens.

**Architecture:** 
- **Web:** Wrap shadcn/ui `TooltipProvider` + `Tooltip` primitives. Controlled via `side`, `align`, `delayMs`, `maxWidth`, `className`, `asChild`. Data-slot tags for trigger/content. Default delay ~150ms, fade/scale entry, Radix-managed aria, optional width cap.
- **Mobile:** Pressable trigger with long-press to reveal bubble; `expo-haptics` feedback; opacity/scale animation; auto-hide timeout; press-out hides immediately; optional side/align offset presets; absolute-position overlay within container to avoid layout shift; timer cleanup on unmount.

**Tech Stack:** Next.js 16 App Router, React 19, Tailwind 4, shadcn/ui Tooltip, `cn`, Vitest + Testing Library (web). Expo SDK 54, React Native, `expo-haptics`, `Animated`/`StyleSheet`/`Pressable`/`View`/`Text`, React Native Testing Library (mobile).

---

- **Component:** Tooltip (web/mobile) wraps trigger content, shows contextual text. Props:
  ```ts
  type TooltipSide = 'top' | 'right' | 'bottom' | 'left';
  type TooltipAlign = 'start' | 'center' | 'end';
  interface TooltipProps {
    content: React.ReactNode;
    side?: TooltipSide;
    align?: TooltipAlign;
    delayMs?: number;          // web hover/focus delay
    children: React.ReactNode;
    maxWidth?: number | string;
    className?: string;        // content bubble override
    asChild?: boolean;         // web trigger passthrough
  }
  ```
- **Visual states:** hidden → visible on hover/focus (web) or long-press (mobile); fade/scale animation; focus-visible state on trigger. Auto-hide on blur/mouse leave (web), after timeout (mobile), and on press-out. No pointer triangle to reduce complexity. 
- **Size/position:** Default padding `px-3 py-2` with `rounded-md`. `maxWidth` defaults ~220–240px; override via prop. Positioning via Radix `side/align` (web) and simple offset margins per side (mobile).
- **Colors/tokens:** Dark surface `bg-slate-900/90`, text `text-slate-50`, border `border-slate-800/70`, shadow `shadow-md shadow-slate-900/50`. Mobile bubble mirrors colors with StyleSheet.
- **Accessibility:** Web: Radix manages aria-describedby; include TooltipProvider; support `asChild` to avoid wrapper spans; add `data-slot="tooltip"` and `data-slot="tooltip.trigger"`. Mobile: bubble `accessibilityRole="text"` and `accessible`; trigger remains Pressable; ensure timers clear on unmount; haptics optional but should not throw if unavailable.
- **Dependencies:** shadcn/ui Tooltip, `cn`; mobile: `expo-haptics`, `Animated`, `StyleSheet`, `Pressable`, `View`, `Text`.
- **SOLID compliance:**
  | Component | SRP | OCP | LSP | ISP | DIP |
  |-----------|-----|-----|-----|-----|-----|
  | Tooltip (web) | Manage tooltip display around trigger | Extend via props/className without modifying core | Works with any trigger child | Minimal props | Depends on Radix abstractions |
  | Tooltip (mobile) | Long-press bubble with timer/haptics | Timing/placement tunable via props | Same prop contract for all triggers | Minimal interface | Depends on haptics/timer abstractions |
- **Parallel sub-agent strategy:** (emulated) Web tests/impl → checkpoint → Mobile tests/impl → checkpoint.
- **Test strategy (TDD):** Web: children intact, hover shows content, focus shows content, `side` reflected, `maxWidth` applied, `className` merged, `data-slot` present, `delayMs` honored (fake timers). Mobile: long-press shows, auto-hide after timeout, onPressOut hides, haptics invoked once, `maxWidth` applied, bubble testID/accessibility set, optional side offset reflected.

### Task 1: Write failing web tests
**Files:**
- Create: `klard-web/src/__tests__/components/ui/tooltip.test.tsx`
- Test cmd: `pnpm --filter klard-web test src/__tests__/components/ui/tooltip.test.tsx --run`

**Step 1: Write the failing test**
- Cases: renders children untouched; hover shows tooltip text; focus via keyboard shows tooltip; side prop sets `data-side` or class; maxWidth applied; data-slot attributes exist; custom class merges; delay respected (can assert via fake timers).

**Step 2: Run test to verify it fails**
- Expect missing component/behavior failures.

### Task 2: Implement web Tooltip
**Files:**
- Create: `klard-web/src/components/ui/tooltip.tsx`
- Modify: `klard-web/src/components/ui/index.ts`
- Test cmd: `pnpm --filter klard-web test src/__tests__/components/ui/tooltip.test.tsx --run`

**Step 1: Implement minimal code**
- Wrap TooltipProvider/Tooltip/TooltipTrigger/TooltipContent; support side/align/delayMs/maxWidth/className; data-slot attributes; asChild trigger; default delay 100–150ms; apply maxWidth via style/class.

**Step 2: Run test to verify it passes**
- Keep green; refine styles if needed.

**Step 3: Refactor**
- Clean props typing and default props.

### Task 3: Write failing mobile tests
**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/tooltip.test.tsx`
- Test cmd: `pnpm --filter klard-mobile test src/__tests__/components/ui/tooltip.test.tsx --run`

**Step 1: Write failing test**
- Cases: long-press shows content, auto-hide after timeout, onPressOut hides, haptics invoked, maxWidth style applied, testID or accessibility markers for content.

**Step 2: Run test to verify it fails**

### Task 4: Implement mobile Tooltip
**Files:**
- Create: `klard-mobile/src/components/ui/tooltip.tsx`
- Modify: `klard-mobile/src/components/ui/index.ts`
- Test cmd: `pnpm --filter klard-mobile test src/__tests__/components/ui/tooltip.test.tsx --run`

**Step 1: Implement minimal code**
- Pressable trigger; stateful visibility; haptics.selectionAsync on long-press; Animated or simple opacity fade; absolute-position bubble with padding, borderRadius, shadow; apply maxWidth; timer cleanup on unmount/press-out.

**Step 2: Run test to verify it passes**
- Keep green; refactor if needed.

### Task 5: Verification and spec update
**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md` (mark DONE)
- Commands: `pnpm --filter klard-web test src/__tests__/components/ui/tooltip.test.tsx --run`; `pnpm --filter klard-web exec tsc --noEmit`; `pnpm --filter klard-mobile test src/__tests__/components/ui/tooltip.test.tsx --run`; optional lint.

**Step 1:** Run verification commands, capture outputs.
**Step 2:** Update marker to `<!-- DONE:4.5-tooltip -->`.
**Step 3:** Suggested commit message `feat: add tooltip component`.
