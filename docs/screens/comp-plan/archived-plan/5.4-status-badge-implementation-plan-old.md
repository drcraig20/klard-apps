# StatusBadge Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a domain-specific StatusBadge component that displays subscription/card status with consistent icons and colors across Web and Mobile platforms.

**Architecture:** StatusBadge is a thin wrapper around the existing Badge component that maps status types (active, trial, paused, blocked, cancelled, locked, expired, pending) to appropriate visual variants and icons. The configuration is data-driven for easy extension.

**Tech Stack:**
- Web: TypeScript, React, CVA, Lucide Icons, shadcn/ui Badge
- Mobile: TypeScript, React Native, Ionicons, expo-haptics

---

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| StatusBadge (Web) | Maps status to visual | Config-driven, extend via data | N/A (no inheritance) | Single prop interface | Depends on Badge abstraction |
| StatusBadge (Mobile) | Maps status to visual | Config-driven, extend via data | N/A (no inheritance) | Single prop interface | Depends on Badge abstraction |

### Principle Applications

**SRP:** Each component does ONE thing: map status string to badge variant + icon
**OCP:** Add new statuses by adding to config object, no code modification needed
**LSP:** N/A - no inheritance used
**ISP:** Minimal interface with single `status` prop
**DIP:** StatusBadge depends on Badge abstraction, not implementation details

---

## Test Strategy (TDD)

For each platform:
1. Write tests FIRST for all status values rendering correctly
2. Verify each status maps to correct variant and icon
3. Test default/fallback behavior
4. Test accessibility attributes
5. Run tests and confirm they FAIL
6. Implement minimal code to pass
7. Refactor while keeping tests green

---

## Task 1: Web - Create StatusBadge Test File (RED)

**Files:**
- Create: `klard-web/src/__tests__/components/ui/status-badge.test.tsx`

**Step 1: Write the failing test**

```tsx
/**
 * Tests for StatusBadge Component
 *
 * TDD: Write failing tests first, then implement to pass.
 * Tests verify: status mapping, variants, icons, accessibility
 */

import { describe, it, expect } from "vitest"
import { render, screen } from "@testing-library/react"
import { StatusBadge } from "@/components/ui/status-badge"

describe("StatusBadge", () => {
  describe("Rendering", () => {
    it("should render with status text", () => {
      render(<StatusBadge status="active" />)

      expect(screen.getByText("Active")).toBeInTheDocument()
    })

    it("should have data-slot attribute", () => {
      render(<StatusBadge status="active" />)

      const badge = screen.getByText("Active")
      expect(badge.closest('[data-slot="badge"]')).toBeInTheDocument()
    })
  })

  describe("Status Mapping", () => {
    const statusCases = [
      { status: "active", label: "Active", variantMatch: /green/ },
      { status: "trial", label: "Trial", variantMatch: /amber/ },
      { status: "paused", label: "Paused", variantMatch: /slate/ },
      { status: "blocked", label: "Blocked", variantMatch: /red/ },
      { status: "cancelled", label: "Cancelled", variantMatch: /slate/ },
      { status: "locked", label: "Locked", variantMatch: /amber/ },
      { status: "expired", label: "Expired", variantMatch: /slate/ },
      { status: "pending", label: "Pending", variantMatch: /slate/ },
    ] as const

    statusCases.forEach(({ status, label }) => {
      it(`should render "${status}" status with label "${label}"`, () => {
        render(<StatusBadge status={status} />)

        expect(screen.getByText(label)).toBeInTheDocument()
      })
    })

    it("should render active status with success variant (green)", () => {
      render(<StatusBadge status="active" />)

      const badge = screen.getByText("Active")
      expect(badge.className).toMatch(/green/)
    })

    it("should render trial status with warning variant (amber)", () => {
      render(<StatusBadge status="trial" />)

      const badge = screen.getByText("Trial")
      expect(badge.className).toMatch(/amber/)
    })

    it("should render blocked status with error variant (red)", () => {
      render(<StatusBadge status="blocked" />)

      const badge = screen.getByText("Blocked")
      expect(badge.className).toMatch(/red/)
    })

    it("should render paused status with default variant (slate)", () => {
      render(<StatusBadge status="paused" />)

      const badge = screen.getByText("Paused")
      expect(badge.className).toMatch(/slate/)
    })
  })

  describe("Icon Rendering", () => {
    it("should render an icon for active status", () => {
      render(<StatusBadge status="active" />)

      // Icon should be present (shrink-0 wrapper from Badge)
      const badge = screen.getByText("Active").closest('[data-slot="badge"]')
      const iconWrapper = badge?.querySelector(".shrink-0")
      expect(iconWrapper).toBeInTheDocument()
    })

    it("should render icons for all status types", () => {
      const statuses = ["active", "trial", "paused", "blocked", "cancelled", "locked", "expired", "pending"] as const

      statuses.forEach((status) => {
        const { unmount } = render(<StatusBadge status={status} />)
        const badge = screen.getByText(status.charAt(0).toUpperCase() + status.slice(1)).closest('[data-slot="badge"]')
        const iconWrapper = badge?.querySelector(".shrink-0")
        expect(iconWrapper).toBeInTheDocument()
        unmount()
      })
    })
  })

  describe("Custom Props", () => {
    it("should pass through className prop", () => {
      render(<StatusBadge status="active" className="custom-class" />)

      const badge = screen.getByText("Active")
      expect(badge.className).toContain("custom-class")
    })

    it("should pass through additional HTML attributes", () => {
      render(<StatusBadge status="active" data-testid="status-badge" />)

      expect(screen.getByTestId("status-badge")).toBeInTheDocument()
    })
  })
})
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/status-badge.test.tsx --run`
Expected: FAIL with "Cannot find module '@/components/ui/status-badge'"

---

## Task 2: Web - Create StatusBadge Component (GREEN)

**Files:**
- Create: `klard-web/src/components/ui/status-badge.tsx`

**Step 1: Implement the component**

```tsx
"use client"

import * as React from "react"
import {
  CheckCircle,
  Clock,
  PauseCircle,
  Ban,
  XCircle,
  Lock,
  Hourglass,
  type LucideIcon,
} from "lucide-react"

import { Badge, type BadgeProps } from "@/components/ui/badge"
import { cn } from "@/lib/utils"

export type StatusType =
  | "active"
  | "trial"
  | "paused"
  | "blocked"
  | "cancelled"
  | "locked"
  | "expired"
  | "pending"

interface StatusConfig {
  label: string
  variant: BadgeProps["variant"]
  icon: LucideIcon
}

const statusConfig: Record<StatusType, StatusConfig> = {
  active: {
    label: "Active",
    variant: "success",
    icon: CheckCircle,
  },
  trial: {
    label: "Trial",
    variant: "warning",
    icon: Clock,
  },
  paused: {
    label: "Paused",
    variant: "default",
    icon: PauseCircle,
  },
  blocked: {
    label: "Blocked",
    variant: "error",
    icon: Ban,
  },
  cancelled: {
    label: "Cancelled",
    variant: "default",
    icon: XCircle,
  },
  locked: {
    label: "Locked",
    variant: "warning",
    icon: Lock,
  },
  expired: {
    label: "Expired",
    variant: "default",
    icon: Clock,
  },
  pending: {
    label: "Pending",
    variant: "default",
    icon: Hourglass,
  },
}

export interface StatusBadgeProps
  extends Omit<BadgeProps, "variant" | "icon" | "children"> {
  status: StatusType
}

function StatusBadge({ status, className, ...props }: StatusBadgeProps) {
  const config = statusConfig[status]
  const Icon = config.icon

  return (
    <Badge
      variant={config.variant}
      icon={<Icon className="h-3 w-3" aria-hidden="true" />}
      className={cn(className)}
      {...props}
    >
      {config.label}
    </Badge>
  )
}

export { StatusBadge, statusConfig }
```

**Step 2: Run test to verify it passes**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/status-badge.test.tsx --run`
Expected: PASS

---

## Task 3: Web - Export StatusBadge from Index

**Files:**
- Modify: `klard-web/src/components/ui/index.ts`

**Step 1: Add export**

Add the following line to the index.ts file:

```typescript
export { StatusBadge, statusConfig, type StatusBadgeProps, type StatusType } from './status-badge';
```

**Step 2: Run TypeScript check**

Run: `pnpm --filter klard-web exec tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add klard-web/src/components/ui/status-badge.tsx klard-web/src/__tests__/components/ui/status-badge.test.tsx klard-web/src/components/ui/index.ts
git commit -m "feat(web): add StatusBadge component with TDD"
```

---

## Task 4: Mobile - Create StatusBadge Test File (RED)

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/StatusBadge.test.tsx`

**Step 1: Write the failing test**

```tsx
/**
 * Tests for StatusBadge Component (Mobile)
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import React from 'react';
import { render, screen } from '@testing-library/react-native';
import { StatusBadge } from '@/components/ui/StatusBadge';

// Mock vector icons to avoid ESM parse issues in Jest
jest.mock('@expo/vector-icons', () => {
  const React = require('react');
  const { Text } = require('react-native');
  return {
    Ionicons: ({ name, testID }: { name: string; testID?: string }) => (
      <Text testID={testID || 'vector-icon'}>{name}</Text>
    ),
  };
});

describe('StatusBadge', () => {
  describe('Rendering', () => {
    it('should render with status text', () => {
      render(<StatusBadge status="active" />);

      expect(screen.getByText('Active')).toBeTruthy();
    });

    it('should have correct accessibility role', () => {
      render(<StatusBadge status="active" testID="status-badge" />);

      expect(screen.getByTestId('status-badge')).toBeTruthy();
    });
  });

  describe('Status Mapping', () => {
    const statusCases = [
      { status: 'active', label: 'Active' },
      { status: 'trial', label: 'Trial' },
      { status: 'paused', label: 'Paused' },
      { status: 'blocked', label: 'Blocked' },
      { status: 'cancelled', label: 'Cancelled' },
      { status: 'locked', label: 'Locked' },
      { status: 'expired', label: 'Expired' },
      { status: 'pending', label: 'Pending' },
    ] as const;

    statusCases.forEach(({ status, label }) => {
      it(`should render "${status}" status with label "${label}"`, () => {
        render(<StatusBadge status={status} />);

        expect(screen.getByText(label)).toBeTruthy();
      });
    });
  });

  describe('Icon Rendering', () => {
    it('should render an icon for active status', () => {
      render(<StatusBadge status="active" />);

      // Icon should be rendered via Ionicons mock
      expect(screen.getByTestId('status-icon')).toBeTruthy();
    });

    it('should render checkmark-circle icon for active status', () => {
      render(<StatusBadge status="active" />);

      expect(screen.getByText('checkmark-circle')).toBeTruthy();
    });

    it('should render time icon for trial status', () => {
      render(<StatusBadge status="trial" />);

      expect(screen.getByText('time')).toBeTruthy();
    });

    it('should render ban icon for blocked status', () => {
      render(<StatusBadge status="blocked" />);

      expect(screen.getByText('ban')).toBeTruthy();
    });
  });

  describe('Custom Props', () => {
    it('should pass through testID prop', () => {
      render(<StatusBadge status="active" testID="custom-status" />);

      expect(screen.getByTestId('custom-status')).toBeTruthy();
    });
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/StatusBadge.test.tsx --run`
Expected: FAIL with "Cannot find module '@/components/ui/StatusBadge'"

---

## Task 5: Mobile - Create StatusBadge Component (GREEN)

**Files:**
- Create: `klard-mobile/src/components/ui/StatusBadge.tsx`

**Step 1: Implement the component**

```tsx
import React from 'react';
import { type StyleProp, type ViewStyle } from 'react-native';
import { Ionicons } from '@expo/vector-icons';

import { Badge, type BadgeProps } from '@/components/ui/Badge';

export type StatusType =
  | 'active'
  | 'trial'
  | 'paused'
  | 'blocked'
  | 'cancelled'
  | 'locked'
  | 'expired'
  | 'pending';

type IoniconsName = React.ComponentProps<typeof Ionicons>['name'];

interface StatusConfig {
  label: string;
  variant: BadgeProps['variant'];
  icon: IoniconsName;
}

const statusConfig: Record<StatusType, StatusConfig> = {
  active: {
    label: 'Active',
    variant: 'success',
    icon: 'checkmark-circle',
  },
  trial: {
    label: 'Trial',
    variant: 'warning',
    icon: 'time',
  },
  paused: {
    label: 'Paused',
    variant: 'default',
    icon: 'pause-circle',
  },
  blocked: {
    label: 'Blocked',
    variant: 'error',
    icon: 'ban',
  },
  cancelled: {
    label: 'Cancelled',
    variant: 'default',
    icon: 'close-circle',
  },
  locked: {
    label: 'Locked',
    variant: 'warning',
    icon: 'lock-closed',
  },
  expired: {
    label: 'Expired',
    variant: 'default',
    icon: 'time',
  },
  pending: {
    label: 'Pending',
    variant: 'default',
    icon: 'hourglass',
  },
};

// Get text color based on variant for icon
const variantIconColors: Record<NonNullable<BadgeProps['variant']>, string> = {
  default: '#334155', // slate-700
  primary: '#0D7C7A', // teal-700
  success: '#15803D', // green-700
  warning: '#B45309', // amber-700
  error: '#B91C1C', // red-700
  outline: '#475569', // slate-600
};

export interface StatusBadgeProps {
  status: StatusType;
  style?: StyleProp<ViewStyle>;
  testID?: string;
}

export function StatusBadge({ status, style, testID }: StatusBadgeProps) {
  const config = statusConfig[status];
  const iconColor = variantIconColors[config.variant];

  return (
    <Badge
      variant={config.variant}
      icon={
        <Ionicons
          name={config.icon}
          size={12}
          color={iconColor}
          testID="status-icon"
        />
      }
      style={style}
      testID={testID}
    >
      {config.label}
    </Badge>
  );
}

export { statusConfig };
```

**Step 2: Run test to verify it passes**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/StatusBadge.test.tsx --run`
Expected: PASS

---

## Task 6: Mobile - Export StatusBadge from Index

**Files:**
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Add export**

Add the following line to the index.ts file:

```typescript
export { StatusBadge, statusConfig, type StatusBadgeProps, type StatusType } from './StatusBadge';
```

**Step 2: Run TypeScript check**

Run: `pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add klard-mobile/src/components/ui/StatusBadge.tsx klard-mobile/src/__tests__/components/ui/StatusBadge.test.tsx klard-mobile/src/components/ui/index.ts
git commit -m "feat(mobile): add StatusBadge component with TDD"
```

---

## Task 7: Verification and Update Spec

**Step 1: Run all tests**

```bash
pnpm --filter klard-web test --run
pnpm --filter klard-mobile test --run
```
Expected: All tests PASS

**Step 2: Run TypeScript checks**

```bash
pnpm --filter klard-web exec tsc --noEmit
pnpm --filter klard-mobile exec tsc --noEmit
```
Expected: No errors

**Step 3: Update spec marker to DONE**

Edit `docs/screens/batch/Klard_Component_Specifications.md`:
- Find: `<!-- IN-PROGRESS:5.4-status-badge -->`
- Replace with: `<!-- DONE:5.4-status-badge -->`

**Step 4: Final commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark StatusBadge component as DONE"
```

---

## Verification Checklist

- [ ] Web: Component renders without errors
- [ ] Web: All 8 status props render correctly
- [ ] Web: Icons display for each status
- [ ] Web: Correct variant colors applied
- [ ] Web: TypeScript passes with no errors
- [ ] Web: All tests pass
- [ ] Web: Exported from index.ts
- [ ] Mobile: Component renders without errors
- [ ] Mobile: All 8 status props render correctly
- [ ] Mobile: Icons display for each status
- [ ] Mobile: Correct variant colors applied
- [ ] Mobile: TypeScript passes with no errors
- [ ] Mobile: All tests pass
- [ ] Mobile: Exported from index.ts
- [ ] Spec file marked as DONE

---

## Summary

| Task | Platform | Description |
|------|----------|-------------|
| 1 | Web | Create test file (RED) |
| 2 | Web | Create component (GREEN) |
| 3 | Web | Export from index |
| 4 | Mobile | Create test file (RED) |
| 5 | Mobile | Create component (GREEN) |
| 6 | Mobile | Export from index |
| 7 | Both | Verification and spec update |

**Estimated Tasks:** 7 bite-sized tasks
**Platforms:** Web + Mobile
**Approach:** Strict TDD (RED-GREEN-REFACTOR)