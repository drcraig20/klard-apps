# StatusBadge Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a StatusBadge that maps subscription/card status values to consistent labels, icons, and variants on web and mobile, following Klard design tokens and accessibility rules.

**Architecture:** Data-driven config map `statusConfig` → `{ label, variant, icon }`. The component is a thin wrapper around existing Badge primitives (web shadcn/ui Badge, mobile Badge) and only translates status → props. Icons are supplied via lucide-react (web) and Ionicons (mobile). All props are typed via a shared union to prevent drift. No side effects; pure presentation.

**Tech Stack:** Next.js 16 (App Router) + React 19 + TypeScript + shadcn/ui + CVA + lucide-react; Tailwind 4 tokens via Badge variants. Mobile: React Native (Expo 54) + TypeScript + @expo/vector-icons/Ionicons; @testing-library/react (Vitest) and @testing-library/react-native (Jest).

---

## Component Overview
- **Component:** StatusBadge
- **Purpose:** Display subscription/card status with unified label, icon, and variant.
- **Target Platforms:** Web (klard-web), Mobile (klard-mobile)
- **Props (Web):**
  ```ts
  type StatusType = 'active' | 'trial' | 'paused' | 'blocked' | 'cancelled' | 'locked' | 'expired' | 'pending'
  interface StatusBadgeProps extends Omit<BadgeProps, "variant" | "icon" | "children"> {
    status: StatusType
  }
  ```
- **Props (Mobile):**
  ```ts
  interface StatusBadgeProps {
    status: StatusType
    style?: StyleProp<ViewStyle>
    testID?: string
  }
  ```
- **Visual States:** Status-driven colors (success, warning, error, default) and icons; hover/focus from Badge on web; no loading/disabled extras required.
- **Size Variants:** Use Badge default `md`; no additional sizes required in spec.
- **Color Tokens:** Use Badge variants backed by design tokens: success (#10B981), warning (#F59E0B), error (#EF4444), default slate neutrals; teal reserved for primary (not used here).
- **Accessibility:** data-slot inherited from Badge; aria-label via text; icons aria-hidden; mobile uses accessibilityRole from Badge and testID passthrough.
- **Dependencies:** Web: `Badge`, `cn`, `lucide-react` icons. Mobile: `Badge`, `@expo/vector-icons/Ionicons`. No new packages.

## SOLID Compliance
| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| StatusBadge (Web) | Single mapping concern | Config-driven status map | No inheritance used | Minimal prop surface | Depends on Badge abstraction |
| StatusBadge (Mobile) | Same mapping concern | Config-driven status map | No inheritance used | Minimal prop surface | Depends on Badge abstraction |

**Principle Applications**
- **SRP:** StatusBadge only maps status → label/icon/variant; rendering handled by Badge.
- **OCP:** Add status by extending `statusConfig` without modifying component code.
- **LSP:** No subtypes; union typing enforces valid statuses.
- **ISP:** Props limited to `status` + passthrough; no unused requirements.
- **DIP:** Relies on Badge + icon abstractions, not bespoke styling.

## Parallel Sub-Agent Strategy
- Treat tests as independent tasks (web vs mobile) to simulate parallelization; review after each platform before exports.
- Post-implementation verification as separate check (tests + typecheck + spec marker).

## Parallel Sub-Agent Strategy
- Treat platforms as independent lanes: finish web (tests → impl → export) then mobile, reviewing between platforms to simulate sub-agent checkpoints.
- Final verification and spec update as a separate review step.

## Test Strategy (TDD)
- Web: For each status, assert label text, badge variant class hints (regex), icon presence; data-slot existence; prop passthrough for className/data-testid.
- Mobile: For each status, assert label text; Ionicons mock renders correct icon name; testID passthrough; ensure no crash.
- Strict RED → GREEN → REFACTOR: write tests first, run to fail, implement minimal code, rerun to pass, then refactor if needed.

---

## Bite-Sized Tasks

### Task 1: Web Tests (RED)
**Files**
- Create: `klard-web/src/__tests__/components/ui/status-badge.test.tsx`

**Step 1: Write the failing test** (cover mapping, icons, data-slot, prop passthrough). Use snippet:
```tsx
import { describe, it, expect } from "vitest"
import { render, screen } from "@testing-library/react"
import { StatusBadge } from "@/components/ui/status-badge"

const cases = [
  { status: "active", label: "Active", match: /green/ },
  { status: "trial", label: "Trial", match: /amber/ },
  { status: "paused", label: "Paused", match: /slate|gray/ },
  { status: "blocked", label: "Blocked", match: /red/ },
  { status: "cancelled", label: "Cancelled", match: /slate|gray/ },
  { status: "locked", label: "Locked", match: /amber/ },
  { status: "expired", label: "Expired", match: /slate|gray/ },
  { status: "pending", label: "Pending", match: /slate|gray/ },
] as const

describe("StatusBadge", () => {
  it("renders with data-slot", () => {
    render(<StatusBadge status="active" />)
    expect(screen.getByText("Active").closest('[data-slot="badge"]')).toBeInTheDocument()
  })

  cases.forEach(({ status, label }) => {
    it(`maps ${status} to label`, () => {
      render(<StatusBadge status={status} />)
      expect(screen.getByText(label)).toBeInTheDocument()
    })
  })

  it("renders an icon", () => {
    render(<StatusBadge status="active" />)
    const badge = screen.getByText("Active").closest('[data-slot="badge"]')
    expect(badge?.querySelector(".shrink-0")).toBeInTheDocument()
  })

  it("passes className through", () => {
    render(<StatusBadge status="active" className="custom" />)
    expect(screen.getByText("Active").className).toContain("custom")
  })

  it("accepts data-testid", () => {
    render(<StatusBadge status="active" data-testid="status-badge" />)
    expect(screen.getByTestId("status-badge")).toBeInTheDocument()
  })
})
```

**Step 2: Run test to verify failure**  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/status-badge.test.tsx --run`  
Expected: FAIL (module not found).

### Task 2: Web Component (GREEN)
**Files**
- Create: `klard-web/src/components/ui/status-badge.tsx`

**Step 3: Implement minimal component** using config map, lucide icons, Badge wrapping, typed union, aria-hidden on icons, data-slot via Badge. Example skeleton:
```tsx
"use client"
import { CheckCircle, Clock, PauseCircle, Ban, XCircle, Lock, Hourglass, type LucideIcon } from "lucide-react"
import { Badge, type BadgeProps } from "@/components/ui/badge"
import { cn } from "@/lib/utils"

export type StatusType = "active" | "trial" | "paused" | "blocked" | "cancelled" | "locked" | "expired" | "pending"
type StatusConfig = { label: string; variant: BadgeProps["variant"]; icon: LucideIcon }
const statusConfig: Record<StatusType, StatusConfig> = { /* map statuses */ }

export interface StatusBadgeProps extends Omit<BadgeProps, "variant" | "icon" | "children"> { status: StatusType }

export function StatusBadge({ status, className, ...props }: StatusBadgeProps) {
  const config = statusConfig[status]
  const Icon = config.icon
  return (
    <Badge
      variant={config.variant}
      icon={<Icon className="h-3 w-3" aria-hidden="true" />}
      className={cn(className)}
      {...props}
    >
      {config.label}
    </Badge>
  )
}
export { statusConfig }
```

**Step 4: Run test to verify pass**  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/status-badge.test.tsx --run`  
Expected: PASS.

### Task 3: Web Export + Types
**Files**
- Modify: `klard-web/src/components/ui/index.ts`

**Step 5: Export StatusBadge and related types/config.**  
**Step 6: Typecheck web**  
Run: `pnpm --filter klard-web exec tsc --noEmit`  
Expected: No errors.

### Task 4: Mobile Tests (RED)
**Files**
- Create: `klard-mobile/src/__tests__/components/ui/StatusBadge.test.tsx`

**Step 1: Write failing test** (mapping labels, icon rendering via Ionicons mock, testID passthrough). Use snippet:
```tsx
import React from "react"
import { render, screen, fireEvent, waitFor } from "@testing-library/react-native"
import { Text } from "react-native"
import { StatusBadge } from "@/components/ui/StatusBadge"

jest.mock("@expo/vector-icons", () => {
  const React = require("react")
  const { Text } = require("react-native")
  return { Ionicons: ({ name, testID }: { name: string; testID?: string }) => <Text testID={testID || "vector-icon"}>{name}</Text> }
})

const cases = ["active","trial","paused","blocked","cancelled","locked","expired","pending"] as const

describe("StatusBadge (mobile)", () => {
  it("renders label text", () => {
    render(<StatusBadge status="active" />)
    expect(screen.getByText("Active")).toBeTruthy()
  })

  it("passes through testID", () => {
    render(<StatusBadge status="active" testID="status-badge" />)
    expect(screen.getByTestId("status-badge")).toBeTruthy()
  })

  cases.forEach((status) => {
    it(`maps ${status} to label`, () => {
      const label = status.charAt(0).toUpperCase() + status.slice(1)
      render(<StatusBadge status={status} />)
      expect(screen.getByText(label)).toBeTruthy()
    })
  })

  it("renders icon via Ionicons", () => {
    render(<StatusBadge status="active" />)
    expect(screen.getByTestId("status-icon")).toBeTruthy()
  })
})
```

**Step 2: Run test to confirm failure**  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/StatusBadge.test.tsx --run`  
Expected: FAIL (module not found).

### Task 5: Mobile Component (GREEN)
**Files**
- Create: `klard-mobile/src/components/ui/StatusBadge.tsx`

**Step 3: Implement component** using config map, Ionicons, Badge; ensure icon color matches variant; pass style/testID through. Skeleton:
```tsx
import React from "react"
import { type StyleProp, type ViewStyle } from "react-native"
import { Ionicons } from "@expo/vector-icons"
import { Badge, type BadgeProps } from "@/components/ui/Badge"

export type StatusType = "active" | "trial" | "paused" | "blocked" | "cancelled" | "locked" | "expired" | "pending"
type StatusConfig = { label: string; variant: BadgeProps["variant"]; icon: React.ComponentProps<typeof Ionicons>["name"] }
const statusConfig: Record<StatusType, StatusConfig> = { /* map statuses */ }
const variantIconColors: Record<NonNullable<BadgeProps["variant"]>, string> = { /* map variants to hex */ }

export interface StatusBadgeProps { status: StatusType; style?: StyleProp<ViewStyle>; testID?: string }

export function StatusBadge({ status, style, testID }: StatusBadgeProps) {
  const config = statusConfig[status]
  const color = variantIconColors[config.variant]
  return (
    <Badge
      variant={config.variant}
      icon={<Ionicons name={config.icon} size={12} color={color} testID="status-icon" />}
      style={style}
      testID={testID}
    >
      {config.label}
    </Badge>
  )
}
export { statusConfig }
```

**Step 4: Run test to verify pass**  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/StatusBadge.test.tsx --run`  
Expected: PASS.

### Task 6: Mobile Export + Types
**Files**
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 5: Export StatusBadge/types/config.**  
**Step 6: Typecheck mobile**  
Run: `pnpm --filter klard-mobile exec tsc --noEmit`  
Expected: No errors.

### Task 7: Verification + Spec Update
**Files**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md`

**Step 7: Run full platform tests**  
Run: `pnpm --filter klard-web test --run` and `pnpm --filter klard-mobile test --run`  
**Step 8: Update spec marker** from `<!-- IN-PROGRESS:5.4-status-badge -->` to `<!-- DONE:5.4-status-badge -->`.  
**Step 9: Final typechecks (if not already) and prep commit** (no commit executed unless requested).

---

## Parallelization Notes
- Web and mobile tasks are independent; execute sequentially in this session while reviewing after each platform to simulate sub-agent separation.

## Acceptance Criteria
- All eight statuses render correct label + icon + variant on web/mobile.
- data-slot present (web) and testID/role respected (mobile).
- No variant/prop leakage (StatusBadge does not expose variant override).
- Tests and typechecks pass for both packages.
- Spec updated to DONE.
