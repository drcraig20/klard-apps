# 4.4 Skeleton Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a Skeleton loading placeholder component for both Web and Mobile platforms with shimmer animation support.

**Architecture:** The Skeleton component provides visual loading placeholders that mimic content structure. Web uses shadcn/ui's Skeleton with Tailwind animation. Mobile uses React Native Animated API with expo-linear-gradient for the shimmer effect.

**Tech Stack:**
- Web: React, TypeScript, Tailwind CSS, shadcn/ui Skeleton
- Mobile: React Native, TypeScript, Animated API, expo-linear-gradient

---

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| Skeleton (Web) | Renders loading placeholder only | Extensible via className/style | Handles all variant types | Single focused interface | Depends on style abstractions |
| Skeleton (Mobile) | Renders animated placeholder only | Extensible via style prop | Handles all variant types | Single focused interface | Depends on theme hook abstraction |

### Principle Applications

**SRP:** Component only renders skeleton placeholder - no data fetching or state management
**OCP:** Variants (circular, text, rectangular) via props, extensible via className/style
**LSP:** All variants substitutable, same interface contract
**ISP:** Minimal props interface - only what's needed for rendering
**DIP:** Mobile depends on useThemeColors abstraction, not concrete colors

---

## Task 1: Install shadcn/ui Skeleton (Web)

**Files:**
- Modify: `klard-web/src/components/ui/skeleton.tsx` (created by CLI)

**Step 1: Install shadcn/ui skeleton component**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps/klard-web
npx shadcn@latest add skeleton
```

**Step 2: Verify the component was installed**

Check that `klard-web/src/components/ui/skeleton.tsx` exists.

**Step 3: Commit**

```bash
git add klard-web/src/components/ui/skeleton.tsx
git commit -m "feat(web): install shadcn/ui skeleton component"
```

---

## Task 2: Write Failing Tests for Web Skeleton

**Files:**
- Create: `klard-web/src/__tests__/components/ui/skeleton.test.tsx`

**Step 1: Write the failing tests**

```tsx
/**
 * Tests for Skeleton Component (Web)
 *
 * TDD: Write failing tests first, then implement to pass.
 * Tests verify: rendering, variants, sizes, animation, accessibility
 */

import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { Skeleton } from '@/components/ui/skeleton';

describe('Skeleton', () => {
  describe('Rendering', () => {
    it('should render skeleton element', () => {
      const { container } = render(<Skeleton />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toBeInTheDocument();
    });

    it('should apply base skeleton classes', () => {
      const { container } = render(<Skeleton />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton?.className).toContain('animate-pulse');
      expect(skeleton?.className).toContain('bg-slate-200');
    });
  });

  describe('Variants', () => {
    it('should apply rectangular variant by default', () => {
      const { container } = render(<Skeleton />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton?.className).toContain('rounded-md');
    });

    it('should apply circular variant with rounded-full', () => {
      const { container } = render(<Skeleton variant="circular" />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton?.className).toContain('rounded-full');
    });

    it('should apply text variant with h-4 and rounded', () => {
      const { container } = render(<Skeleton variant="text" />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton?.className).toContain('h-4');
      expect(skeleton?.className).toContain('rounded');
    });
  });

  describe('Dimensions', () => {
    it('should accept width prop', () => {
      const { container } = render(<Skeleton width={100} />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toHaveStyle({ width: '100px' });
    });

    it('should accept height prop', () => {
      const { container } = render(<Skeleton height={50} />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toHaveStyle({ height: '50px' });
    });

    it('should accept string width', () => {
      const { container } = render(<Skeleton width="100%" />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toHaveStyle({ width: '100%' });
    });
  });

  describe('Custom className', () => {
    it('should merge custom className', () => {
      const { container } = render(<Skeleton className="custom-class" />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toHaveClass('custom-class');
    });
  });

  describe('Animation', () => {
    it('should have animate-pulse class by default', () => {
      const { container } = render(<Skeleton />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton?.className).toContain('animate-pulse');
    });

    it('should not have animate-pulse when animated is false', () => {
      const { container } = render(<Skeleton animated={false} />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton?.className).not.toContain('animate-pulse');
    });
  });
});
```

**Step 2: Run test to verify it fails**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/skeleton.test.tsx --run
```

Expected: FAIL - Skeleton component doesn't have required props/variants yet

**Step 3: Commit failing tests**

```bash
git add klard-web/src/__tests__/components/ui/skeleton.test.tsx
git commit -m "test(web): add failing tests for skeleton component"
```

---

## Task 3: Implement Web Skeleton Component

**Files:**
- Modify: `klard-web/src/components/ui/skeleton.tsx`

**Step 1: Implement the Skeleton component**

```tsx
'use client';

import * as React from 'react';
import { cn } from '@/lib/utils';

const variantMap = {
  rectangular: 'rounded-md',
  circular: 'rounded-full',
  text: 'h-4 rounded',
} as const;

export type SkeletonVariant = keyof typeof variantMap;

export interface SkeletonProps extends React.HTMLAttributes<HTMLDivElement> {
  variant?: SkeletonVariant;
  width?: number | string;
  height?: number | string;
  animated?: boolean;
}

function Skeleton({
  className,
  variant = 'rectangular',
  width,
  height,
  animated = true,
  style,
  ...props
}: SkeletonProps) {
  const dimensionStyle: React.CSSProperties = {
    ...style,
    width: typeof width === 'number' ? `${width}px` : width,
    height: typeof height === 'number' ? `${height}px` : height,
  };

  return (
    <div
      data-slot="skeleton"
      className={cn(
        'bg-slate-200 dark:bg-slate-700',
        animated && 'animate-pulse',
        variantMap[variant],
        className
      )}
      style={dimensionStyle}
      {...props}
    />
  );
}

export { Skeleton };
```

**Step 2: Run test to verify it passes**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/skeleton.test.tsx --run
```

Expected: PASS

**Step 3: Commit**

```bash
git add klard-web/src/components/ui/skeleton.tsx
git commit -m "feat(web): implement skeleton component with variants"
```

---

## Task 4: Export Web Skeleton from Index

**Files:**
- Modify: `klard-web/src/components/ui/index.ts`

**Step 1: Add export to index file**

Add the following export to `klard-web/src/components/ui/index.ts`:

```tsx
export { Skeleton, type SkeletonProps, type SkeletonVariant } from './skeleton';
```

**Step 2: Verify TypeScript compiles**

```bash
pnpm --filter klard-web exec tsc --noEmit
```

Expected: No errors

**Step 3: Commit**

```bash
git add klard-web/src/components/ui/index.ts
git commit -m "feat(web): export skeleton from ui index"
```

---

## Task 5: Write Failing Tests for Mobile Skeleton

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/Skeleton.test.tsx`

**Step 1: Write the failing tests**

```tsx
/**
 * Tests for Skeleton Component (Mobile)
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import React from 'react';
import { render, screen } from '@testing-library/react-native';
import { Skeleton } from '@/components/ui/Skeleton';

// Mock hooks
jest.mock('@/hooks', () => ({
  useThemeColors: () => ({
    muted: '#E2E8F0',
    mutedForeground: '#94A3B8',
  }),
}));

// Mock expo-linear-gradient
jest.mock('expo-linear-gradient', () => ({
  LinearGradient: 'LinearGradient',
}));

describe('Skeleton', () => {
  describe('Rendering', () => {
    it('should render skeleton container', () => {
      render(<Skeleton />);

      expect(screen.getByTestId('skeleton-container')).toBeTruthy();
    });

    it('should render shimmer element', () => {
      render(<Skeleton />);

      expect(screen.getByTestId('skeleton-shimmer')).toBeTruthy();
    });
  });

  describe('Variants', () => {
    it('should apply rectangular variant by default', () => {
      render(<Skeleton />);

      const container = screen.getByTestId('skeleton-container');
      expect(container.props.style).toMatchObject({ borderRadius: 6 });
    });

    it('should apply circular variant', () => {
      render(<Skeleton variant="circular" width={48} height={48} />);

      const container = screen.getByTestId('skeleton-container');
      // Circular should have borderRadius = width/2
      expect(container.props.style).toMatchObject({ borderRadius: 24 });
    });

    it('should apply text variant with default height', () => {
      render(<Skeleton variant="text" />);

      const container = screen.getByTestId('skeleton-container');
      expect(container.props.style).toMatchObject({ height: 16 });
    });
  });

  describe('Dimensions', () => {
    it('should accept width prop', () => {
      render(<Skeleton width={100} />);

      const container = screen.getByTestId('skeleton-container');
      expect(container.props.style).toMatchObject({ width: 100 });
    });

    it('should accept height prop', () => {
      render(<Skeleton height={50} />);

      const container = screen.getByTestId('skeleton-container');
      expect(container.props.style).toMatchObject({ height: 50 });
    });

    it('should accept percentage width as string', () => {
      render(<Skeleton width="100%" />);

      const container = screen.getByTestId('skeleton-container');
      expect(container.props.style).toMatchObject({ width: '100%' });
    });
  });

  describe('Animation', () => {
    it('should render with animation by default', () => {
      render(<Skeleton />);

      // Shimmer element should be present when animated
      expect(screen.getByTestId('skeleton-shimmer')).toBeTruthy();
    });

    it('should not render shimmer when animated is false', () => {
      render(<Skeleton animated={false} />);

      expect(screen.queryByTestId('skeleton-shimmer')).toBeNull();
    });
  });

  describe('Accessibility', () => {
    it('should have accessible role', () => {
      render(<Skeleton />);

      const container = screen.getByTestId('skeleton-container');
      expect(container.props.accessibilityRole).toBe('none');
      expect(container.props.accessibilityLabel).toBe('Loading');
    });
  });
});
```

**Step 2: Run test to verify it fails**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/Skeleton.test.tsx --run
```

Expected: FAIL - Skeleton component doesn't exist yet

**Step 3: Commit failing tests**

```bash
git add klard-mobile/src/__tests__/components/ui/Skeleton.test.tsx
git commit -m "test(mobile): add failing tests for skeleton component"
```

---

## Task 6: Create Mobile Skeleton Styles

**Files:**
- Create: `klard-mobile/src/components/ui/Skeleton/skeleton.styles.ts`

**Step 1: Create the styles file**

```tsx
import { StyleSheet } from 'react-native';

export const styles = StyleSheet.create({
  container: {
    overflow: 'hidden',
  },
  shimmer: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
  },
  gradient: {
    flex: 1,
  },
});
```

**Step 2: Commit**

```bash
mkdir -p klard-mobile/src/components/ui/Skeleton
git add klard-mobile/src/components/ui/Skeleton/skeleton.styles.ts
git commit -m "feat(mobile): add skeleton component styles"
```

---

## Task 7: Implement Mobile Skeleton Component

**Files:**
- Create: `klard-mobile/src/components/ui/Skeleton/Skeleton.tsx`

**Step 1: Implement the Skeleton component**

```tsx
import { useEffect, useRef } from 'react';
import {
  View,
  Animated,
  type StyleProp,
  type ViewStyle,
  type DimensionValue,
} from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import { useThemeColors } from '@/hooks';
import { styles } from './skeleton.styles';

export type SkeletonVariant = 'rectangular' | 'circular' | 'text';

export interface SkeletonProps {
  variant?: SkeletonVariant;
  width?: DimensionValue;
  height?: DimensionValue;
  animated?: boolean;
  style?: StyleProp<ViewStyle>;
}

export function Skeleton({
  variant = 'rectangular',
  width,
  height,
  animated = true,
  style,
}: SkeletonProps) {
  const colors = useThemeColors();
  const animatedValue = useRef(new Animated.Value(0)).current;
  const shouldAnimate = animated && process.env.NODE_ENV !== 'test';

  // Determine dimensions based on variant
  const resolvedHeight = height ?? (variant === 'text' ? 16 : undefined);
  const resolvedWidth = width;

  // Calculate border radius based on variant
  const getBorderRadius = (): number => {
    if (variant === 'circular') {
      // For circular, use half of the smaller dimension
      const dim = typeof resolvedWidth === 'number' ? resolvedWidth : 48;
      return dim / 2;
    }
    if (variant === 'text') {
      return 4;
    }
    return 6; // rectangular default
  };

  useEffect(() => {
    if (shouldAnimate) {
      Animated.loop(
        Animated.timing(animatedValue, {
          toValue: 1,
          duration: 1500,
          useNativeDriver: true,
        })
      ).start();
    }
  }, [shouldAnimate, animatedValue]);

  const containerStyle: ViewStyle = {
    backgroundColor: colors.muted,
    borderRadius: getBorderRadius(),
    width: resolvedWidth,
    height: resolvedHeight,
  };

  return (
    <View
      testID="skeleton-container"
      accessibilityRole="none"
      accessibilityLabel="Loading"
      style={[styles.container, containerStyle, style]}
    >
      {animated && (
        <Animated.View
          testID="skeleton-shimmer"
          style={[
            styles.shimmer,
            {
              transform: [
                {
                  translateX: animatedValue.interpolate({
                    inputRange: [0, 1],
                    outputRange: [-200, 200],
                  }),
                },
              ],
            },
          ]}
        >
          <LinearGradient
            colors={['transparent', 'rgba(255,255,255,0.3)', 'transparent']}
            start={{ x: 0, y: 0 }}
            end={{ x: 1, y: 0 }}
            style={styles.gradient}
          />
        </Animated.View>
      )}
    </View>
  );
}
```

**Step 2: Run test to verify it passes**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/Skeleton.test.tsx --run
```

Expected: PASS

**Step 3: Commit**

```bash
git add klard-mobile/src/components/ui/Skeleton/Skeleton.tsx
git commit -m "feat(mobile): implement skeleton component with shimmer animation"
```

---

## Task 8: Create Mobile Skeleton Index Export

**Files:**
- Create: `klard-mobile/src/components/ui/Skeleton/index.ts`

**Step 1: Create the index file**

```tsx
export { Skeleton, type SkeletonProps, type SkeletonVariant } from './Skeleton';
```

**Step 2: Commit**

```bash
git add klard-mobile/src/components/ui/Skeleton/index.ts
git commit -m "feat(mobile): add skeleton component index export"
```

---

## Task 9: Export Mobile Skeleton from UI Index

**Files:**
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Add export to index file**

Add the following export to `klard-mobile/src/components/ui/index.ts`:

```tsx
export { Skeleton, type SkeletonProps, type SkeletonVariant } from './Skeleton';
```

**Step 2: Verify TypeScript compiles**

```bash
pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No errors

**Step 3: Commit**

```bash
git add klard-mobile/src/components/ui/index.ts
git commit -m "feat(mobile): export skeleton from ui index"
```

---

## Task 10: Add Preset Skeleton Components (Web)

**Files:**
- Create: `klard-web/src/components/ui/skeleton-presets.tsx`
- Create: `klard-web/src/__tests__/components/ui/skeleton-presets.test.tsx`

**Step 1: Write failing tests for presets**

```tsx
/**
 * Tests for Skeleton Preset Components (Web)
 */

import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import {
  SubscriptionCardSkeleton,
  AvatarSkeleton,
  TextLineSkeleton,
} from '@/components/ui/skeleton-presets';

describe('Skeleton Presets', () => {
  describe('SubscriptionCardSkeleton', () => {
    it('should render subscription card skeleton structure', () => {
      const { container } = render(<SubscriptionCardSkeleton />);

      // Should have avatar skeleton (circular)
      const circular = container.querySelector('.rounded-full');
      expect(circular).toBeInTheDocument();

      // Should have multiple text skeletons
      const skeletons = container.querySelectorAll('[data-slot="skeleton"]');
      expect(skeletons.length).toBeGreaterThanOrEqual(3);
    });
  });

  describe('AvatarSkeleton', () => {
    it('should render circular skeleton with default size', () => {
      const { container } = render(<AvatarSkeleton />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toHaveClass('rounded-full');
      expect(skeleton).toHaveStyle({ width: '40px', height: '40px' });
    });

    it('should accept custom size', () => {
      const { container } = render(<AvatarSkeleton size={64} />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toHaveStyle({ width: '64px', height: '64px' });
    });
  });

  describe('TextLineSkeleton', () => {
    it('should render text line skeleton', () => {
      const { container } = render(<TextLineSkeleton />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toHaveClass('h-4');
    });

    it('should accept custom width', () => {
      const { container } = render(<TextLineSkeleton width={200} />);

      const skeleton = container.querySelector('[data-slot="skeleton"]');
      expect(skeleton).toHaveStyle({ width: '200px' });
    });
  });
});
```

**Step 2: Run test to verify it fails**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/skeleton-presets.test.tsx --run
```

Expected: FAIL

**Step 3: Implement preset components**

```tsx
'use client';

import * as React from 'react';
import { Skeleton } from './skeleton';
import { cn } from '@/lib/utils';

export interface AvatarSkeletonProps {
  size?: number;
  className?: string;
}

export function AvatarSkeleton({ size = 40, className }: AvatarSkeletonProps) {
  return (
    <Skeleton
      variant="circular"
      width={size}
      height={size}
      className={className}
    />
  );
}

export interface TextLineSkeletonProps {
  width?: number | string;
  className?: string;
}

export function TextLineSkeleton({
  width = '100%',
  className,
}: TextLineSkeletonProps) {
  return <Skeleton variant="text" width={width} className={className} />;
}

export interface SubscriptionCardSkeletonProps {
  className?: string;
}

export function SubscriptionCardSkeleton({
  className,
}: SubscriptionCardSkeletonProps) {
  return (
    <div
      className={cn(
        'flex items-center gap-4 p-4 border rounded-lg border-slate-200 dark:border-slate-700',
        className
      )}
    >
      <AvatarSkeleton size={48} />
      <div className="space-y-2 flex-1">
        <TextLineSkeleton width={128} />
        <TextLineSkeleton width={96} />
      </div>
      <Skeleton width={64} height={24} />
    </div>
  );
}
```

**Step 4: Run test to verify it passes**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/skeleton-presets.test.tsx --run
```

Expected: PASS

**Step 5: Export presets from index**

Add to `klard-web/src/components/ui/index.ts`:

```tsx
export {
  AvatarSkeleton,
  TextLineSkeleton,
  SubscriptionCardSkeleton,
  type AvatarSkeletonProps,
  type TextLineSkeletonProps,
  type SubscriptionCardSkeletonProps,
} from './skeleton-presets';
```

**Step 6: Commit**

```bash
git add klard-web/src/components/ui/skeleton-presets.tsx klard-web/src/__tests__/components/ui/skeleton-presets.test.tsx klard-web/src/components/ui/index.ts
git commit -m "feat(web): add skeleton preset components"
```

---

## Task 11: Final Verification

**Step 1: Run all skeleton tests**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/skeleton --run
pnpm --filter klard-mobile test src/__tests__/components/ui/Skeleton.test.tsx --run
```

Expected: All PASS

**Step 2: Run TypeScript check for both packages**

```bash
pnpm --filter klard-web exec tsc --noEmit
pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No errors

**Step 3: Run full lint check**

```bash
pnpm lint
```

Expected: No errors

---

## Task 12: Update Component Specification

**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md`

**Step 1: Replace IN-PROGRESS with DONE marker**

Change:
```
<!-- IN-PROGRESS:4.4-skeleton -->
```

To:
```
<!-- DONE:4.4-skeleton -->
```

**Step 2: Commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 4.4-skeleton component as done"
```

---

## Verification Checklist

- [ ] Web Skeleton renders without errors
- [ ] Web Skeleton has all variants (rectangular, circular, text)
- [ ] Web Skeleton has data-slot attribute
- [ ] Web Skeleton supports width/height props
- [ ] Web Skeleton supports animation toggle
- [ ] Web Skeleton exports from index
- [ ] Web preset components work correctly
- [ ] Mobile Skeleton renders without errors
- [ ] Mobile Skeleton has all variants
- [ ] Mobile Skeleton has shimmer animation with expo-linear-gradient
- [ ] Mobile Skeleton has testID attributes
- [ ] Mobile Skeleton has accessibility attributes
- [ ] Mobile Skeleton exports from index
- [ ] All tests pass
- [ ] TypeScript compiles without errors
- [ ] Spec marker updated to DONE