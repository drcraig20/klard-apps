# 4.2 Alert / Banner Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a reusable alert/banner component for web and mobile that surfaces inline status messages with icons, optional titles, actions, and dismiss affordances, aligned with Klard design tokens.

**Architecture:** Web: compose on the existing shadcn `Alert` primitive with CVA-driven variants for status colors, optional action/dismiss slots, and `data-slot` tagging for theming. Mobile: pure React Native/Expo component using `StyleSheet` with Klard color tokens and Ionicons, supporting action slot and dismiss button. Both expose a focused props API for type, title, content, action, and dismissal, with accessibility baked in (roles, labels, hitSlop).

**Tech Stack:** Next.js 16 (React 19), Tailwind/shadcn `Alert`, class-variance-authority, lucide-react; Expo 54 + React Native (View/Text/Pressable), @expo/vector-icons/Ionicons; Vitest + @testing-library/react + jsdom (web), Jest + @testing-library/react-native (mobile); TypeScript strict.

---

## Component Summary
- **Component:** `AlertBanner`
- **Purpose:** Prominent inline status messaging with icon, title/description, optional action slot, and optional dismissal.
- **Target Platforms:** Web (`klard-web`) and Mobile (`klard-mobile`) parity (web first).
- **Props (shared intent, platform-specific types):**
  - `type: 'success' | 'error' | 'warning' | 'info'` (required)
  - `title?: React.ReactNode`
  - `children: React.ReactNode` (description/body)
  - `action?: React.ReactNode` (cta/button/links)
  - `dismissable?: boolean` (default false)
  - `onDismiss?: () => void` (required when dismissable true)
  - `className?: string` (web), `style?: StyleProp<ViewStyle>` (mobile)
  - `icon?: React.ReactNode` (optional override; default status icon)
  - `testID?: string` (mobile testing)
- **Visual States:** default/info, success, warning, error; hover/focus ring on action/dismiss controls (web), pressed state for dismiss (mobile); loading not applicable; error/warning accent colors; high-contrast text/background pairings.
- **Size Variants:** `default` (px-4 py-3 web / padding 12x10 mobile) and `compact` (px-3 py-2 web / padding 10x8 mobile) for tighter lists.
- **Color Tokens:** Use Klard CSS vars (`--rec-color-success`, `--rec-color-warning`, `--rec-color-error`, `--rec-color-secondary` for info) with translucent backgrounds (`/10` opacity) and borders (`/35` opacity) on web; Mobile uses `Colors.light/dark` (`accentSuccess`, `accentWarning`, `accentError`, `primary`) with tinted backgrounds (`rgba(...,0.12)`) and text pulled from `foreground`/accent tokens.
- **Accessibility:** `role="alert"` and `aria-live="polite"` on web root; dismiss button `aria-label="Dismiss alert"` and keyboard focus styles; mobile uses `accessibilityRole="alert"` on container, `Pressable` with `accessibilityLabel`, `hitSlop`, and logical order for screen readers.
- **Dependencies:** Web uses `Alert`, `AlertTitle`, `AlertDescription`, `cn`, `cva`, `lucide-react` icons; Mobile uses `View`, `Text`, `Pressable`, `StyleSheet`, `Ionicons` from `@expo/vector-icons`, and `Colors` tokens.
- **SOLID Compliance**

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| AlertBanner (web) | Renders a status banner with icon/action/dismiss | Variants via CVA config; new statuses extend maps | Props allow substituting icon/action without breaking | Minimal props interface; no unused requirements | Depends on abstractions (`ReactNode`, props) and injected icon/action |
| AlertBanner (mobile) | Renders native status banner with action/dismiss | Variant style maps; extendable by adding map entries | Accepts same props contract; style overrides harmless | Segregated props; no forced unused handlers | Uses Colors/Ionicons injected via props rather than hardcoded services |

- **Parallel Sub-Agent Strategy:** Use subagent-driven-development per task: one subagent to author web tests, one for mobile tests in parallel (non-conflicting files); after each implementation step, run quick code-review/checkpoint. If subagents unavailable, emulate the same serially with explicit checkpoints.

- **Test Strategy (TDD):** 
  - Web: render/variant snapshots via class expectations, icon rendering per type, action slot presence, dismiss click triggers `onDismiss`, data-slot, aria-live/role, compact size classes.
  - Mobile: render content/title/icon per type, variant style expectations (background/text colors), action node renders, dismiss press calls handler with accessible label/hitSlop, compact size padding, allows custom icon override.

---

### Task 1: Web - Write failing tests for AlertBanner

**Files:**
- Create: `klard-web/src/__tests__/components/ui/alert-banner.test.tsx`

**Step 1: Write the failing test**
```tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { AlertBanner } from '@/components/ui/alert-banner';

describe('AlertBanner (web)', () => {
  it('renders type icon, title, and description', () => {
    render(
      <AlertBanner type="success" title="Saved">
        Settings updated
      </AlertBanner>
    );

    expect(screen.getByRole('alert')).toHaveAttribute('data-slot', 'alert-banner');
    expect(screen.getByText('Saved')).toBeInTheDocument();
    expect(screen.getByText('Settings updated')).toBeInTheDocument();
    expect(screen.getByTestId('alert-icon')).toBeInTheDocument();
  });

  it('applies variant classes for warning and compact size', () => {
    render(
      <AlertBanner type="warning" size="compact">
        Mind the change
      </AlertBanner>
    );

    const banner = screen.getByRole('alert');
    expect(banner.className).toContain('alert-warning');
    expect(banner.className).toContain('alert-compact');
  });

  it('renders action slot and dismiss button', () => {
    const onDismiss = vi.fn();
    render(
      <AlertBanner
        type="error"
        title="Failed"
        action={<button>Retry</button>}
        dismissable
        onDismiss={onDismiss}
      >
        Try again
      </AlertBanner>
    );

    expect(screen.getByRole('button', { name: 'Retry' })).toBeInTheDocument();
    const dismiss = screen.getByRole('button', { name: /dismiss alert/i });
    fireEvent.click(dismiss);
    expect(onDismiss).toHaveBeenCalledTimes(1);
  });

  it('supports custom icon override', () => {
    const customIcon = <span data-testid="custom-icon">!</span>;
    render(
      <AlertBanner type="info" icon={customIcon}>
        Info content
      </AlertBanner>
    );

    expect(screen.getByTestId('custom-icon')).toBeInTheDocument();
  });
});
```

**Step 2: Run test to verify it fails**  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-banner.test.tsx --run`  
Expected: FAIL (component not found, class expectations unmet).

**Step 3: Write minimal implementation**  
See Task 2.

**Step 4: Run test to verify it passes**  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-banner.test.tsx --run`  
Expected: PASS.

**Step 5: Commit**  
`git add klard-web/src/__tests__/components/ui/alert-banner.test.tsx`  
`git commit -m "test(web): add alert banner coverage"`

---

### Task 2: Web - Implement AlertBanner component

**Files:**
- Create: `klard-web/src/components/ui/alert-banner.tsx`
- Modify: `klard-web/src/components/ui/index.ts`

**Step 1: Write the component implementation**
```tsx
'use client';

import { AlertCircle, CheckCircle2, AlertTriangle, Info, X } from 'lucide-react';
import { cva, type VariantProps } from 'class-variance-authority';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { cn } from '@/lib/utils';

const alertBannerVariants = cva(
  'alert-base grid grid-cols-[auto_1fr_auto] gap-2 rounded-[var(--radius-default)] border px-4 py-3 data-[slot=alert-banner]',
  {
    variants: {
      type: {
        success: 'alert-success border-[color:var(--rec-color-success)]/35 bg-[color:var(--rec-color-success)]/10 text-[color:var(--rec-color-success)]',
        error: 'alert-error border-[color:var(--rec-color-error)]/35 bg-[color:var(--rec-color-error)]/10 text-[color:var(--rec-color-error)]',
        warning: 'alert-warning border-[color:var(--rec-color-warning)]/35 bg-[color:var(--rec-color-warning)]/10 text-[color:var(--rec-color-warning)]',
        info: 'alert-info border-[color:var(--rec-color-secondary)]/35 bg-[color:var(--rec-color-secondary)]/10 text-[color:var(--rec-color-secondary)]',
      },
      size: {
        default: 'alert-default',
        compact: 'alert-compact px-3 py-2 text-sm',
      },
    },
    defaultVariants: {
      type: 'info',
      size: 'default',
    },
  }
);

const icons = {
  success: CheckCircle2,
  error: AlertCircle,
  warning: AlertTriangle,
  info: Info,
} as const;

export interface AlertBannerProps
  extends React.ComponentPropsWithoutRef<'div'>,
    VariantProps<typeof alertBannerVariants> {
  title?: React.ReactNode;
  children: React.ReactNode;
  action?: React.ReactNode;
  dismissable?: boolean;
  onDismiss?: () => void;
  icon?: React.ReactNode;
}

export function AlertBanner({
  type = 'info',
  size = 'default',
  title,
  children,
  action,
  dismissable = false,
  onDismiss,
  icon,
  className,
  ...props
}: AlertBannerProps) {
  const Icon = icons[type];
  const handleDismiss = () => {
    onDismiss?.();
  };

  return (
    <Alert
      data-slot="alert-banner"
      role="alert"
      aria-live="polite"
      className={cn(alertBannerVariants({ type, size }), className)}
      {...props}
    >
      <div className="mt-0.5">
        {icon ?? <Icon data-testid="alert-icon" className="h-4 w-4" aria-hidden />}
      </div>
      <div className="space-y-1">
        {title ? <AlertTitle>{title}</AlertTitle> : null}
        <AlertDescription className="text-sm text-[color:inherit]">{children}</AlertDescription>
        {action ? <div className="mt-1">{action}</div> : null}
      </div>
      {dismissable ? (
        <button
          type="button"
          onClick={handleDismiss}
          aria-label="Dismiss alert"
          className="ml-2 inline-flex h-6 w-6 items-center justify-center rounded-full hover:bg-black/5 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[color:var(--rec-color-secondary)]"
        >
          <X className="h-4 w-4" />
        </button>
      ) : null}
    </Alert>
  );
}
```

**Step 2: Export component**
```ts
// klard-web/src/components/ui/index.ts
export { AlertBanner, type AlertBannerProps } from './alert-banner';
```

**Step 3: Run tests**
`pnpm --filter klard-web test src/__tests__/components/ui/alert-banner.test.tsx --run`

**Step 4: Commit**
`git add klard-web/src/components/ui/alert-banner.tsx klard-web/src/components/ui/index.ts`  
`git commit -m "feat(web): add alert banner component"`

---

### Task 3: Mobile - Write failing tests for AlertBanner

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/AlertBanner.test.tsx`

**Step 1: Write the failing test**
```tsx
import React from 'react';
import { render, screen, fireEvent } from '@testing-library/react-native';
import { AlertBanner } from '@/components/ui/AlertBanner';

describe('AlertBanner (mobile)', () => {
  it('renders icon, title, and description for success', () => {
    render(
      <AlertBanner type="success" title="Done">
        Completed
      </AlertBanner>
    );

    expect(screen.getByText('Done')).toBeTruthy();
    expect(screen.getByText('Completed')).toBeTruthy();
    expect(screen.getByTestId('alert-icon')).toBeTruthy();
  });

  it('applies warning style and compact padding', () => {
    const { getByTestId } = render(
      <AlertBanner type="warning" size="compact" testID="banner">
        Heads up
      </AlertBanner>
    );

    const banner = getByTestId('banner');
    const style = Array.isArray(banner.props.style) ? Object.assign({}, ...banner.props.style) : banner.props.style;
    expect(style.paddingVertical).toBeGreaterThan(6);
    expect(style.backgroundColor).toBeDefined();
  });

  it('renders action slot and dismiss control', () => {
    const onDismiss = jest.fn();
    render(
      <AlertBanner
        type="error"
        dismissable
        onDismiss={onDismiss}
        action={<></>}
      >
        Failure
      </AlertBanner>
    );

    expect(screen.getByLabelText(/dismiss alert/i)).toBeTruthy();
    fireEvent.press(screen.getByLabelText(/dismiss alert/i));
    expect(onDismiss).toHaveBeenCalledTimes(1);
  });

  it('accepts custom icon override', () => {
    const icon = <></>;
    render(
      <AlertBanner type="info" icon={icon}>
        Info
      </AlertBanner>
    );

    expect(screen.queryByTestId('alert-icon')).toBeNull();
  });
});
```

**Step 2: Run test to verify it fails**  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/AlertBanner.test.tsx --run`  
Expected: FAIL (component missing).

**Step 3: Write minimal implementation**  
See Task 4.

**Step 4: Run test to verify it passes**  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/AlertBanner.test.tsx --run`  
Expected: PASS.

**Step 5: Commit**  
`git add klard-mobile/src/__tests__/components/ui/AlertBanner.test.tsx`  
`git commit -m "test(mobile): add alert banner coverage"`

---

### Task 4: Mobile - Implement AlertBanner component

**Files:**
- Create: `klard-mobile/src/components/ui/AlertBanner.tsx`
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Write the component implementation**
```tsx
import React from 'react';
import {
  View,
  Text,
  Pressable,
  StyleSheet,
  type ViewStyle,
  type StyleProp,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { Colors } from '@/constants';

type AlertType = 'success' | 'error' | 'warning' | 'info';
type AlertSize = 'default' | 'compact';

export interface AlertBannerProps {
  type: AlertType;
  size?: AlertSize;
  title?: React.ReactNode;
  children: React.ReactNode;
  action?: React.ReactNode;
  dismissable?: boolean;
  onDismiss?: () => void;
  icon?: React.ReactNode;
  style?: StyleProp<ViewStyle>;
  testID?: string;
}

const typeIconMap: Record<AlertType, keyof typeof Ionicons.glyphMap> = {
  success: 'checkmark-circle',
  error: 'alert-circle',
  warning: 'warning',
  info: 'information-circle',
};

export function AlertBanner({
  type,
  size = 'default',
  title,
  children,
  action,
  dismissable = false,
  onDismiss,
  icon,
  style,
  testID,
}: AlertBannerProps) {
  const palette = Colors.light; // theming hook can swap later
  const base = variantStyles(type, palette);
  const padding = sizeStyles[size];

  return (
    <View
      style={[styles.container, base.container, padding, style]}
      accessibilityRole="alert"
      testID={testID}
    >
      <View style={styles.iconWrapper}>
        {icon ?? (
          <Ionicons
            testID="alert-icon"
            name={typeIconMap[type]}
            size={20}
            color={base.iconColor}
          />
        )}
      </View>
      <View style={styles.content}>
        {title ? <Text style={[styles.title, { color: base.textColor }]}>{title}</Text> : null}
        <Text style={[styles.description, { color: base.textColor }]}>{children}</Text>
        {action}
      </View>
      {dismissable ? (
        <Pressable
          accessibilityLabel="Dismiss alert"
          accessibilityRole="button"
          hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
          onPress={onDismiss}
          style={styles.dismiss}
        >
          <Ionicons name="close" size={18} color={base.iconColor} />
        </Pressable>
      ) : null}
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    borderRadius: 12,
    gap: 8,
  },
  iconWrapper: {
    paddingTop: 2,
  },
  content: {
    flex: 1,
    gap: 2,
  },
  title: {
    fontSize: 14,
    fontWeight: '600',
  },
  description: {
    fontSize: 14,
  },
  dismiss: {
    padding: 4,
    borderRadius: 9999,
    alignSelf: 'flex-start',
  },
});

const sizeStyles = StyleSheet.create({
  default: {
    paddingHorizontal: 12,
    paddingVertical: 10,
  },
  compact: {
    paddingHorizontal: 10,
    paddingVertical: 8,
  },
});

const variantStyles = (type: AlertType, palette: (typeof Colors)['light']) => {
  const map = {
    success: {
      container: { backgroundColor: 'rgba(5, 150, 105, 0.12)', borderColor: 'rgba(5, 150, 105, 0.35)', borderWidth: 1 },
      textColor: palette.accentSuccess,
      iconColor: palette.accentSuccess,
    },
    error: {
      container: { backgroundColor: 'rgba(220, 38, 38, 0.12)', borderColor: 'rgba(220, 38, 38, 0.35)', borderWidth: 1 },
      textColor: palette.accentError,
      iconColor: palette.accentError,
    },
    warning: {
      container: { backgroundColor: 'rgba(217, 119, 6, 0.12)', borderColor: 'rgba(217, 119, 6, 0.35)', borderWidth: 1 },
      textColor: palette.accentWarning,
      iconColor: palette.accentWarning,
    },
    info: {
      container: { backgroundColor: 'rgba(13, 124, 122, 0.12)', borderColor: 'rgba(13, 124, 122, 0.35)', borderWidth: 1 },
      textColor: palette.primary,
      iconColor: palette.primary,
    },
  } as const;

  return map[type];
};
```

**Step 2: Export component**
```ts
// klard-mobile/src/components/ui/index.ts
export { AlertBanner, type AlertBannerProps } from './AlertBanner';
```

**Step 3: Run tests**
`pnpm --filter klard-mobile test src/__tests__/components/ui/AlertBanner.test.tsx --run`

**Step 4: Commit**
`git add klard-mobile/src/components/ui/AlertBanner.tsx klard-mobile/src/components/ui/index.ts`  
`git commit -m "feat(mobile): add alert banner component"`

---

### Task 5: Verification and spec update

**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md` (mark DONE)

**Step 1: Verify**  
- `pnpm --filter klard-web test src/__tests__/components/ui/alert-banner.test.tsx --run`  
- `pnpm --filter klard-mobile test src/__tests__/components/ui/AlertBanner.test.tsx --run`  
- `pnpm --filter klard-web exec tsc --noEmit`  
- `pnpm --filter klard-mobile exec tsc --noEmit`

**Step 2: Update spec marker to DONE**  
Replace `<!-- IN-PROGRESS:4.2-alert-banner -->` with `<!-- DONE:4.2-alert-banner -->`.

**Step 3: Commit**  
`git add docs/screens/batch/Klard_Component_Specifications.md`  
`git commit -m "chore: mark 4.2 alert banner done"`

