# 2.4 SearchInput Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a reusable SearchInput component for web and mobile that supports debounced search, loading state, and clear action with Klard styling and accessibility.

**Architecture:** Create platform-specific UI components that consume existing input primitives (shadcn Input on web, React Native TextInput on mobile) with controlled props and debounced `onSearch` callbacks. Encapsulate icons and stateful behaviors (loading, clear) within the component while keeping data/control outside (SRP). Variants handled via class utilities on web and StyleSheet on mobile.

**Tech Stack:** Next.js 16 (App Router), React 19, shadcn/ui Input, Tailwind, lucide-react icons, class-variance-authority for styling variants if needed; React Native + Expo (TextInput, Pressable, ActivityIndicator, Ionicons); Vitest + Testing Library (web), jest-expo + React Native Testing Library (mobile).

---

## Component Outline
- **Component:** SearchInput (web: `search-input.tsx`, mobile: `SearchInput.tsx`)
- **Purpose:** Controlled search field with search icon, debounced `onSearch`, clear control, and loading indicator.
- **Target Platforms:** Web + Mobile.
- **Props (shared intent):**
  - `value: string`
  - `onChange: (value: string) => void`
  - `onSearch?: (value: string) => void`
  - `placeholder?: string` (default “Search...”)
  - `loading?: boolean`
  - `debounceMs?: number` (default 300)
- **Visual States:** default, focus (ring/border emphasis), hover (web), active (clear press), disabled (inherit from native `disabled`/`editable`), loading (spinner replaces clear), error styling not in scope (handled by parent).
- **Size Variants:** Single default size — web height 40px (`h-10`) padding `pl-10 pr-10`; mobile height 48px with 12px horizontal padding. No additional sizes (YAGNI).
- **Color Tokens:** Primary #0D7C7A / #15B5B0 for focus rings, muted foreground #94A3B8 for icons, borders using input/border tokens from shadcn base; mobile matches with placeholder `#94A3B8`, border `#CBD5E1`.
- **Accessibility:** `role="search"` wrapper, input `type="search"` (web), proper `aria-label`/`aria-live`? (spinner decorative), clear button `aria-label="Clear search"`, focus-visible rings, maintain tab order. Mobile: `accessibilityLabel`, `accessibilityRole="button"` for clear, returnKeyType="search".
- **Dependencies:** Web: `Input` component, `cn` util, `Search`, `X`, `Loader2` from lucide-react, optional `useDebounce` via `useEffect`/`setTimeout` (no extra dep). Mobile: React Native `TextInput`, `Pressable`, `ActivityIndicator`, `View`, `StyleSheet`; `Ionicons` from `@expo/vector-icons`.

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| SearchInput (web) | Renders search field UI with debounce + clear | Debounce timing configurable via prop; styling via className extension | Accepts any string value/onChange implementation | Props limited to search concerns (no unrelated behaviors) | Depends on `Input` abstraction and callbacks injected |
| SearchInput (mobile) | Same as web for RN surface | Debounce configurable; styles via StyleSheet overrides | Works with any onChange/onSearch functions and controlled value | Props focused on search; no extra interface burden | Depends on RN/Expo primitives and callbacks injected |

## Parallel Sub-Agent Strategy
- Independent tasks: web tests vs mobile tests can be staged separately; exports and spec update are small follow-ups.
- Code review checkpoints after web implementation and after mobile implementation.
- No conflicting edits across packages.

## Test Strategy (TDD)
- **Web:** Vitest + @testing-library/react with fake timers. Tests: renders with placeholder/type search; calls onChange immediately; debounced onSearch honoring `debounceMs`; clear button visible when value non-empty & not loading; clear triggers onChange('') + onSearch(''); spinner shown when `loading` true and hides clear; focus ring? (implicit via class).
- **Mobile:** jest-expo + @testing-library/react-native with fake timers. Tests: renders placeholder; calls onChangeText; debounced onSearch; clear button visibility toggles; clear triggers onChangeText('') + onSearch(''); return key submits; loading shows ActivityIndicator and hides clear.
- **Exports:** ensure component exported in `index.ts`.

## Tasks (2–5 min each)

### Task 1: Web tests for SearchInput
**Files:**
- Create: `klard-web/src/__tests__/components/ui/search-input.test.tsx`

**Step 1: Write the failing test**
```tsx
import { render, screen, fireEvent, act } from '@testing-library/react';
import { vi } from 'vitest';
import { SearchInput } from '@/components/ui/search-input';

describe('SearchInput (web)', () => {
  it('renders search input with default placeholder and type', () => {
    render(<SearchInput value="" onChange={() => {}} />);
    expect(screen.getByPlaceholderText('Search...')).toHaveAttribute('type', 'search');
  });

  it('calls onChange immediately and debounces onSearch', () => {
    vi.useFakeTimers();
    const handleChange = vi.fn();
    const handleSearch = vi.fn();
    render(<SearchInput value="" onChange={handleChange} onSearch={handleSearch} />);

    const input = screen.getByRole('searchbox');
    fireEvent.change(input, { target: { value: 'net' } });

    expect(handleChange).toHaveBeenCalledWith('net');
    expect(handleSearch).not.toHaveBeenCalled();

    act(() => vi.advanceTimersByTime(300));
    expect(handleSearch).toHaveBeenCalledWith('net');
  });

  it('shows clear button when value present and triggers clear', () => {
    const handleChange = vi.fn();
    const handleSearch = vi.fn();
    render(<SearchInput value="hi" onChange={handleChange} onSearch={handleSearch} />);

    const clear = screen.getByLabelText(/clear search/i);
    fireEvent.click(clear);

    expect(handleChange).toHaveBeenCalledWith('');
    expect(handleSearch).toHaveBeenCalledWith('');
  });

  it('shows loader when loading and hides clear', () => {
    render(<SearchInput value="loading" onChange={() => {}} loading />);
    expect(screen.getByTestId('search-loading')).toBeInTheDocument();
    expect(screen.queryByLabelText(/clear search/i)).toBeNull();
  });
});
```

**Step 2: Run test to verify it fails**  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/search-input.test.tsx --run`  
Expected: FAIL (component not found / behaviors missing).

**Step 3: Write minimal implementation**  
Implement `SearchInput` component in `klard-web/src/components/ui/search-input.tsx` with debounced `onSearch`, icons, clear button, loading spinner.

**Step 4: Run test to verify it passes**  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/search-input.test.tsx --run`  
Expected: PASS.

**Step 5: Commit**  
`git add klard-web/src/components/ui/search-input.tsx klard-web/src/__tests__/components/ui/search-input.test.tsx klard-web/src/components/ui/index.ts`  
`git commit -m "feat(web): add SearchInput component"`

### Task 2: Mobile tests for SearchInput
**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/SearchInput.test.tsx`

**Step 1: Write the failing test**
```tsx
import React from 'react';
import { render, fireEvent, act } from '@testing-library/react-native';
import { SearchInput } from '@/components/ui';
import { jest } from '@jest/globals';

jest.useFakeTimers();

describe('SearchInput (mobile)', () => {
  it('renders with default placeholder', () => {
    const { getByPlaceholderText } = render(
      <SearchInput value="" onChangeText={() => {}} />
    );
    expect(getByPlaceholderText('Search...')).toBeTruthy();
  });

  it('debounces onSearch on change', () => {
    const onChangeText = jest.fn();
    const onSearch = jest.fn();
    const { getByPlaceholderText } = render(
      <SearchInput value="" onChangeText={onChangeText} onSearch={onSearch} />
    );

    const input = getByPlaceholderText('Search...');
    fireEvent.changeText(input, 'net');

    expect(onChangeText).toHaveBeenCalledWith('net');
    expect(onSearch).not.toHaveBeenCalled();

    act(() => jest.advanceTimersByTime(300));
    expect(onSearch).toHaveBeenCalledWith('net');
  });

  it('shows clear button when value present and clears', () => {
    const onChangeText = jest.fn();
    const onSearch = jest.fn();
    const { getByLabelText } = render(
      <SearchInput value="hi" onChangeText={onChangeText} onSearch={onSearch} />
    );

    fireEvent.press(getByLabelText('Clear search'));
    expect(onChangeText).toHaveBeenCalledWith('');
    expect(onSearch).toHaveBeenCalledWith('');
  });

  it('shows loader and hides clear when loading', () => {
    const { getByTestId, queryByLabelText } = render(
      <SearchInput value="abc" loading onChangeText={() => {}} />
    );
    expect(getByTestId('search-loading')).toBeTruthy();
    expect(queryByLabelText('Clear search')).toBeNull();
  });
});
```

**Step 2: Run test to verify it fails**  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/SearchInput.test.tsx --run`  
Expected: FAIL (component missing).

**Step 3: Write minimal implementation**  
Implement `SearchInput` in `klard-mobile/src/components/ui/SearchInput.tsx` with debounced `onSearch`, clear button, loading indicator, and returnKeyType="search".

**Step 4: Run test to verify it passes**  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/SearchInput.test.tsx --run`  
Expected: PASS.

**Step 5: Commit**  
`git add klard-mobile/src/components/ui/SearchInput.tsx klard-mobile/src/__tests__/components/ui/SearchInput.test.tsx klard-mobile/src/components/ui/index.ts`  
`git commit -m "feat(mobile): add SearchInput component"`

### Task 3: Exports & cleanup
**Files:**  
- Modify: `klard-web/src/components/ui/index.ts`  
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Wire exports and ensure types**  
Add named exports for SearchInput (and prop types for mobile). Ensure `data-slot` attributes where appropriate.

**Step 2: Verify cross-package tests**  
Run: `pnpm --filter klard-web test --run` (optional scope) and `pnpm --filter klard-mobile test --run` to ensure no regressions.

**Step 3: Commit**  
`git add klard-web/src/components/ui/index.ts klard-mobile/src/components/ui/index.ts`  
`git commit -m "chore: export SearchInput components"`

---
