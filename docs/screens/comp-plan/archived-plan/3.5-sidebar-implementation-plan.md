# 3.5 Sidebar Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a web-only AppSidebar navigation using shadcn/ui sidebar primitives with collapsible/off-canvas behavior, active item styling, badges/icons, keyboard accessibility, and Klard design tokens.

**Architecture:** Implement a client-side `AppSidebar` that composes shadcn sidebar primitives (`SidebarProvider`, `Sidebar`, `SidebarContent`, `SidebarGroup*`, `SidebarMenu*`, `SidebarTrigger`). Drive navigation from a typed `items` prop. Support active highlighting, optional badges/icons, and collapsible trigger. Keep layout/styling in CVA/utility classes; no routing logic beyond `href` anchors. Export from `components/ui`. Include a small Skeleton subcomponent for loading states.

**Tech Stack:** Next.js 16 App Router (client component), React 19, shadcn/ui Sidebar primitives, Tailwind (Klard tokens), class-variance-authority (for menu button variants), lucide-react icons (already present).

---

## Component Details
- **Component:** `AppSidebar` (web)
- **Props:**
  ```ts
  interface SidebarItem {
    id: string;
    label: string;
    href: string;
    icon?: React.ReactNode;
    badge?: number | string;
  }

  interface AppSidebarProps {
    items: SidebarItem[];
    activeItem: string;
    collapsible?: 'offcanvas' | 'icon' | 'none'; // default 'offcanvas'
    header?: React.ReactNode;
    footer?: React.ReactNode;
  }
  ```
- **States/Behavior:**
  - Active item receives accent bg/text.
  - Hover/focus states with teal highlight and focus ring.
  - Badges optional (small pill).
  - Collapsible trigger via `SidebarTrigger`; provider manages state.
  - Skeleton fallback component for loading lists.
- **Visual Tokens:** `bg-sidebar`, `text-sidebar-foreground`, border `border-border`, accent `bg-primary/10`, active ring `ring-primary/50`. Spacing 12–16px; radius 12px.
- **Accessibility:** Nav landmarks (`nav` role), focus-visible outlines, `aria-current="page"` on active links, trigger is button. Keyboard tab order preserved; offcanvas should trap focus via shadcn defaults.
- **Dependencies:** Ensure `@/components/ui/sidebar` primitives exist; if absent, add via shadcn scaffold (single file). Use existing `Badge` component for counts. Use `cn` helper.

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| AppSidebar | Render nav from data + handle collapse/active styles | Extendable via items/header/footer without code changes | Works for any item set matching contract | Props limited to sidebar concerns | Depends on shadcn primitives and injected data/handlers |
| SidebarSkeleton | Display loading placeholders | Extendable by count prop | Substitutable wherever menu expected | Only uses count prop | Depends on shadcn skeleton + list props |

## Parallel Sub-Agent Strategy
- One package (klard-web) only. Tests + implementation sequential. Export wiring is trivial follow-up.

## Test Strategy (TDD)
- Vitest + @testing-library/react.
- Tests:
  1) Renders items with labels/icons/badges.
  2) Highlights active item (aria-current, class).
  3) Trigger renders and toggles data-state attribute for collapsible.
  4) Links carry href and are keyboard focusable.
  5) Skeleton renders requested count of items.

---

## Tasks (2–5 min each)

### Task 1: Web tests for AppSidebar
**Files:** Create `klard-web/src/__tests__/components/ui/sidebar.test.tsx`

**Step 1: Write the failing test**
```tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { AppSidebar } from '@/components/ui/sidebar';
import { SidebarProvider } from '@/components/ui/sidebar';
import { Home } from 'lucide-react';

const items = [
  { id: 'home', label: 'Home', href: '/home', icon: <Home aria-hidden /> },
  { id: 'billing', label: 'Billing', href: '/billing', badge: 2 },
];

describe('AppSidebar', () => {
  it('renders items with labels and badges', () => {
    render(
      <SidebarProvider>
        <AppSidebar items={items} activeItem="home" />
      </SidebarProvider>
    );

    expect(screen.getByText('Home')).toBeInTheDocument();
    expect(screen.getByText('Billing')).toBeInTheDocument();
    expect(screen.getByText('2')).toBeInTheDocument();
  });

  it('applies active state and aria-current', () => {
    render(
      <SidebarProvider>
        <AppSidebar items={items} activeItem="billing" />
      </SidebarProvider>
    );

    const billingLink = screen.getByRole('link', { name: /billing/i });
    expect(billingLink).toHaveAttribute('aria-current', 'page');
    expect(billingLink.className).toMatch(/data-state=active|active/);
  });

  it('renders trigger for collapse', () => {
    render(
      <SidebarProvider>
        <AppSidebar items={items} activeItem="home" />
      </SidebarProvider>
    );

    const trigger = screen.getByRole('button');
    fireEvent.click(trigger);
    // We expect the provider to toggle a data-state; minimal assertion: trigger exists
    expect(trigger).toBeInTheDocument();
  });

  it('renders skeleton with given count', () => {
    const { getAllByTestId } = render(
      <SidebarProvider>
        <AppSidebar.Skeleton count={3} />
      </SidebarProvider>
    );
    expect(getAllByTestId('sidebar-skeleton-item')).toHaveLength(3);
  });
});
```

**Step 2:** Run test to confirm failure  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/sidebar.test.tsx --run`  
Expected: FAIL (component absent/behaviors missing).

### Task 2: Implement AppSidebar
**Files:** Create `klard-web/src/components/ui/sidebar.tsx`

**Implementation outline:**
- `'use client'` component.
- Import shadcn sidebar primitives (SidebarProvider/Sidebar/SidebarContent/SidebarGroup/SidebarGroupLabel/SidebarGroupContent/SidebarMenu/SidebarMenuItem/SidebarMenuButton/SidebarFooter/SidebarHeader/SidebarTrigger/SidebarInset). If primitives not present, include their definitions (from shadcn template) in same file.
- Define `AppSidebar` rendering:
  - Optional `header`, `footer`.
  - `Sidebar` with `collapsible` prop (default 'offcanvas').
  - `SidebarContent` -> `SidebarGroup` -> `SidebarGroupLabel` (“Application”) -> `SidebarGroupContent` -> `SidebarMenu` mapping items.
  - Each item: `SidebarMenuItem` -> `SidebarMenuButton asChild` wrapping `<a href>` with icon/label/badge. Add `aria-current={active? 'page' : undefined}` and data-state for styling.
  - Include `SidebarFooter` rendering `footer` when provided.
  - Include `SidebarHeader` for `header` slot + `SidebarTrigger` rendered within `SidebarInset` or header.
- Styles: use `cn` to apply active classes (`data-[state=active]:bg-primary/10 data-[state=active]:text-primary`, `hover:bg-muted/70`, `focus-visible:ring-2 ring-primary`).
- Add `AppSidebar.Skeleton` rendering `count` skeleton items using `SidebarMenuSkeleton` if available; else simple div placeholders with `data-testid="sidebar-skeleton-item"`.
- Export types.

**Step 3:** Run tests to green  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/sidebar.test.tsx --run`  
Expected: PASS.

### Task 3: Export wiring
**Files:** Modify `klard-web/src/components/ui/index.ts`

**Step 1:** Add `export { AppSidebar, type AppSidebarProps, type SidebarItem } from './sidebar';`  
**Step 2:** Run regression (optional): `pnpm --filter klard-web test --run`  
**Step 3:** Update spec marker to `<!-- DONE:3.5-sidebar -->` after verification.

