# SegmentedControl Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a cross-platform SegmentedControl that provides mutually exclusive option selection with size and width variants, consistent with Klard design and accessible interactions.

**Architecture:** Web uses shadcn/ui `Tabs` primitives with CVA-driven variants for size/full-width, data-slot tagging, and icon+label layout. Mobile targets Expo segmented pickers (SwiftUI/Jetpack) with haptics and a React Native fallback, keeping a thin prop adapter for value/index mapping. State is controlled via `value`/`onChange`.

**Tech Stack:** Next.js 16 App Router, React 19, Tailwind 4 + shadcn/ui Tabs, class-variance-authority, Vitest + Testing Library (web); Expo SDK 54 with `@expo/ui/swift-ui`, `@expo/ui/jetpack-compose`, `expo-haptics`, React Native Testing Library (mobile).

---

- **Component:** SegmentedControl — mutual exclusive selection with optional icons, `sm|md` sizing, and optional full-width layout.
- **Targets:** Web (primary), Mobile (secondary; fallback RN impl). Web first per guidance.
- **Props (TS):**
  ```ts
  interface SegmentedControlOption { value: string; label: string; icon?: React.ReactNode; }
  interface SegmentedControlProps {
    value: string;
    onChange: (value: string) => void;
    options: SegmentedControlOption[];
    size?: 'sm' | 'md';
    fullWidth?: boolean;
    className?: string;
  }
  ```
- **Visual states:** default, hover (TabsTrigger hover), active (data-state=active), focus-visible ring, disabled (inherited via Tabs? none), error N/A, loading N/A. Ensure keyboard focus and aria-selected semantics from Tabs.
- **Size variants:** `md` (default) matches Tabs base height; `sm` height ~32px, tighter padding. Icon spacing 0.5rem gap.
- **Colors/tokens:** Use design tokens via tailwind: background slate-100 equivalent for list, active surface uses `bg-white text-primary` (light) with ring + shadow subtle; incorporate teal (`text-primary`) and border `border-slate-200`. Keep glassmorphism minimal to match spec snippet.
- **Accessibility:** Role + aria via Tabs primitives; ensure `data-slot="segmented-control"` on root and `data-slot="segmented-control.trigger"` on triggers; keyboard navigation via Radix default; visible focus ring.
- **Dependencies:** shadcn/ui Tabs, `cn` helper, class-variance-authority; mobile uses `@expo/ui/swift-ui`, `@expo/ui/jetpack-compose`, `expo-haptics`, React Native core fallbacks.
- **SOLID compliance:**
  | Component | SRP | OCP | LSP | ISP | DIP |
  |-----------|-----|-----|-----|-----|-----|
  | SegmentedControl (web) | Render segmented tabs only | Variants via CVA, options map | Accepts options/value/onChange substitutions | Props minimal (value/onChange/options) | Depends on abstractions (props/cva) |
  | SegmentedControl (mobile) | Bridge value→native pickers | Swap native/fallback via composition | Same props contract regardless of platform | Props minimal | Depends on injected handlers, not concrete UI |
- **Parallel sub-agent strategy:** (emulated) While writing tests/implementation, parallelize review of similar patterns from Tabs if needed; otherwise sequential due to shared files.
- **Test strategy (TDD):** Web tests first: renders options, calls onChange, applies size/fullWidth, shows icon+label, active state class, data-slot present, keyboard/aria selected via Tabs, handles empty options gracefully. Initial run expected fail, then implement. Mobile tests deferred after web (if required) verifying value propagation and haptics call guard using mocks.

### Task 1: Write failing web tests
**Files:**
- Create: `klard-web/src/__tests__/components/ui/segmented-control.test.tsx`
- Modify: none yet
- Test cmd: `pnpm --filter klard-web test src/__tests__/components/ui/segmented-control.test.tsx --run`

**Step 1: Write the failing test**
- Cover rendering options, active state class, onChange fired with option value, size variant class, fullWidth flex-1, icon+label presence, data-slot attributes.

**Step 2: Run test to verify it fails**
- Run command above; expect failure (component not found/behavior missing).

**Step 3: Write minimal implementation**
- (Not yet; in Task 2)

**Step 4: Run test to verify it passes**
- (After implementation)

**Step 5: Commit**
- (After tasks complete)

### Task 2: Implement web SegmentedControl
**Files:**
- Create: `klard-web/src/components/ui/segmented-control.tsx`
- Modify: `klard-web/src/components/ui/index.ts` (export)
- Test cmd: `pnpm --filter klard-web test src/__tests__/components/ui/segmented-control.test.tsx --run`

**Step 1: Implement minimal code to satisfy tests**
- Use Tabs/TabsList/TabsTrigger, cva for trigger sizing/fullWidth, map options, add data-slot, handle icon spacing, ensure onValueChange uses onChange.

**Step 2: Run test to verify it passes**
- Command above; expect PASS.

**Step 3: Refactor (keep green)**
- Tidy variant definitions, ensure class merging, confirm types.

**Step 4: Commit**
- (After verification)

### Task 3: Mobile placeholder/fallback tests (if required)
**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/segmented-control.test.tsx`
- Modify: `klard-mobile/src/components/ui/index.ts`
- Test cmd: `pnpm --filter klard-mobile test src/__tests__/components/ui/segmented-control.test.tsx --run`

**Step 1: Write failing test**
- Validate value->selectedIndex mapping, onChange called, haptics invoked once, fallback renders labels.

**Step 2: Run test to verify it fails**

**Step 3: Implement mobile component**
- Platform check, SwiftUI/Jetpack pickers with variant segmented, fallback Pressable list with styles.

**Step 4: Run test to verify it passes**

**Step 5: Commit**

### Task 4: Verification and spec update
**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md` (mark DONE)
- Verify cmds: `pnpm --filter klard-web test src/__tests__/components/ui/segmented-control.test.tsx --run`; `pnpm --filter klard-web exec tsc --noEmit`; (if mobile built) `pnpm --filter klard-mobile test ...`; optional `pnpm --filter klard-web lint` if configured.

**Step 1:** Run verification commands, collect outputs.
**Step 2:** Update spec marker to `<!-- DONE:2.5-segmented-control -->`.
**Step 3:** Final commit message suggestion `feat: add segmented control component`.
