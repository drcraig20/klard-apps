# 5.2 Subscription Card Implementation Plan (Merged)

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a production-ready SubscriptionCard component for both Web (Next.js + shadcn/ui) and Mobile (React Native + Expo) that displays subscription summary information including service logo, name, price, next renewal date, and status. Uses small, focused components per platform with data formatting helpers kept local to maintain SRP and OCP.

**Architecture:** Web uses shadcn Card with Avatar and Badge components, following existing patterns and CVA-style variants. Mobile uses React Native View with expo-image for service logo and native styling with style maps. Both support variants for different display contexts with clear use case mapping.

**Tech Stack:**
- Web: Next.js 16, React 19, TypeScript strict, Tailwind CSS 4, lucide-react, CVA, date-fns, Vitest + Testing Library
- Mobile: React Native, Expo SDK 54, TypeScript strict, expo-image, expo-haptics, date-fns, Jest + React Native Testing Library

---

## Pre-Implementation Checklist

Before starting, verify these skills are loaded:
- [ ] `superpowers:test-driven-development` - TDD workflow
- [ ] `superpowers:testing-anti-patterns` - Avoid common test mistakes
- [ ] `solid-design-principles` - SOLID compliance

---

## Component Specification

### Props Interface

```typescript
// Shared subscription data type (from commons or local)
interface SubscriptionData {
  id: string;
  name: string;
  logoUrl?: string;
  price: number;
  currency?: string;
  billingCycle: 'monthly' | 'quarterly' | 'yearly';
  status: 'active' | 'paused' | 'cancelled' | 'expired' | 'trial';
  nextBillingDate: Date;
  category?: string;
}

// Web Props
interface SubscriptionCardProps {
  subscription: SubscriptionData;
  variant?: 'default' | 'compact' | 'detailed';
  showActions?: boolean;
  onPress?: () => void;
  className?: string;
}

// Mobile Props
interface SubscriptionCardProps {
  subscription: SubscriptionData;
  variant?: 'default' | 'compact' | 'detailed';
  showActions?: boolean;
  onPress?: () => void;
  style?: StyleProp<ViewStyle>;
  testID?: string;
}
```

### Variant Details

| Variant | Use Case | Content |
|---------|----------|---------|
| `default` | List view items | Logo, name, price, next date, status badge |
| `compact` | Dashboard upcoming | Logo, name, date only |
| `detailed` | Detail views | Full info with category |

### Status Badge Mapping

| Status | Badge Variant | Color (Light/Dark) |
|--------|---------------|---------------------|
| `active` | success | Green (#059669 / #10B981) |
| `trial` | warning | Amber (#D97706 / #F59E0B) |
| `paused` | default | Slate |
| `cancelled` | default | Slate |
| `expired` | error | Red (#DC2626 / #EF4444) |

### Klard Design Tokens

| Token | Light | Dark | Usage |
|-------|-------|------|-------|
| Primary | #0D7C7A | #15B5B0 | Highlights, interactive |
| Background | #FFFFFF | #0F172A | Card base |
| Foreground | #0F172A | #F8FAFC | Text |
| Success | #059669 | #10B981 | Active status |
| Warning | #D97706 | #F59E0B | Trial status |
| Error | #DC2626 | #EF4444 | Expired status |

---

## SOLID Compliance

| Principle | Web Implementation | Mobile Implementation |
|-----------|-------------------|----------------------|
| **SRP** | SubscriptionCard only renders subscription summary - no data fetching. Format helpers only format price/date strings. | Render subscription summary with RN primitives. No business logic or data fetching. |
| **OCP** | Variants via props and CVA, status colors via config mapping. Data-driven props for size/status/highlight. | Style maps and props drive changes. No code changes needed for new statuses. |
| **LSP** | All subscription statuses produce valid cards. Accepts all props without stricter preconditions. | Substitutable as View/Pressable container. All statuses handled consistently. |
| **ISP** | Minimal interface with only display-related props. No extra methods. | Props only for display/interaction. Narrow interface focused on presentation. |
| **DIP** | Depends on SubscriptionData type abstraction, cn utility, and design tokens - not concrete API or data sources. | Depends on theme hook and props abstraction, not concrete stores or global state. |

---

## Investigation Findings

### Existing Components to Reuse

**Web:**
- `Avatar` from `@/components/ui/avatar` - for service logo display with fallback
- `Badge` from `@/components/ui/badge` - for status display with semantic colors
- `Card` from `@/components/ui/card` - base container with shadcn styling
- `cn` from `@/lib/utils` - class merging utility

**Mobile:**
- `Badge` from `@/components/ui/Badge` - for status display
- `expo-image` - for service logo with caching and blurhash placeholders

### Pattern References

From existing `Avatar` component:
- Size mapping with explicit pixel values
- Fallback handling for missing images
- `data-slot` attribute for styling hooks

From existing `Badge` component:
- CVA for variant system
- Consistent color mapping per variant
- Size variants (sm, default, lg)

---

## Dependencies

### Web
- `lucide-react` - Icons (already installed)
- `@/lib/utils` - cn utility (already exists)
- `date-fns` - Date formatting (already installed)
- `class-variance-authority` - CVA for variants (already installed)

### Mobile
- `expo-image` - Service logo display with caching
- `expo-haptics` - Press feedback
- `date-fns` - Date formatting

---

# PART 1: WEB IMPLEMENTATION

## Task 1: Write Failing Tests for SubscriptionCard Rendering

**Files:**
- Create: `klard-web/src/__tests__/components/ui/subscription-card.test.tsx`

**Step 1: Create test file with basic rendering tests**

```tsx
/**
 * Tests for SubscriptionCard Component
 *
 * TDD: Write failing tests first, then implement to pass.
 * Tests verify: rendering, variants, status badges, interactions, accessibility
 */

import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { SubscriptionCard } from '@/components/ui/subscription-card';

const mockSubscription = {
  id: '1',
  name: 'Netflix',
  logoUrl: 'https://example.com/netflix.png',
  price: 15.99,
  currency: 'USD',
  billingCycle: 'monthly' as const,
  status: 'active' as const,
  nextBillingDate: new Date('2025-01-15'),
  category: 'streaming',
};

describe('SubscriptionCard', () => {
  describe('Rendering', () => {
    it('should render the subscription name', () => {
      render(<SubscriptionCard subscription={mockSubscription} />);

      expect(screen.getByText('Netflix')).toBeInTheDocument();
    });

    it('should render the price with currency', () => {
      render(<SubscriptionCard subscription={mockSubscription} />);

      expect(screen.getByText(/\$15\.99/)).toBeInTheDocument();
    });

    it('should render the billing cycle', () => {
      render(<SubscriptionCard subscription={mockSubscription} />);

      expect(screen.getByText(/\/mo/i)).toBeInTheDocument();
    });

    it('should have data-slot attribute', () => {
      render(<SubscriptionCard subscription={mockSubscription} />);

      const card = screen.getByText('Netflix').closest('[data-slot="subscription-card"]');
      expect(card).toBeInTheDocument();
    });
  });
});
```

**Step 2: Run tests to verify they fail**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps
pnpm --filter klard-web test src/__tests__/components/ui/subscription-card.test.tsx --run
```

Expected: FAIL - SubscriptionCard component doesn't exist

---

## Task 2: Write Failing Tests for Status Badge

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/subscription-card.test.tsx`

**Step 1: Add status badge tests**

```tsx
  describe('Status Badge', () => {
    it('should render active status with success variant', () => {
      render(<SubscriptionCard subscription={{ ...mockSubscription, status: 'active' }} />);

      const badge = screen.getByText('Active');
      expect(badge).toBeInTheDocument();
      expect(badge.className).toMatch(/green|success/i);
    });

    it('should render trial status with warning variant', () => {
      render(<SubscriptionCard subscription={{ ...mockSubscription, status: 'trial' }} />);

      const badge = screen.getByText('Trial');
      expect(badge).toBeInTheDocument();
      expect(badge.className).toMatch(/amber|warning/i);
    });

    it('should render cancelled status with default variant', () => {
      render(<SubscriptionCard subscription={{ ...mockSubscription, status: 'cancelled' }} />);

      const badge = screen.getByText('Cancelled');
      expect(badge).toBeInTheDocument();
    });

    it('should render expired status with error variant', () => {
      render(<SubscriptionCard subscription={{ ...mockSubscription, status: 'expired' }} />);

      const badge = screen.getByText('Expired');
      expect(badge).toBeInTheDocument();
      expect(badge.className).toMatch(/red|error/i);
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/subscription-card.test.tsx --run
```

Expected: FAIL - Status badge not implemented

---

## Task 3: Write Failing Tests for Variants

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/subscription-card.test.tsx`

**Step 1: Add variant tests**

```tsx
  describe('Variants', () => {
    it('should render default variant with all information', () => {
      render(<SubscriptionCard subscription={mockSubscription} variant="default" />);

      expect(screen.getByText('Netflix')).toBeInTheDocument();
      expect(screen.getByText(/\$15\.99/)).toBeInTheDocument();
      expect(screen.getByText('Active')).toBeInTheDocument();
    });

    it('should render compact variant with minimal information', () => {
      render(<SubscriptionCard subscription={mockSubscription} variant="compact" />);

      expect(screen.getByText('Netflix')).toBeInTheDocument();
      // Compact should not show status badge
      expect(screen.queryByText('Active')).not.toBeInTheDocument();
    });

    it('should render detailed variant with category', () => {
      render(<SubscriptionCard subscription={mockSubscription} variant="detailed" />);

      expect(screen.getByText('Netflix')).toBeInTheDocument();
      expect(screen.getByText('streaming')).toBeInTheDocument();
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/subscription-card.test.tsx --run
```

Expected: FAIL - Variants not implemented

---

## Task 4: Write Failing Tests for Service Logo and Interactions

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/subscription-card.test.tsx`

**Step 1: Add service logo and interaction tests**

```tsx
  describe('Service Logo', () => {
    it('should render service logo when logoUrl provided', () => {
      render(<SubscriptionCard subscription={mockSubscription} />);

      const logo = screen.getByRole('img', { name: /netflix/i });
      expect(logo).toBeInTheDocument();
    });

    it('should render fallback initial when no logoUrl', () => {
      render(<SubscriptionCard subscription={{ ...mockSubscription, logoUrl: undefined }} />);

      expect(screen.getByText('N')).toBeInTheDocument();
    });
  });

  describe('Interactions', () => {
    it('should call onPress when card is clicked', () => {
      const handlePress = vi.fn();
      render(<SubscriptionCard subscription={mockSubscription} onPress={handlePress} />);

      const card = screen.getByText('Netflix').closest('[data-slot="subscription-card"]');
      fireEvent.click(card!);

      expect(handlePress).toHaveBeenCalledTimes(1);
    });

    it('should not be clickable when onPress is not provided', () => {
      render(<SubscriptionCard subscription={mockSubscription} />);

      const card = screen.getByText('Netflix').closest('[data-slot="subscription-card"]');
      expect(card?.tagName.toLowerCase()).not.toBe('button');
    });

    it('should have correct cursor style when clickable', () => {
      render(<SubscriptionCard subscription={mockSubscription} onPress={() => {}} />);

      const card = screen.getByText('Netflix').closest('[data-slot="subscription-card"]');
      expect(card?.className).toContain('cursor-pointer');
    });
  });

  describe('Custom className', () => {
    it('should merge custom className with default classes', () => {
      render(<SubscriptionCard subscription={mockSubscription} className="custom-class" />);

      const card = screen.getByText('Netflix').closest('[data-slot="subscription-card"]');
      expect(card?.className).toContain('custom-class');
    });
  });

  describe('Accessibility', () => {
    it('should have accessible role when clickable', () => {
      render(<SubscriptionCard subscription={mockSubscription} onPress={() => {}} />);

      const card = screen.getByRole('button');
      expect(card).toBeInTheDocument();
    });

    it('should have aria-label with subscription info', () => {
      render(<SubscriptionCard subscription={mockSubscription} onPress={() => {}} />);

      const card = screen.getByRole('button');
      expect(card.getAttribute('aria-label')).toContain('Netflix');
    });
  });
```

**Step 2: Run all tests to verify they fail**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/subscription-card.test.tsx --run
```

Expected: Multiple FAIL

---

## Task 5: Implement SubscriptionCard Component

**Files:**
- Create: `klard-web/src/components/ui/subscription-card.tsx`

**Step 1: Create the SubscriptionCard component**

```tsx
'use client';

import * as React from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { format } from 'date-fns';

import { cn } from '@/lib/utils';
import { Avatar } from './avatar';
import { Badge } from './badge';

const subscriptionCardVariants = cva(
  'flex items-center gap-4 rounded-xl border bg-card p-4 transition-colors',
  {
    variants: {
      variant: {
        default: '',
        compact: 'p-3',
        detailed: 'p-5',
      },
      interactive: {
        true: 'cursor-pointer hover:bg-accent/50 hover:border-primary/30',
        false: '',
      },
    },
    defaultVariants: {
      variant: 'default',
      interactive: false,
    },
  }
);

const statusConfig = {
  active: { label: 'Active', variant: 'success' as const },
  trial: { label: 'Trial', variant: 'warning' as const },
  paused: { label: 'Paused', variant: 'default' as const },
  cancelled: { label: 'Cancelled', variant: 'default' as const },
  expired: { label: 'Expired', variant: 'error' as const },
};

const billingCycleLabels = {
  monthly: '/mo',
  quarterly: '/qtr',
  yearly: '/yr',
};

export interface SubscriptionData {
  id: string;
  name: string;
  logoUrl?: string;
  price: number;
  currency?: string;
  billingCycle: 'monthly' | 'quarterly' | 'yearly';
  status: 'active' | 'paused' | 'cancelled' | 'expired' | 'trial';
  nextBillingDate: Date;
  category?: string;
}

export interface SubscriptionCardProps
  extends VariantProps<typeof subscriptionCardVariants> {
  subscription: SubscriptionData;
  showActions?: boolean;
  onPress?: () => void;
  className?: string;
}

function SubscriptionCard({
  subscription,
  variant = 'default',
  showActions = false,
  onPress,
  className,
}: SubscriptionCardProps) {
  const {
    name,
    logoUrl,
    price,
    currency = 'USD',
    billingCycle,
    status,
    nextBillingDate,
    category,
  } = subscription;

  const statusInfo = statusConfig[status];
  const isInteractive = Boolean(onPress);
  const isCompact = variant === 'compact';
  const isDetailed = variant === 'detailed';

  const formattedPrice = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency,
  }).format(price);

  const formattedDate = format(new Date(nextBillingDate), 'MMM d');

  const Wrapper = isInteractive ? 'button' : 'div';

  return (
    <Wrapper
      data-slot="subscription-card"
      className={cn(
        subscriptionCardVariants({ variant, interactive: isInteractive }),
        className
      )}
      onClick={onPress}
      {...(isInteractive && {
        type: 'button',
        role: 'button',
        'aria-label': `${name} subscription, ${formattedPrice} ${billingCycleLabels[billingCycle]}`,
      })}
    >
      {/* Service Logo */}
      <Avatar
        src={logoUrl}
        alt={name}
        fallback={name.charAt(0).toUpperCase()}
        size={isCompact ? 'sm' : 'md'}
        shape="circle"
      />

      {/* Content */}
      <div className="flex flex-1 flex-col gap-1 text-left">
        <div className="flex items-center gap-2">
          <span className="font-medium text-foreground">{name}</span>
          {!isCompact && (
            <Badge variant={statusInfo.variant} size="sm">
              {statusInfo.label}
            </Badge>
          )}
        </div>

        {isDetailed && category && (
          <span className="text-xs capitalize text-muted-foreground">
            {category}
          </span>
        )}

        <span className="text-sm text-muted-foreground">
          {isCompact ? (
            formattedDate
          ) : (
            <>Next: {formattedDate}</>
          )}
        </span>
      </div>

      {/* Price */}
      {!isCompact && (
        <div className="text-right">
          <span className="font-semibold text-foreground">{formattedPrice}</span>
          <span className="text-sm text-muted-foreground">
            {billingCycleLabels[billingCycle]}
          </span>
        </div>
      )}
    </Wrapper>
  );
}

export { SubscriptionCard, subscriptionCardVariants };
```

**Step 2: Run tests to verify they pass**

```bash
pnpm --filter klard-web test src/__tests__/components/ui/subscription-card.test.tsx --run
```

Expected: All tests PASS

**Step 3: Commit Web tests and implementation**

```bash
git add klard-web/src/components/ui/subscription-card.tsx klard-web/src/__tests__/components/ui/subscription-card.test.tsx
git commit -m "feat(web): add SubscriptionCard component with TDD

- Add SubscriptionCard component with default/compact/detailed variants
- Support status badges with semantic colors
- Include Avatar with fallback for service logo
- Interactive press handling with accessibility
- Comprehensive test coverage with grouped test suites"
```

---

## Task 6: Export SubscriptionCard from Index

**Files:**
- Modify: `klard-web/src/components/ui/index.ts`

**Step 1: Add SubscriptionCard export**

Add this line to the exports:

```typescript
export {
  SubscriptionCard,
  subscriptionCardVariants,
  type SubscriptionCardProps,
  type SubscriptionData,
} from './subscription-card';
```

**Step 2: Verify TypeScript compiles**

```bash
pnpm --filter klard-web exec tsc --noEmit
```

Expected: No TypeScript errors

**Step 3: Commit export**

```bash
git add klard-web/src/components/ui/index.ts
git commit -m "feat(web): export SubscriptionCard from ui index"
```

---

# PART 2: MOBILE IMPLEMENTATION

## Task 7: Write Failing Tests for Mobile SubscriptionCard Rendering

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/SubscriptionCard.test.tsx`

**Step 1: Create test file with rendering tests**

```tsx
/**
 * Tests for SubscriptionCard Component (Mobile)
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react-native';
import { SubscriptionCard } from '@/components/ui/SubscriptionCard';
import * as Haptics from 'expo-haptics';

// Mock expo-haptics
jest.mock('expo-haptics', () => ({
  impactAsync: jest.fn(),
  ImpactFeedbackStyle: {
    Light: 'light',
    Medium: 'medium',
  },
}));

// Mock expo-image
jest.mock('expo-image', () => {
  const React = require('react');
  const { View, Text } = require('react-native');
  return {
    Image: ({ source, accessibilityLabel, testID, onError }: any) => (
      <View testID={testID || 'expo-image'} accessibilityLabel={accessibilityLabel}>
        <Text>{source}</Text>
      </View>
    ),
  };
});

const mockSubscription = {
  id: '1',
  name: 'Netflix',
  logoUrl: 'https://example.com/netflix.png',
  price: 15.99,
  currency: 'USD',
  billingCycle: 'monthly' as const,
  status: 'active' as const,
  nextBillingDate: new Date('2025-01-15'),
  category: 'streaming',
};

describe('SubscriptionCard', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe('Rendering', () => {
    it('should render the subscription name', () => {
      render(<SubscriptionCard subscription={mockSubscription} testID="card" />);

      expect(screen.getByText('Netflix')).toBeTruthy();
    });

    it('should render the price with currency', () => {
      render(<SubscriptionCard subscription={mockSubscription} />);

      expect(screen.getByText(/\$15\.99/)).toBeTruthy();
    });

    it('should render the billing cycle label', () => {
      render(<SubscriptionCard subscription={mockSubscription} />);

      expect(screen.getByText(/\/mo/)).toBeTruthy();
    });

    it('should have correct testID', () => {
      render(<SubscriptionCard subscription={mockSubscription} testID="subscription-card" />);

      expect(screen.getByTestId('subscription-card')).toBeTruthy();
    });
  });
});
```

**Step 2: Run tests to verify they fail**

```bash
cd /Users/drcraig/Desktop/PersonalProjects/klard-apps
pnpm --filter klard-mobile test src/__tests__/components/ui/SubscriptionCard.test.tsx --run
```

Expected: FAIL - SubscriptionCard component doesn't exist

---

## Task 8: Write Failing Tests for Mobile Status Badge and Variants

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/SubscriptionCard.test.tsx`

**Step 1: Add status badge and variant tests**

```tsx
  describe('Status Badge', () => {
    it('should render active status badge', () => {
      render(<SubscriptionCard subscription={{ ...mockSubscription, status: 'active' }} />);

      expect(screen.getByText('Active')).toBeTruthy();
    });

    it('should render trial status badge', () => {
      render(<SubscriptionCard subscription={{ ...mockSubscription, status: 'trial' }} />);

      expect(screen.getByText('Trial')).toBeTruthy();
    });

    it('should render expired status badge', () => {
      render(<SubscriptionCard subscription={{ ...mockSubscription, status: 'expired' }} />);

      expect(screen.getByText('Expired')).toBeTruthy();
    });
  });

  describe('Variants', () => {
    it('should render default variant with status badge', () => {
      render(<SubscriptionCard subscription={mockSubscription} variant="default" />);

      expect(screen.getByText('Active')).toBeTruthy();
      expect(screen.getByText(/\$15\.99/)).toBeTruthy();
    });

    it('should render compact variant without status badge', () => {
      render(<SubscriptionCard subscription={mockSubscription} variant="compact" />);

      expect(screen.getByText('Netflix')).toBeTruthy();
      expect(screen.queryByText('Active')).toBeNull();
    });

    it('should render detailed variant with category', () => {
      render(<SubscriptionCard subscription={mockSubscription} variant="detailed" />);

      expect(screen.getByText('streaming')).toBeTruthy();
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/SubscriptionCard.test.tsx --run
```

Expected: FAIL - Status and variants not implemented

---

## Task 9: Write Failing Tests for Mobile Interactions

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/SubscriptionCard.test.tsx`

**Step 1: Add interaction tests**

```tsx
  describe('Interactions', () => {
    it('should call onPress when card is pressed', async () => {
      const handlePress = jest.fn();
      render(
        <SubscriptionCard
          subscription={mockSubscription}
          onPress={handlePress}
          testID="card"
        />
      );

      fireEvent.press(screen.getByTestId('card'));

      await waitFor(() => {
        expect(handlePress).toHaveBeenCalledTimes(1);
      });
    });

    it('should trigger haptic feedback when pressed', async () => {
      const handlePress = jest.fn();
      render(
        <SubscriptionCard
          subscription={mockSubscription}
          onPress={handlePress}
          testID="card"
        />
      );

      fireEvent.press(screen.getByTestId('card'));

      await waitFor(() => {
        expect(Haptics.impactAsync).toHaveBeenCalledWith(
          Haptics.ImpactFeedbackStyle.Light
        );
      });
    });
  });

  describe('Service Logo', () => {
    it('should render fallback initial when no logoUrl', () => {
      render(
        <SubscriptionCard
          subscription={{ ...mockSubscription, logoUrl: undefined }}
        />
      );

      expect(screen.getByText('N')).toBeTruthy();
    });
  });
```

**Step 2: Run tests to verify they fail**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/SubscriptionCard.test.tsx --run
```

Expected: FAIL - Interactions not implemented

---

## Task 10: Implement Mobile SubscriptionCard Component

**Files:**
- Create: `klard-mobile/src/components/ui/SubscriptionCard.tsx`

**Step 1: Create the SubscriptionCard component**

```tsx
import React, { useState } from 'react';
import {
  View,
  Text,
  Pressable,
  StyleSheet,
  type ViewStyle,
  type StyleProp,
} from 'react-native';
import { Image } from 'expo-image';
import * as Haptics from 'expo-haptics';
import { format } from 'date-fns';

import { Badge } from './Badge';

const statusConfig = {
  active: { label: 'Active', variant: 'success' as const },
  trial: { label: 'Trial', variant: 'warning' as const },
  paused: { label: 'Paused', variant: 'default' as const },
  cancelled: { label: 'Cancelled', variant: 'default' as const },
  expired: { label: 'Expired', variant: 'error' as const },
};

const billingCycleLabels = {
  monthly: '/mo',
  quarterly: '/qtr',
  yearly: '/yr',
};

export interface SubscriptionData {
  id: string;
  name: string;
  logoUrl?: string;
  price: number;
  currency?: string;
  billingCycle: 'monthly' | 'quarterly' | 'yearly';
  status: 'active' | 'paused' | 'cancelled' | 'expired' | 'trial';
  nextBillingDate: Date;
  category?: string;
}

export interface SubscriptionCardProps {
  subscription: SubscriptionData;
  variant?: 'default' | 'compact' | 'detailed';
  showActions?: boolean;
  onPress?: () => void;
  style?: StyleProp<ViewStyle>;
  testID?: string;
}

export function SubscriptionCard({
  subscription,
  variant = 'default',
  showActions = false,
  onPress,
  style,
  testID,
}: SubscriptionCardProps) {
  const [logoError, setLogoError] = useState(false);

  const {
    name,
    logoUrl,
    price,
    currency = 'USD',
    billingCycle,
    status,
    nextBillingDate,
    category,
  } = subscription;

  const statusInfo = statusConfig[status];
  const isCompact = variant === 'compact';
  const isDetailed = variant === 'detailed';

  const formattedPrice = new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency,
  }).format(price);

  const formattedDate = format(new Date(nextBillingDate), 'MMM d');

  const handlePress = async () => {
    if (onPress) {
      await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
      onPress();
    }
  };

  const logoSize = isCompact ? 32 : 40;
  const blurhash = 'L6PZfSi_.AyE_3t7t7R**0o#DgR4';

  const content = (
    <>
      {/* Service Logo */}
      <View style={[styles.logoContainer, { width: logoSize, height: logoSize }]}>
        {logoUrl && !logoError ? (
          <Image
            source={logoUrl}
            style={[styles.logo, { width: logoSize, height: logoSize }]}
            contentFit="cover"
            placeholder={{ blurhash }}
            transition={200}
            onError={() => setLogoError(true)}
            accessibilityLabel={`${name} logo`}
          />
        ) : (
          <View style={[styles.logoFallback, { width: logoSize, height: logoSize }]}>
            <Text style={styles.logoFallbackText}>
              {name.charAt(0).toUpperCase()}
            </Text>
          </View>
        )}
      </View>

      {/* Content */}
      <View style={styles.content}>
        <View style={styles.nameRow}>
          <Text style={styles.name} numberOfLines={1}>
            {name}
          </Text>
          {!isCompact && (
            <Badge variant={statusInfo.variant} size="sm">
              {statusInfo.label}
            </Badge>
          )}
        </View>

        {isDetailed && category && (
          <Text style={styles.category}>{category}</Text>
        )}

        <Text style={styles.date}>
          {isCompact ? formattedDate : `Next: ${formattedDate}`}
        </Text>
      </View>

      {/* Price */}
      {!isCompact && (
        <View style={styles.priceContainer}>
          <Text style={styles.price}>{formattedPrice}</Text>
          <Text style={styles.cycle}>{billingCycleLabels[billingCycle]}</Text>
        </View>
      )}
    </>
  );

  if (onPress) {
    return (
      <Pressable
        onPress={handlePress}
        style={({ pressed }) => [
          styles.card,
          isCompact && styles.cardCompact,
          isDetailed && styles.cardDetailed,
          pressed && styles.cardPressed,
          style,
        ]}
        testID={testID}
        accessibilityRole="button"
        accessibilityLabel={`${name} subscription, ${formattedPrice} ${billingCycleLabels[billingCycle]}`}
      >
        {content}
      </Pressable>
    );
  }

  return (
    <View
      style={[
        styles.card,
        isCompact && styles.cardCompact,
        isDetailed && styles.cardDetailed,
        style,
      ]}
      testID={testID}
    >
      {content}
    </View>
  );
}

const styles = StyleSheet.create({
  card: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 16,
    padding: 16,
    backgroundColor: '#FFFFFF',
    borderRadius: 12,
    borderWidth: 1,
    borderColor: '#E2E8F0',
  },
  cardCompact: {
    padding: 12,
    gap: 12,
  },
  cardDetailed: {
    padding: 20,
  },
  cardPressed: {
    backgroundColor: '#F8FAFC',
    borderColor: 'rgba(13, 124, 122, 0.3)',
  },
  logoContainer: {
    borderRadius: 9999,
    overflow: 'hidden',
  },
  logo: {
    borderRadius: 9999,
  },
  logoFallback: {
    backgroundColor: '#CCFBF1',
    borderRadius: 9999,
    alignItems: 'center',
    justifyContent: 'center',
  },
  logoFallbackText: {
    color: '#0D7C7A',
    fontWeight: '600',
    fontSize: 16,
  },
  content: {
    flex: 1,
    gap: 4,
  },
  nameRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  name: {
    fontSize: 16,
    fontWeight: '500',
    color: '#0F172A',
  },
  category: {
    fontSize: 12,
    color: '#64748B',
    textTransform: 'capitalize',
  },
  date: {
    fontSize: 14,
    color: '#64748B',
  },
  priceContainer: {
    alignItems: 'flex-end',
  },
  price: {
    fontSize: 16,
    fontWeight: '600',
    color: '#0F172A',
  },
  cycle: {
    fontSize: 14,
    color: '#64748B',
  },
});
```

**Step 2: Run tests to verify they pass**

```bash
pnpm --filter klard-mobile test src/__tests__/components/ui/SubscriptionCard.test.tsx --run
```

Expected: All tests PASS

**Step 3: Commit Mobile tests and implementation**

```bash
git add klard-mobile/src/components/ui/SubscriptionCard.tsx klard-mobile/src/__tests__/components/ui/SubscriptionCard.test.tsx
git commit -m "feat(mobile): add SubscriptionCard component with TDD

- Add SubscriptionCard component with default/compact/detailed variants
- Support status badges with semantic colors
- Include expo-image service logo with fallback
- Haptic feedback on press
- Comprehensive test coverage with grouped test suites"
```

---

## Task 11: Export Mobile SubscriptionCard from Index

**Files:**
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Add SubscriptionCard export**

Add this line to the exports:

```typescript
export {
  SubscriptionCard,
  type SubscriptionCardProps,
  type SubscriptionData,
} from './SubscriptionCard';
```

**Step 2: Verify TypeScript compiles**

```bash
pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No TypeScript errors

**Step 3: Commit export**

```bash
git add klard-mobile/src/components/ui/index.ts
git commit -m "feat(mobile): export SubscriptionCard from ui index"
```

---

# PART 3: VERIFICATION & COMPLETION

## Task 12: Run Full Test Suite

**Step 1: Run all web tests**

```bash
pnpm --filter klard-web test --run
```

Expected: All tests PASS

**Step 2: Run all mobile tests**

```bash
pnpm --filter klard-mobile test --run
```

Expected: All tests PASS

**Step 3: Run TypeScript check on both**

```bash
pnpm --filter klard-web exec tsc --noEmit && pnpm --filter klard-mobile exec tsc --noEmit
```

Expected: No TypeScript errors

---

## Task 13: Verification Checklist

Complete this checklist before marking component as DONE:

**Web SubscriptionCard:**
- [ ] Component renders without errors
- [ ] All 3 variants functional (default, compact, detailed)
- [ ] Status badges display correct colors per mapping
- [ ] Service logo with Avatar component works
- [ ] Fallback initial displays when no logoUrl
- [ ] onPress interaction functional
- [ ] Custom className merges correctly
- [ ] data-slot attribute present on root
- [ ] Accessibility: role="button" when interactive
- [ ] Accessibility: aria-label includes subscription info
- [ ] TypeScript compiles with no errors
- [ ] All tests passing (rendering, status, variants, logo, interactions, a11y)
- [ ] Exported from index.ts
- [ ] CVA variants working correctly
- [ ] date-fns formatting works

**Mobile SubscriptionCard:**
- [ ] Component renders without errors
- [ ] All 3 variants functional (default, compact, detailed)
- [ ] Status badges display correct colors per mapping
- [ ] expo-image logo with blurhash placeholder works
- [ ] Fallback initial displays when no logoUrl
- [ ] Logo error handling sets logoError state
- [ ] Haptic feedback triggers on press
- [ ] Pressable vs View conditional rendering works
- [ ] TypeScript compiles with no errors
- [ ] All tests passing (rendering, status, variants, logo, interactions, haptics)
- [ ] Exported from index.ts
- [ ] date-fns formatting works
- [ ] accessibilityRole="button" when interactive
- [ ] accessibilityLabel includes subscription info

---

## Task 14: Mark Component as DONE

**Files:**
- Modify: `docs/screens/batch/Klard_Component_Specifications.md`

**Step 1: Update spec marker**

Replace:
```
<!-- IN-PROGRESS:5.2-subscription-card -->
```

With:
```
<!-- DONE:5.2-subscription-card -->
```

**Step 2: Final commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 5.2-subscription-card component as DONE"
```

---

## Summary

| Task | Platform | Description |
|------|----------|-------------|
| 1 | Web | Write failing tests: Rendering |
| 2 | Web | Write failing tests: Status Badge |
| 3 | Web | Write failing tests: Variants |
| 4 | Web | Write failing tests: Logo & Interactions |
| 5 | Web | Implement SubscriptionCard component (GREEN phase) |
| 6 | Web | Export from index.ts |
| 7 | Mobile | Write failing tests: Rendering |
| 8 | Mobile | Write failing tests: Status & Variants |
| 9 | Mobile | Write failing tests: Interactions & Logo |
| 10 | Mobile | Implement SubscriptionCard component (GREEN phase) |
| 11 | Mobile | Export from index.ts |
| 12 | Both | Run full test suite |
| 13 | Both | Verification checklist (30+ items) |
| 14 | Docs | Mark component as DONE |

**Total Tasks:** 14
**Estimated Time:** 45-60 minutes

---

## File Structure

### Web
```
klard-web/src/
├── components/ui/
│   ├── subscription-card.tsx  # New component
│   └── index.ts               # Export added
└── __tests__/components/ui/
    └── subscription-card.test.tsx  # Test file
```

### Mobile
```
klard-mobile/src/
├── components/ui/
│   ├── SubscriptionCard.tsx   # New component
│   └── index.ts               # Export added
└── __tests__/components/ui/
    └── SubscriptionCard.test.tsx  # Test file
```

---

## Execution Options

**Plan complete and saved to `docs/screens/comp-plan/5.2-subscription-card-implementation-plan-merged.md`.**

**Two execution options:**

1. **Subagent-Driven (this session)** - Use `superpowers:subagent-driven-development` to dispatch fresh subagent per task, review between tasks, fast iteration

2. **Parallel Session (separate)** - Use `superpowers:executing-plans` in new session, batch execution with checkpoints

**Which approach?**