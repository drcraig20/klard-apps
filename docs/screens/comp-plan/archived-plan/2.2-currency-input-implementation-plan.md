# 2.2 Currency Input Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Deliver a reusable CurrencyInput for web and mobile that formats numeric values with a currency symbol, clamps to optional min/max, surfaces validation via FormField, and stays accessible and variantable.

**Architecture:** Web: client component wrapping shadcn `Input` and `FormField`, with `cva` size variants and small parsing/formatting helpers. Mobile: React Native `TextInput` inside `FormField`, using sanitized parsing and fixed two-decimal formatting. Shared contract keeps props aligned across platforms; no external dependencies added.

**Tech Stack:** Next.js 16 + React 19 + shadcn/ui Input + Tailwind 4 + class-variance-authority, React Native/Expo 54 TextInput, Testing Library (web), jest-expo + RNTL (mobile), TypeScript strict.

---

- **Component:** `CurrencyInput` – controlled numeric input with currency adornment and validation messaging.
- **Platforms:** Web + Mobile.
- **Props (shared intent):**
  ```ts
  interface CurrencyInputProps {
    value: number;
    onChange: (value: number) => void;
    currency?: string; // default 'USD'
    label?: string;
    error?: string;
    helperText?: string;
    min?: number;
    max?: number;
    disabled?: boolean;
    required?: boolean;
    id?: string;        // web label association
    className?: string; // web container/input merge
  }
  ```
- **States:** default, focus/hover (web), disabled, error, helper, required indicator, min/max clamped, empty shows `0.00`.
- **Size variants (web via cva):** `sm` h-9 text-sm px-3, `md` h-10 text-base px-3.5 (default), `lg` h-11 text-base px-4; left padding adjusts for symbol (e.g., pl-9/10/11).
- **Color tokens:** Border `border-input`, focus ring `ring-ring/50`, text `text-slate-700` / `dark:text-slate-200`, muted `text-slate-500`, error `text-red-500`, background `bg-transparent` / `dark:bg-input/30`.
- **Accessibility:** data-slot on container/input; label `htmlFor` tied to `id`; `aria-invalid` when error; `aria-describedby` linking error/helper; `inputMode="decimal"` and `pattern="[0-9]*[.,]?[0-9]*"` (web); `keyboardType="decimal-pad"` (mobile); currency symbol is text, not aria-hidden.
- **Dependencies:** Web: `Input`, `FormField`, `cva`, `cn`. Mobile: `FormField`, `TextInput`, `StyleSheet`, `useMemo`. No new packages.
- **SOLID Compliance:**
  | Component | SRP | OCP | LSP | ISP | DIP |
  |-----------|-----|-----|-----|-----|-----|
  | CurrencyInput (web) | Render currency field & emit numeric changes | Extend via props/variants without edits | Accept any numeric + currency string | Focused prop surface | Depends on abstractions/helpers |
  | CurrencyInput (mobile) | Same | Style via StyleSheet tweaks | Substitute with same props | Props only, no extra methods | Uses injected props/helpers |
  | format/parsing helpers | Number↔string only | Extend formats without UI change | Pure functions reusable | Tiny API | No UI deps |

- **Parallel sub-agent strategy:** Web and mobile tasks are independent; run sequentially here with reviews between tasks (subagent-driven-development pattern).
- **Test strategy (TDD):** Write failing tests first per platform: rendering, symbol display, two-decimal formatting, sanitizing/parsing, min/max clamp, onChange numeric emission, error/aria wiring, size variant class presence (web), disabled handling.

### Task 1: Web CurrencyInput tests
**Files:**
- Create: `klard-web/src/__tests__/components/ui/currency-input.test.tsx`

**Step 1: Write the failing test**
```tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { CurrencyInput } from '@/components/ui/currency-input';

describe('CurrencyInput (web)', () => {
  it('renders label, symbol, and formats to two decimals', () => {
    render(<CurrencyInput label="Amount" value={12} onChange={vi.fn()} currency="EUR" />);
    expect(screen.getByText('Amount')).toBeInTheDocument();
    expect(screen.getByText('EUR')).toBeInTheDocument();
    expect(screen.getByRole('textbox')).toHaveValue('12.00');
  });

  it('sanitizes input and calls onChange with numeric value', () => {
    const handleChange = vi.fn();
    render(<CurrencyInput value={0} onChange={handleChange} />);
    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: '$19.5a' } });
    expect(handleChange).toHaveBeenCalledWith(19.5);
  });

  it('clamps to min/max', () => {
    const handleChange = vi.fn();
    render(<CurrencyInput value={0} onChange={handleChange} min={10} max={20} />);
    const input = screen.getByRole('textbox');
    fireEvent.change(input, { target: { value: '2' } });
    expect(handleChange).toHaveBeenCalledWith(10);
    fireEvent.change(input, { target: { value: '99' } });
    expect(handleChange).toHaveBeenCalledWith(20);
  });

  it('applies error aria wiring and styles', () => {
    render(<CurrencyInput value={5} onChange={vi.fn()} error="Required" helperText="Helper" />);
    const input = screen.getByRole('textbox');
    expect(input).toHaveAttribute('aria-invalid', 'true');
    const error = screen.getByRole('alert');
    expect(error).toHaveTextContent('Required');
    expect(input.getAttribute('aria-describedby')).toContain(error.id);
    expect(screen.queryByText('Helper')).toBeNull();
  });

  it('supports size variants', () => {
    render(<CurrencyInput value={1} onChange={vi.fn()} size="lg" />);
    const input = screen.getByRole('textbox');
    expect(input.className).toMatch(/h-11/);
  });

  it('disables input when disabled is true', () => {
    render(<CurrencyInput value={1} onChange={vi.fn()} disabled />);
    expect(screen.getByRole('textbox')).toBeDisabled();
  });
});
```

**Step 2: Run test to verify it fails**
- Run: `pnpm --filter klard-web test src/__tests__/components/ui/currency-input.test.tsx --run`
- Expected: FAIL (component not implemented/exported).

### Task 2: Web CurrencyInput implementation
**Files:**
- Create: `klard-web/src/components/ui/currency-input.tsx`
- Modify: `klard-web/src/components/ui/index.ts`

**Step 3: Write minimal implementation**
- Client component using `Input`, `FormField`; `cva` for size classes/padding; helpers for `formatValue` (two decimals) and `parseAndClamp` (strip non-numeric except dot, apply min/max); `data-slot="currency-input"`; `aria-invalid` & `aria-describedby`; `inputMode="decimal"`; respect `disabled`; default currency symbol `$` when currency is USD else code.

**Step 4: Run test to verify it passes**
- Run: `pnpm --filter klard-web test src/__tests__/components/ui/currency-input.test.tsx --run`
- Expected: PASS.

### Task 3: Mobile CurrencyInput tests
**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/CurrencyInput.test.tsx`

**Step 1: Write the failing test**
```tsx
import { render, fireEvent } from '@testing-library/react-native';
import { CurrencyInput } from '@/components/ui/CurrencyInput';

describe('CurrencyInput (mobile)', () => {
  it('renders label, symbol, and formats value', () => {
    const { getByText, getByDisplayValue } = render(
      <CurrencyInput label="Amount" value={12} onChange={jest.fn()} currency="USD" />
    );
    expect(getByText('Amount')).toBeTruthy();
    expect(getByText('$')).toBeTruthy();
    expect(getByDisplayValue('12.00')).toBeTruthy();
  });

  it('parses sanitized text and emits numeric value', () => {
    const handleChange = jest.fn();
    const { getByDisplayValue } = render(<CurrencyInput value={0} onChange={handleChange} />);
    const input = getByDisplayValue('0.00');
    fireEvent.changeText(input, '$19.5a');
    expect(handleChange).toHaveBeenCalledWith(19.5);
  });

  it('clamps to min/max', () => {
    const handleChange = jest.fn();
    const { getByDisplayValue } = render(
      <CurrencyInput value={0} onChange={handleChange} min={10} max={20} />
    );
    const input = getByDisplayValue('0.00');
    fireEvent.changeText(input, '2');
    expect(handleChange).toHaveBeenCalledWith(10);
    fireEvent.changeText(input, '99');
    expect(handleChange).toHaveBeenCalledWith(20);
  });

  it('shows error and hides helper when error present', () => {
    const { getByText, queryByText } = render(
      <CurrencyInput value={1} onChange={jest.fn()} error="Required" helperText="Helper" />
    );
    expect(getByText('Required')).toBeTruthy();
    expect(queryByText('Helper')).toBeNull();
  });

  it('respects disabled state', () => {
    const { getByDisplayValue } = render(<CurrencyInput value={1} onChange={jest.fn()} disabled />);
    const input = getByDisplayValue('1.00');
    expect(input.props.editable).toBe(false);
  });
});
```

**Step 2: Run test to verify it fails**
- Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/CurrencyInput.test.tsx --run`
- Expected: FAIL (component missing).

### Task 4: Mobile CurrencyInput implementation
**Files:**
- Create: `klard-mobile/src/components/ui/CurrencyInput.tsx`
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 3: Write minimal implementation**
- Functional component wrapping `FormField`; `TextInput` with `keyboardType="decimal-pad"` and `inputMode="decimal"` if supported; helpers to format to two decimals, sanitize input, and clamp min/max; symbol text at left inside a row with spacing; respects `disabled` via `editable` and opacity style; includes `accessibilityLabel`/`accessibilityState` for error/disabled.

**Step 4: Run test to verify it passes**
- Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/CurrencyInput.test.tsx --run`
- Expected: PASS.

**Step 5: Commit**
- `git add` new components, tests, and index exports.
- Commit message suggestion: `feat: add currency input component for web and mobile`
