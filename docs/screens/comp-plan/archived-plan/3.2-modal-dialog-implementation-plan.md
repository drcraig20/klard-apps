# 3.2 Modal / Dialog Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Provide a reusable Modal/Dialog for web and mobile with controllable open state, sized content, optional header/description/footer, overlay behavior, and close handling consistent with Klard design and accessibility standards.

**Architecture:** Web will wrap shadcn/ui Dialog primitives with size variants, close-on-overlay toggle, and footer slot while keeping content presentation within children. Mobile will compose React Native `Modal` (or platform-appropriate overlay) with keyboard-safe layout, safe area padding, overlay tap-to-close (configurable), and optional footer slot. Logic (open state, handlers) is injected; components remain purely presentational.

**Tech Stack:** Next.js 16 + React 19 + shadcn/ui Dialog + Tailwind; class-variance-authority for size classes if helpful. Mobile: React Native/Expo 54 (`Modal`, `Pressable`, `KeyboardAvoidingView`, `Platform`, `SafeAreaInsets`) with `Ionicons` for close icon. Tests: Vitest + Testing Library (web), jest-expo + React Native Testing Library (mobile).

---

## Component Outline
- **Component:** Modal (web + mobile)
- **Purpose:** Focused overlay for user interactions with controlled open/close and size.
- **Platforms:** Web and Mobile.
- **Props (shared intent):**
  - `open: boolean`
  - `onClose: () => void`
  - `title?: string`
  - `description?: string`
  - `size?: 'sm' | 'md' | 'lg' | 'xl' | 'full'` (default `md`)
  - `children: ReactNode`
  - `footer?: ReactNode`
  - `closeOnOverlay?: boolean` (default true)
  - Web: `className?`; Mobile: `style?`, `testID?`
- **Visual States:** open/closed; focus trapping handled by shadcn Dialog; overlay click-block when `closeOnOverlay=false`; press feedback on close button. Sizes map to max-widths on web; mobile uses full-width sheet-ish container with size optional? (YAGNI: single width, height auto).
- **Size Values:** Web sizes map to `max-w-sm/md/lg/xl/4xl`; Mobile uses fixed padding and max height with scroll if necessary (use `maxHeight: '80%'`).
- **Color Tokens:** Web uses `bg-card`, `text-foreground`, `border-border`, focus rings via dialog defaults; Mobile uses `#0F172A` overlay with opacity 0.5, surface `#FFFFFF` (light-first) with border/shadow, icon color `#64748B`.
- **Accessibility:** Web: relies on Dialog semantics; ensure `aria-describedby`/`aria-labelledby` via shadcn components; overlay closes only when allowed. Mobile: `accessibilityRole="button"` for close, `onRequestClose` wired to `onClose`, support hardware back.
- **Dependencies:** Web: shadcn `Dialog*`, `cn`, optional `cva`. Mobile: `Modal`, `Pressable`, `View`, `Text`, `KeyboardAvoidingView`, `Platform`, `useSafeAreaInsets`, `Ionicons`.

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| Modal (web) | Renders dialog shell with sizing and close behavior | Sizes configurable via data map; overlay behavior via prop | Accepts any children/footer/title | Props limited to modal concerns | Depends on shadcn Dialog + injected handlers |
| Modal (mobile) | Presents overlay shell with keyboard/safe area handling | Overlay closing and sizes configurable | Works with any content/onClose | Props focused on modal usage | Depends on RN/Expo primitives + injected handlers |

## Parallel Sub-Agent Strategy
- Web tests/implementation independent of mobile; can execute sequentially with review checkpoints.
- Export wiring and spec DONE update as final task.

## Test Strategy (TDD)
- **Web (Vitest + RTL):** renders when open; titles/descriptions appear; footer slot renders; size applies correct class; overlay click respects `closeOnOverlay` (prevents close when false); `onClose` invoked when dialog closes; `DialogContent` role `dialog`.
- **Mobile (jest-expo + RNTL):** renders children when open; overlay press triggers `onClose` when allowed; title/description render; close button press triggers `onClose`; `onRequestClose` fires; content respects safe area padding; size max-height constraint present.

## Tasks (2â€“5 min each)

### Task 1: Web tests for Modal
**Files:**
- Create: `klard-web/src/__tests__/components/ui/modal.test.tsx`

**Step 1: Write the failing test**
```tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { vi } from 'vitest';
import { Modal } from '@/components/ui/modal';

describe('Modal (web)', () => {
  it('renders title and description when open', () => {
    render(
      <Modal open onClose={() => {}} title="Title" description="Desc">
        <div>Body</div>
      </Modal>
    );
    expect(screen.getByRole('dialog')).toBeInTheDocument();
    expect(screen.getByText('Title')).toBeInTheDocument();
    expect(screen.getByText('Desc')).toBeInTheDocument();
    expect(screen.getByText('Body')).toBeInTheDocument();
  });

  it('applies size class', () => {
    render(
      <Modal open size="lg" onClose={() => {}}>
        content
      </Modal>
    );
    const dialog = screen.getByRole('dialog');
    expect(dialog.className).toMatch(/max-w-lg/);
  });

  it('calls onClose when overlay clicked and closeOnOverlay true', () => {
    const onClose = vi.fn();
    render(
      <Modal open onClose={onClose} closeOnOverlay>
        content
      </Modal>
    );
    fireEvent.pointerDown(document.body); // fallback if portal? use dialog content parent
    fireEvent.pointerUp(document.body);
    // fallback assertion: closing triggers onClose via onOpenChange(false)
    expect(onClose).toHaveBeenCalledTimes(1);
  });

  it('does not close when closeOnOverlay is false', () => {
    const onClose = vi.fn();
    render(
      <Modal open onClose={onClose} closeOnOverlay={false}>
        content
      </Modal>
    );
    // simulate outside interaction
    fireEvent.mouseDown(document.body);
    fireEvent.mouseUp(document.body);
    expect(onClose).not.toHaveBeenCalled();
  });
});
```

**Step 2: Run test to verify it fails**  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/modal.test.tsx --run`  
Expected: FAIL (Modal missing).

**Step 3: Write minimal implementation**  
Create `klard-web/src/components/ui/modal.tsx` wrapping shadcn Dialog with size map, `onOpenChange`, optional overlay prevention, header/footer slots.

**Step 4: Run test to verify it passes**  
Run: `pnpm --filter klard-web test src/__tests__/components/ui/modal.test.tsx --run`  
Expected: PASS.

**Step 5: Commit**  
`git add klard-web/src/components/ui/modal.tsx klard-web/src/__tests__/components/ui/modal.test.tsx klard-web/src/components/ui/index.ts`  
`git commit -m "feat(web): add Modal component"`

### Task 2: Mobile tests for Modal
**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/Modal.test.tsx`

**Step 1: Write the failing test**
```tsx
import React from 'react';
import { render, fireEvent } from '@testing-library/react-native';
import { Modal } from '@/components/ui';
import { jest } from '@jest/globals';

describe('Modal (mobile)', () => {
  it('renders content when open', () => {
    const { getByText } = render(
      <Modal open onClose={() => {}} title="Title" description="Desc">
        <></>
        <div />
        <></>
        <div />
        <div />
        <div />
        <div />
        <div />
        <div />
        <div />
      </Modal>
    );
    expect(getByText('Title')).toBeTruthy();
    expect(getByText('Desc')).toBeTruthy();
  });

  it('invokes onClose on overlay press when allowed', () => {
    const onClose = jest.fn();
    const { getByTestId } = render(
      <Modal open onClose={onClose} closeOnOverlay>
        <></>
      </Modal>
    );
    fireEvent.press(getByTestId('modal-overlay'));
    expect(onClose).toHaveBeenCalled();
  });

  it('close button triggers onClose', () => {
    const onClose = jest.fn();
    const { getByLabelText } = render(
      <Modal open onClose={onClose} title="Title">
        <></>
      </Modal>
    );
    fireEvent.press(getByLabelText('Close modal'));
    expect(onClose).toHaveBeenCalled();
  });
});
```

**Step 2: Run test to verify it fails**  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/Modal.test.tsx --run`  
Expected: FAIL (Modal missing).

**Step 3: Write minimal implementation**  
Add `klard-mobile/src/components/ui/Modal.tsx` using RN `Modal`, overlay pressable, safe area padding, header/description/footer slots, close button with Ionicons.

**Step 4: Run test to verify it passes**  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/Modal.test.tsx --run`  
Expected: PASS.

**Step 5: Commit**  
`git add klard-mobile/src/components/ui/Modal.tsx klard-mobile/src/__tests__/components/ui/Modal.test.tsx klard-mobile/src/components/ui/index.ts`  
`git commit -m "feat(mobile): add Modal component"`

### Task 3: Export & finalize
**Files:**  
- Modify: `klard-web/src/components/ui/index.ts`  
- Modify: `klard-mobile/src/components/ui/index.ts`  

**Step 1:** Add exports for Modal component/types.  
**Step 2:** Run scoped tests (web + mobile) to confirm no regressions.  
**Step 3:** Mark spec `<!-- DONE:3.2-modal-dialog -->`.

