# 3.3 BottomSheet Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Provide a controlled BottomSheet component for mobile that supports open/close, configurable snap points, optional drag-to-close, safe-area-aware content padding, and a consistent overlay/backdrop experience aligned with Klard design.

**Architecture:** Use a dual-path approach. On iOS, prefer the native SwiftUI BottomSheet from `@expo/ui/swift-ui` for smoother system UX. For cross-platform behavior (Android + fallback), wrap `@gorhom/bottom-sheet` with a controlled ref syncing `open` prop to sheet state and emitting `onClose` when dismissed. Keep the component presentation-only; state is managed by parent. Content renders inside a padded container respecting safe areas. Overlay/backdrop uses the library’s backdrop with our opacity and can be tapped to close.

**Tech Stack:** React Native + Expo 54, `@expo/ui/swift-ui` (BottomSheet), `@gorhom/bottom-sheet` (new dependency), React Native Gesture Handler & Reanimated (already via Expo), `react-native-safe-area-context`, TypeScript, jest-expo + React Native Testing Library.

---

## Component Details
- **Component:** `BottomSheet` (mobile only)
- **Props Interface:**
  ```ts
  export interface BottomSheetProps {
    open: boolean;
    onClose: () => void;
    snapPoints?: Array<string | number>; // defaults: ['50%']
    children: React.ReactNode;
    enableDrag?: boolean; // defaults: true
  }
  ```
- **Behavior:**
  - Sync `open` to sheet ref: `expand()` when true, `close()` when false.
  - When sheet reports closed (`onClose`/`onChange` to index -1), invoke `onClose`.
  - Backdrop tap closes (uses `enablePanDownToClose` + backdrop component).
  - `enableDrag=false` disables pan-to-close (set `enablePanDownToClose={false}`).
  - Safe area bottom inset added to content padding.
- **Visual/Interaction States:** open vs closed; dragging; backdrop visible; disabled drag. Handle indicator shown; subtle shadow on container. Overlay opacity ~0.5 (`#0F172A` at 50%).
- **Sizing:** Snap points controlled via prop; default `['50%']`. Container rounded top radius 16px.
- **Accessibility:** `onRequestClose` wired for Android back; backdrop press closes; content accessible; testID on backdrop (`modal-overlay`) and container (`bottom-sheet`).
- **Dependencies:** Install `@gorhom/bottom-sheet` via pnpm (peer deps satisfied by Expo). Use `@expo/ui/swift-ui` BottomSheet on iOS when available.
- **Out of Scope:** Web implementation; haptic feedback; scrolling behavior inside sheet (left to children).

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| BottomSheet (mobile) | Present bottom sheet UI and sync open/close | Behavior extended via snapPoints/enableDrag props; no code change needed | Works with any children and handlers; same contract when swapped | Props only for sheet concerns; no unrelated config | Depends on abstracted sheet libs and injected callbacks |

## Parallel Sub-Agent Strategy
- Dependency install is isolated (no conflicting edits).
- Tests and implementation can proceed sequentially; no cross-package work.
- Export wiring is a small follow-up task.

## Test Strategy (TDD)
- jest-expo + RNTL.
- Mock `@gorhom/bottom-sheet` to avoid native bindings; expose a minimal mock that captures props.
- Tests to cover:
  1) Renders children when `open=true`.
  2) Calls `expand` on open toggle; calls `close` on close toggle.
  3) Invokes `onClose` when transitioning from open to closed (simulated ref close).
  4) Passes `enablePanDownToClose=false` when `enableDrag=false`.
  5) Passes snapPoints prop through.
  6) Backdrop testID present for overlay interactions.

---

## Tasks (2–5 minutes each)

### Task 1: Install dependency
**Files:** `pnpm-lock.yaml`, `klard-mobile/package.json` (generated by pnpm)  
**Step 1:** Install `@gorhom/bottom-sheet`.  
Run: `pnpm --filter klard-mobile add @gorhom/bottom-sheet`  
Expected: package added to `dependencies`.

### Task 2: Write failing tests for BottomSheet
**Files:** Create `klard-mobile/src/__tests__/components/ui/BottomSheet.test.tsx`

**Step 1: Test code**
```tsx
import React from 'react';
import { render, act } from '@testing-library/react-native';
import { BottomSheet } from '@/components/ui';
import { jest } from '@jest/globals';

const expandMock = jest.fn();
const closeMock = jest.fn();

jest.mock('@gorhom/bottom-sheet', () => {
  const React = require('react');
  return {
    __esModule: true,
    default: React.forwardRef((props: any, ref) => {
      React.useImperativeHandle(ref, () => ({
        expand: expandMock,
        close: closeMock,
      }));
      return <>{props.children}</>;
    }),
    BottomSheetBackdrop: (props: any) => <props.appearsOnIndex testID="modal-overlay" />,
    BottomSheetView: ({ children }: any) => <>{children}</>,
  };
});

describe('BottomSheet (mobile)', () => {
  beforeEach(() => {
    expandMock.mockClear();
    closeMock.mockClear();
  });

  it('renders children when open', () => {
    const { getByText } = render(
      <BottomSheet open onClose={() => {}}>
        <></>
        <></>
      </BottomSheet>
    );
    // Provide a child text for assertion
  });

  it('expands when open becomes true and closes when false', () => {
    const onClose = jest.fn();
    const { rerender } = render(<BottomSheet open={false} onClose={onClose} />);
    rerender(<BottomSheet open onClose={onClose} />);
    expect(expandMock).toHaveBeenCalled();
    rerender(<BottomSheet open={false} onClose={onClose} />);
    expect(closeMock).toHaveBeenCalled();
  });

  it('invokes onClose when sheet reports closed', () => {
    const onClose = jest.fn();
    const { rerender } = render(<BottomSheet open onClose={onClose} />);
    rerender(<BottomSheet open={false} onClose={onClose} />);
    expect(onClose).toHaveBeenCalled();
  });

  it('sets enablePanDownToClose=false when enableDrag=false', () => {
    render(<BottomSheet open enableDrag={false} onClose={() => {}} />);
    // Assertion will be on props captured by mock; placeholder here
  });

  it('passes snapPoints through', () => {
    const snaps = ['25%', '60%'];
    render(<BottomSheet open snapPoints={snaps} onClose={() => {}} />);
    // Assertion placeholder to verify prop forwarded in mock
  });
});
```
(Add concrete child text and prop capture in implementation to assert snapPoints/enablePanDownToClose.)

**Step 2:** Run to see failures  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/BottomSheet.test.tsx --run`  
Expected: FAIL (component not found/behavior missing).

### Task 3: Implement BottomSheet
**Files:** Create `klard-mobile/src/components/ui/BottomSheet.tsx`; Modify `klard-mobile/src/components/ui/index.ts`

**Implementation outline:**
- Imports: React, `useEffect`, `useMemo`, `useRef`; `Platform`; `View`, `StyleSheet`; `Modal`? Not needed for gorhom; `useSafeAreaInsets`; `BottomSheet` default, `BottomSheetBackdrop`, `BottomSheetView` from `@gorhom/bottom-sheet`; `BottomSheet as SwiftUIBottomSheet` from `@expo/ui/swift-ui` (lazy optional import? fallback to gorhom on other platforms).
- Behavior:
  - `const sheetRef = useRef<BottomSheetType>(null);`
  - `useEffect` watch `open`: call `expand()` when true; `close()` when false.
  - `const snaps = useMemo(() => snapPoints ?? ['50%'], [snapPoints]);`
  - `const handleChange = (index: number) => { if (index === -1) onClose(); };`
  - `const handleClose = () => onClose();`
  - iOS path: render `<SwiftUIBottomSheet isOpen={open} onDismiss={onClose}>{content}</SwiftUIBottomSheet>` with padding `paddingBottom: insets.bottom + 16`.
  - Default path: render `<BottomSheet ref={sheetRef} index={open ? 0 : -1} snapPoints={snaps} enablePanDownToClose={enableDrag !== false} onClose={handleClose} onChange={handleChange} backdropComponent={(props) => <BottomSheetBackdrop {...props} disappearsOnIndex={-1} appearsOnIndex={0} testID="modal-overlay" />} handleIndicatorStyle={styles.indicator}> <BottomSheetView style={[styles.content, { paddingBottom: insets.bottom + 16 }]} testID="bottom-sheet">{children}</BottomSheetView></BottomSheet>`
- Styles: `content` padding 16, background `#FFFFFF`, borderRadius 16; `indicator` background `#CBD5E1`; shadow for Android; `backdrop` color from library.

**Step 4:** Re-run tests  
Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/BottomSheet.test.tsx --run`  
Expected: PASS.

### Task 4: Export & finalize
**Files:** Modify `klard-mobile/src/components/ui/index.ts`

**Step 1:** Add `export { BottomSheet, type BottomSheetProps } from './BottomSheet';`  
**Step 2:** Run regression suite (optional): `pnpm --filter klard-mobile test --run`  
**Step 3:** Update spec marker to `<!-- DONE:3.3-bottom-sheet -->` after verification.

