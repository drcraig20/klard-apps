# FormField Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a wrapper component for consistent form field layout across Web and Mobile platforms.

**Architecture:** FormField is a composition wrapper that provides consistent label, required indicator, error message, and helper text for any form input children. It delegates input rendering to children, maintaining single responsibility.

**Tech Stack:**
- Web: React 19, TypeScript, Tailwind CSS, shadcn/ui Label
- Mobile: React Native, Expo 54, StyleSheet

---

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| FormField (Web) | Wraps form inputs with consistent layout | Extensible via children prop | N/A (functional) | Single FormFieldProps interface | Depends on Label abstraction |
| FormField (Mobile) | Wraps form inputs with consistent layout | Extensible via children prop | N/A (functional) | Single FormFieldProps interface | Pure functional, no external deps |

### Principle Applications

**SRP:** Single component handles label + error + helper text layout only - input rendering delegated to children
**OCP:** Extensible via children - any input type can be wrapped without modifying FormField
**LSP:** N/A - functional component, no inheritance
**ISP:** Small focused interface with only 5 props
**DIP:** Depends on Label abstraction, not concrete input types

---

## Parallel Sub-Agent Strategy

Tasks 1-2 (tests) can run in parallel since they're for different platforms.
Tasks 3-4 (implementations) depend on their respective tests.
Tasks 5-6 (exports + verification) run sequentially.

---

## Test Strategy (TDD)

For each platform:
1. Write failing tests first covering all props and visual states
2. Verify tests fail for the expected reason
3. Implement minimal code to pass
4. Refactor while keeping tests green

---

### Task 1: Web FormField Tests (RED)

**Files:**
- Create: `klard-web/src/__tests__/components/ui/form-field.test.tsx`

**Step 1: Write the failing test**

```tsx
/**
 * Tests for FormField Component
 *
 * These tests verify:
 * 1. Renders children correctly
 * 2. Shows label when provided
 * 3. Shows required asterisk when required=true
 * 4. Shows error message when error prop is set
 * 5. Shows helper text when helperText prop is set (no error)
 * 6. Hides helper text when error is present
 * 7. Accessibility: label has htmlFor, error has role="alert"
 */

import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { FormField } from '@/components/ui/form-field';

describe('FormField', () => {
  describe('Rendering', () => {
    it('should render children', () => {
      render(
        <FormField>
          <input data-testid="child-input" />
        </FormField>
      );

      expect(screen.getByTestId('child-input')).toBeTruthy();
    });

    it('should have data-slot attribute', () => {
      render(
        <FormField>
          <input />
        </FormField>
      );

      const container = screen.getByTestId('form-field');
      expect(container.getAttribute('data-slot')).toBe('form-field');
    });
  });

  describe('Label', () => {
    it('should render label when provided', () => {
      render(
        <FormField label="Email Address">
          <input />
        </FormField>
      );

      expect(screen.getByText('Email Address')).toBeTruthy();
    });

    it('should not render label when not provided', () => {
      render(
        <FormField>
          <input />
        </FormField>
      );

      expect(screen.queryByRole('label')).toBeNull();
    });

    it('should associate label with input via id', () => {
      render(
        <FormField label="Email" id="email-field">
          <input id="email-field" />
        </FormField>
      );

      const label = screen.getByText('Email');
      expect(label.getAttribute('for')).toBe('email-field');
    });
  });

  describe('Required Indicator', () => {
    it('should show asterisk when required is true', () => {
      render(
        <FormField label="Email" required>
          <input />
        </FormField>
      );

      expect(screen.getByText('*')).toBeTruthy();
    });

    it('should not show asterisk when required is false', () => {
      render(
        <FormField label="Email" required={false}>
          <input />
        </FormField>
      );

      expect(screen.queryByText('*')).toBeNull();
    });

    it('should have aria-hidden on asterisk', () => {
      render(
        <FormField label="Email" required>
          <input />
        </FormField>
      );

      const asterisk = screen.getByText('*');
      expect(asterisk.getAttribute('aria-hidden')).toBe('true');
    });
  });

  describe('Error Message', () => {
    it('should display error message when error prop is set', () => {
      render(
        <FormField error="This field is required">
          <input />
        </FormField>
      );

      expect(screen.getByText('This field is required')).toBeTruthy();
    });

    it('should have role="alert" on error message', () => {
      render(
        <FormField error="Invalid email">
          <input />
        </FormField>
      );

      const error = screen.getByRole('alert');
      expect(error.textContent).toBe('Invalid email');
    });

    it('should not display error when not provided', () => {
      render(
        <FormField>
          <input />
        </FormField>
      );

      expect(screen.queryByRole('alert')).toBeNull();
    });

    it('should apply error styling (red text)', () => {
      render(
        <FormField error="Error message">
          <input />
        </FormField>
      );

      const error = screen.getByRole('alert');
      expect(error.className).toContain('text-red-500');
    });
  });

  describe('Helper Text', () => {
    it('should display helper text when provided', () => {
      render(
        <FormField helperText="Enter your email address">
          <input />
        </FormField>
      );

      expect(screen.getByText('Enter your email address')).toBeTruthy();
    });

    it('should hide helper text when error is present', () => {
      render(
        <FormField helperText="Helper" error="Error">
          <input />
        </FormField>
      );

      expect(screen.queryByText('Helper')).toBeNull();
      expect(screen.getByText('Error')).toBeTruthy();
    });

    it('should apply muted styling to helper text', () => {
      render(
        <FormField helperText="Helper text">
          <input />
        </FormField>
      );

      const helper = screen.getByText('Helper text');
      expect(helper.className).toContain('text-slate-500');
    });
  });

  describe('Custom className', () => {
    it('should merge custom className with default classes', () => {
      render(
        <FormField className="custom-class">
          <input />
        </FormField>
      );

      const container = screen.getByTestId('form-field');
      expect(container.className).toContain('custom-class');
      expect(container.className).toContain('space-y-2');
    });
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/form-field.test.tsx --run`
Expected: FAIL with "Cannot find module '@/components/ui/form-field'"

---

### Task 2: Mobile FormField Tests (RED)

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/FormField.test.tsx`

**Step 1: Write the failing test**

```tsx
/**
 * Tests for FormField Component (Mobile)
 *
 * These tests verify:
 * 1. Renders children correctly
 * 2. Shows label when provided
 * 3. Shows required asterisk when required=true
 * 4. Shows error message when error prop is set
 * 5. Shows helper text when helperText prop is set (no error)
 * 6. Hides helper text when error is present
 * 7. Proper accessibility attributes
 */

import React from 'react';
import { render } from '@testing-library/react-native';
import { Text, TextInput } from 'react-native';
import { FormField } from '@/components/ui/FormField';

describe('FormField', () => {
  describe('Rendering', () => {
    it('should render children', () => {
      const { getByTestId } = render(
        <FormField>
          <TextInput testID="child-input" />
        </FormField>
      );

      expect(getByTestId('child-input')).toBeTruthy();
    });

    it('should have correct testID', () => {
      const { getByTestId } = render(
        <FormField>
          <TextInput />
        </FormField>
      );

      expect(getByTestId('form-field')).toBeTruthy();
    });
  });

  describe('Label', () => {
    it('should render label when provided', () => {
      const { getByText } = render(
        <FormField label="Email Address">
          <TextInput />
        </FormField>
      );

      expect(getByText('Email Address')).toBeTruthy();
    });

    it('should not render label when not provided', () => {
      const { queryByTestId } = render(
        <FormField>
          <TextInput />
        </FormField>
      );

      expect(queryByTestId('form-field-label')).toBeNull();
    });
  });

  describe('Required Indicator', () => {
    it('should show asterisk when required is true', () => {
      const { getByText } = render(
        <FormField label="Email" required>
          <TextInput />
        </FormField>
      );

      expect(getByText('*')).toBeTruthy();
    });

    it('should not show asterisk when required is false', () => {
      const { queryByText } = render(
        <FormField label="Email" required={false}>
          <TextInput />
        </FormField>
      );

      expect(queryByText('*')).toBeNull();
    });
  });

  describe('Error Message', () => {
    it('should display error message when error prop is set', () => {
      const { getByText } = render(
        <FormField error="This field is required">
          <TextInput />
        </FormField>
      );

      expect(getByText('This field is required')).toBeTruthy();
    });

    it('should have accessibilityRole="alert" on error message', () => {
      const { getByRole } = render(
        <FormField error="Invalid email">
          <TextInput />
        </FormField>
      );

      expect(getByRole('alert')).toBeTruthy();
    });

    it('should not display error when not provided', () => {
      const { queryByTestId } = render(
        <FormField>
          <TextInput />
        </FormField>
      );

      expect(queryByTestId('form-field-error')).toBeNull();
    });
  });

  describe('Helper Text', () => {
    it('should display helper text when provided', () => {
      const { getByText } = render(
        <FormField helperText="Enter your email address">
          <TextInput />
        </FormField>
      );

      expect(getByText('Enter your email address')).toBeTruthy();
    });

    it('should hide helper text when error is present', () => {
      const { queryByText, getByText } = render(
        <FormField helperText="Helper" error="Error">
          <TextInput />
        </FormField>
      );

      expect(queryByText('Helper')).toBeNull();
      expect(getByText('Error')).toBeTruthy();
    });
  });

  describe('Custom Style', () => {
    it('should apply custom containerStyle', () => {
      const { getByTestId } = render(
        <FormField containerStyle={{ marginTop: 20 }}>
          <TextInput />
        </FormField>
      );

      const container = getByTestId('form-field');
      expect(container.props.style).toEqual(
        expect.arrayContaining([expect.objectContaining({ marginTop: 20 })])
      );
    });
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/FormField.test.tsx --run`
Expected: FAIL with "Cannot find module '@/components/ui/FormField'"

---

### Task 3: Web FormField Implementation (GREEN)

**Files:**
- Create: `klard-web/src/components/ui/form-field.tsx`

**Step 1: Tests should already be failing from Task 1**

**Step 2: Write minimal implementation**

```tsx
'use client';

import { useId } from 'react';
import { Label } from '@/components/ui/label';
import { cn } from '@/lib/utils';

export interface FormFieldProps {
  /** Label text displayed above the input */
  label?: string;
  /** Shows required asterisk after label */
  required?: boolean;
  /** Error message - displays in red below input */
  error?: string;
  /** Helper text - displays below input when no error */
  helperText?: string;
  /** Children input element(s) */
  children: React.ReactNode;
  /** Optional id for label association */
  id?: string;
  /** Additional className */
  className?: string;
}

export function FormField({
  label,
  required,
  error,
  helperText,
  children,
  id: providedId,
  className,
}: FormFieldProps) {
  const generatedId = useId();
  const id = providedId ?? generatedId;

  // Build aria-describedby for accessibility
  const describedBy = [
    error ? `${id}-error` : null,
    helperText && !error ? `${id}-helper` : null,
  ].filter(Boolean).join(' ') || undefined;

  return (
    <div
      data-slot="form-field"
      data-testid="form-field"
      className={cn('space-y-2', className)}
    >
      {label && (
        <Label
          htmlFor={id}
          className="flex items-center gap-1 text-sm font-medium text-slate-700 dark:text-slate-300"
        >
          {label}
          {required && (
            <span className="text-red-500" aria-hidden="true">
              *
            </span>
          )}
        </Label>
      )}
      {children}
      {error && (
        <p
          id={`${id}-error`}
          className="text-sm text-red-500"
          role="alert"
        >
          {error}
        </p>
      )}
      {helperText && !error && (
        <p
          id={`${id}-helper`}
          className="text-sm text-slate-500 dark:text-slate-400"
        >
          {helperText}
        </p>
      )}
    </div>
  );
}
```

**Step 3: Run test to verify it passes**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/form-field.test.tsx --run`
Expected: PASS

**Step 4: Commit**

```bash
git add klard-web/src/__tests__/components/ui/form-field.test.tsx klard-web/src/components/ui/form-field.tsx
git commit -m "feat(web): add FormField wrapper component with TDD"
```

---

### Task 4: Mobile FormField Implementation (GREEN)

**Files:**
- Create: `klard-mobile/src/components/ui/FormField.tsx`

**Step 1: Tests should already be failing from Task 2**

**Step 2: Write minimal implementation**

```tsx
import React from 'react';
import {
  View,
  Text,
  StyleSheet,
  type StyleProp,
  type ViewStyle,
} from 'react-native';

export interface FormFieldProps {
  /** Label text displayed above the input */
  label?: string;
  /** Shows required asterisk after label */
  required?: boolean;
  /** Error message - displays in red below input */
  error?: string;
  /** Helper text - displays below input when no error */
  helperText?: string;
  /** Children input element(s) */
  children: React.ReactNode;
  /** Container style override */
  containerStyle?: StyleProp<ViewStyle>;
}

export function FormField({
  label,
  required,
  error,
  helperText,
  children,
  containerStyle,
}: FormFieldProps) {
  return (
    <View
      testID="form-field"
      style={[styles.container, containerStyle]}
    >
      {label && (
        <View style={styles.labelRow} testID="form-field-label">
          <Text style={styles.label}>{label}</Text>
          {required && <Text style={styles.required}>*</Text>}
        </View>
      )}
      {children}
      {error && (
        <Text
          testID="form-field-error"
          style={styles.error}
          accessibilityRole="alert"
        >
          {error}
        </Text>
      )}
      {helperText && !error && (
        <Text testID="form-field-helper" style={styles.helper}>
          {helperText}
        </Text>
      )}
    </View>
  );
}

// Color constants aligned with Klard design system
const colors = {
  error: '#DC2626',
  textSecondary: '#475569',
  textMuted: '#64748B',
};

const styles = StyleSheet.create({
  container: {
    width: '100%',
    gap: 8,
  },
  labelRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    color: colors.textSecondary,
  },
  required: {
    fontSize: 14,
    color: colors.error,
  },
  error: {
    fontSize: 14,
    color: colors.error,
  },
  helper: {
    fontSize: 14,
    color: colors.textMuted,
  },
});
```

**Step 3: Run test to verify it passes**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/FormField.test.tsx --run`
Expected: PASS

**Step 4: Commit**

```bash
git add klard-mobile/src/__tests__/components/ui/FormField.test.tsx klard-mobile/src/components/ui/FormField.tsx
git commit -m "feat(mobile): add FormField wrapper component with TDD"
```

---

### Task 5: Export FormField from index files

**Files:**
- Modify: `klard-web/src/components/ui/index.ts`
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Update Web index.ts**

Add to `klard-web/src/components/ui/index.ts`:
```tsx
export { FormField, type FormFieldProps } from './form-field';
```

**Step 2: Update Mobile index.ts**

Add to `klard-mobile/src/components/ui/index.ts`:
```tsx
export { FormField, type FormFieldProps } from './FormField';
```

**Step 3: Run TypeScript check**

Run: `pnpm --filter klard-web exec tsc --noEmit && pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 4: Commit**

```bash
git add klard-web/src/components/ui/index.ts klard-mobile/src/components/ui/index.ts
git commit -m "feat: export FormField from component index files"
```

---

### Task 6: Verification & Mark Complete

**Step 1: Run all tests**

Run: `pnpm --filter klard-web test --run && pnpm --filter klard-mobile test --run`
Expected: All tests pass

**Step 2: Run TypeScript check**

Run: `pnpm --filter klard-web exec tsc --noEmit && pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 3: Update spec to DONE**

Edit `docs/screens/batch/Klard_Component_Specifications.md`:
- Change `<!-- IN-PROGRESS:2.1-form-field -->` to `<!-- DONE:2.1-form-field -->`

**Step 4: Final commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark FormField component as complete"
```

---

## Verification Checklist

- [ ] Component renders without errors (web + mobile)
- [ ] All props implemented + typed
- [ ] All required states functional (label, required, error, helperText)
- [ ] Matches design specification visually
- [ ] Accessibility attributes included (role="alert", aria-hidden)
- [ ] TypeScript passes with no errors
- [ ] All tests written for this component are passing
- [ ] Test coverage is sufficient for all critical behaviors and states
- [ ] Works on both platforms
- [ ] Exported from components/ui/index.ts