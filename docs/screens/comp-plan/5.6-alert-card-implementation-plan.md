# 5.6 AlertCard Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Build a cross-platform AlertCard component that displays alert/notification items with type-based styling, size variants, relative timestamps, subscription context, dismissible/pressable interactions, and full keyboard accessibility.

**Architecture:** Domain component built on existing primitives (Card, Badge, Avatar). Uses CVA for web variants with glassmorphism styling, StyleSheet for mobile with size variants. Type configuration drives icon/color theming. Custom relative time helper using `Intl.RelativeTimeFormat` (no extra deps). TDD approach with strict RED-GREEN-REFACTOR per task.

**Tech Stack:**
- Web: Next.js 16 App Router, React 19, TypeScript, Tailwind 4, CVA, lucide-react icons
- Mobile: React Native 0.81, Expo 54, TypeScript, StyleSheet, @expo/vector-icons, expo-haptics, expo-image

---

## SOLID Compliance

| Component | SRP | OCP | LSP | ISP | DIP |
|-----------|-----|-----|-----|-----|-----|
| AlertCard (web) | Renders alert UI only | Type/color via config object | Accepts AlertCardProps uniformly | Single focused props interface | Depends on abstractions (props, cn, cva) |
| AlertCard (mobile) | Renders alert UI only | Type/color via config object | Same alert shape works | Single focused props interface | Depends on abstractions (StyleSheet, haptics) |
| alertTypeConfig | Maps type to visual config | Extend by adding new types | N/A | Type-to-config mapping only | N/A |

### Principle Applications

- **SRP:** AlertCard renders alerts; timestamp formatting via shared helper
- **OCP:** New alert types added via config object, not code modification
- **LSP:** All alert types handled uniformly through config lookup
- **ISP:** Single focused interface (AlertCardProps) with optional props
- **DIP:** Components depend on Alert type interface, not concrete implementations

---

## Shared Types (Both Platforms)

```typescript
type AlertType = 'renewal' | 'price-increase' | 'price-decrease' | 'blocked' | 'savings' | 'system';

interface Alert {
  id: string;
  type: AlertType;
  title: string;
  body: string;
  timestamp: Date;
  read: boolean;
  subscription?: {
    name: string;
    logoUrl?: string;
  };
  actionLabel?: string;
}

interface AlertCardProps {
  alert: Alert;
  onPress: () => void;
  onDismiss?: () => void;
  size?: 'md' | 'sm';        // Size variants for list contexts
  className?: string;         // Web only
  style?: StyleProp<ViewStyle>; // Mobile only
  testID?: string;            // Mobile only
}
```

---

## Visual States & Alert Types

| Alert Type | Icon (Web) | Icon (Mobile) | Background | Text Color |
|------------|------------|---------------|------------|------------|
| renewal | Calendar | calendar | teal-100/60 | teal-700 |
| price-increase | TrendingUp | trending-up | amber-100/60 | amber-700 |
| price-decrease | TrendingDown | trending-down | green-100/60 | green-700 |
| blocked | Shield | shield | red-100/60 | red-700 |
| savings | PiggyBank | cash-outline | green-100/60 | green-700 |
| system | Info | information-circle | slate-100/60 | slate-700 |

### Size Variants

| Size | Padding (Web) | Padding (Mobile) | Icon Size | Title | Body |
|------|---------------|------------------|-----------|-------|------|
| md | px-4 py-3 | 14px | 20px | 15-16px semibold | 14px |
| sm | px-3 py-2.5 | 10px | 16px | 14px semibold | 13px |

---

## Dependencies

**Web:**
- `lucide-react` (Calendar, TrendingUp, TrendingDown, Shield, PiggyBank, Info, X)
- `class-variance-authority` (cva)
- `next/image` for subscription logo
- Existing: Button, Avatar from `@/components/ui`

**Mobile:**
- `@expo/vector-icons` (Ionicons)
- `expo-haptics`
- `expo-image` (for subscription logo)
- Existing: None required (self-contained)

---

## Task Breakdown

### Task 1: Web - Write Failing Tests for Basic Rendering

**Files:**
- Create: `klard-web/src/__tests__/components/ui/alert-card.test.tsx`

**Step 1: Write the failing test**

```tsx
// klard-web/src/__tests__/components/ui/alert-card.test.tsx
/**
 * Tests for AlertCard Component
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import { describe, it, expect, vi, beforeEach } from "vitest"
import { render, screen, fireEvent } from "@testing-library/react"
import { AlertCard } from "@/components/ui/alert-card"

const baseAlert = {
  id: "1",
  type: "renewal" as const,
  title: "Netflix renewal",
  body: "Renews in 3 days",
  timestamp: new Date("2024-01-01T12:00:00Z"),
  read: false,
}

describe("AlertCard", () => {
  beforeEach(() => {
    vi.setSystemTime(new Date("2024-01-02T12:00:00Z"))
  })

  describe("Rendering", () => {
    it("renders title, body, relative time, and unread dot", () => {
      render(<AlertCard alert={baseAlert} onPress={vi.fn()} />)
      expect(screen.getByText("Netflix renewal")).toBeInTheDocument()
      expect(screen.getByText("Renews in 3 days")).toBeInTheDocument()
      expect(screen.getByText("1 day ago")).toBeInTheDocument()
      expect(screen.getByLabelText(/unread/i)).toBeInTheDocument()
    })

    it("should have data-slot attribute", () => {
      render(<AlertCard alert={baseAlert} onPress={vi.fn()} />)
      expect(document.querySelector('[data-slot="alert-card"]')).toBeInTheDocument()
    })

    it("hides unread dot when alert.read is true", () => {
      render(<AlertCard alert={{ ...baseAlert, read: true }} onPress={vi.fn()} />)
      expect(screen.queryByLabelText(/unread/i)).not.toBeInTheDocument()
    })
  })
})
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-card.test.tsx --run`
Expected: FAIL with "Cannot find module '@/components/ui/alert-card'"

**Step 3: Skip implementation (next task)**

**Step 4: Skip**

**Step 5: Commit test file**

```bash
git add klard-web/src/__tests__/components/ui/alert-card.test.tsx
git commit -m "test(web): add failing AlertCard basic rendering tests"
```

---

### Task 2: Web - Implement Basic AlertCard with Type Config (GREEN)

**Files:**
- Create: `klard-web/src/components/ui/alert-card.tsx`

**Step 1: Already have failing tests from Task 1**

**Step 2: Already verified tests fail**

**Step 3: Write minimal implementation**

```tsx
// klard-web/src/components/ui/alert-card.tsx
"use client"

import * as React from "react"
import {
  Calendar,
  TrendingUp,
  TrendingDown,
  Shield,
  PiggyBank,
  Info,
  X,
  type LucideIcon,
} from "lucide-react"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

// Shared relative time helper (no external deps)
function formatRelative(date: Date, now = new Date()): string {
  const diff = date.getTime() - now.getTime()
  const minutes = Math.round(diff / 60000)
  const absMinutes = Math.abs(minutes)

  if (absMinutes < 60) {
    return new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(minutes, "minute")
  }
  const hours = Math.round(diff / 3600000)
  if (Math.abs(hours) < 24) {
    return new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(hours, "hour")
  }
  const days = Math.round(diff / 86400000)
  return new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(days, "day")
}

// Type configuration for OCP compliance
type AlertType = "renewal" | "price-increase" | "price-decrease" | "blocked" | "savings" | "system"

interface TypeConfig {
  icon: LucideIcon
  tone: string
}

const typeConfig: Record<AlertType, TypeConfig> = {
  renewal: { icon: Calendar, tone: "teal" },
  "price-increase": { icon: TrendingUp, tone: "amber" },
  "price-decrease": { icon: TrendingDown, tone: "green" },
  blocked: { icon: Shield, tone: "red" },
  savings: { icon: PiggyBank, tone: "green" },
  system: { icon: Info, tone: "slate" },
}

// CVA variants for size
const cardVariants = cva(
  "group relative flex w-full items-start gap-3 rounded-xl border bg-card/70 text-left shadow-sm backdrop-blur-sm transition hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
  {
    variants: {
      size: {
        md: "gap-3 px-4 py-3",
        sm: "gap-2.5 px-3 py-2.5",
      },
    },
    defaultVariants: { size: "md" },
  }
)

export interface Alert {
  id: string
  type: AlertType
  title: string
  body: string
  timestamp: Date
  read: boolean
  subscription?: { name: string; logoUrl?: string }
  actionLabel?: string
}

export interface AlertCardProps extends VariantProps<typeof cardVariants> {
  alert: Alert
  onPress: () => void
  onDismiss?: () => void
  className?: string
}

export function AlertCard({ alert, onPress, onDismiss, size, className }: AlertCardProps) {
  const { icon: Icon, tone } = typeConfig[alert.type]
  const timeText = formatRelative(alert.timestamp)

  const handleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault()
      onPress()
    }
  }

  return (
    <div
      role="button"
      tabIndex={0}
      data-slot="alert-card"
      onClick={onPress}
      onKeyDown={handleKeyDown}
      className={cn(cardVariants({ size }), className)}
      aria-label={alert.title}
    >
      {/* Icon bubble */}
      <div
        data-slot="alert-icon-container"
        className={cn(
          "mt-0.5 flex size-9 shrink-0 items-center justify-center rounded-full",
          `bg-${tone}-100/60 dark:bg-${tone}-900/30`
        )}
      >
        <Icon
          data-testid="alert-icon"
          className={cn("size-5", `text-${tone}-700 dark:text-${tone}-400`)}
        />
      </div>

      {/* Content */}
      <div className="flex flex-1 flex-col gap-1.5 min-w-0">
        <div className="flex items-center gap-2">
          <span className="font-semibold text-foreground line-clamp-1 text-[15px]">
            {alert.title}
          </span>
          {!alert.read && (
            <span
              aria-label="unread"
              className="size-2 rounded-full bg-primary shrink-0"
            />
          )}
        </div>
        <p className="text-sm text-muted-foreground line-clamp-2">
          {alert.body}
        </p>
        <span className="text-xs text-muted-foreground/70">
          {timeText}
        </span>
      </div>

      {/* Dismiss button (appears on hover) */}
      {onDismiss && (
        <button
          type="button"
          onClick={(e) => {
            e.stopPropagation()
            onDismiss()
          }}
          className={cn(
            "absolute top-2 right-2 p-1.5 rounded-full",
            "text-muted-foreground hover:text-foreground",
            "hover:bg-muted/80 opacity-0 group-hover:opacity-100",
            "transition-opacity focus:opacity-100",
            "focus:outline-none focus:ring-2 focus:ring-primary"
          )}
          aria-label={`Dismiss ${alert.title}`}
        >
          <X className="size-4" />
        </button>
      )}
    </div>
  )
}
```

**Step 4: Run test to verify it passes**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-card.test.tsx --run`
Expected: PASS

**Step 5: Commit**

```bash
git add klard-web/src/components/ui/alert-card.tsx
git commit -m "feat(web): add AlertCard component with basic rendering"
```

---

### Task 3: Web - Add Tests for Alert Types and Keyboard Navigation

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/alert-card.test.tsx`

**Step 1: Write the failing tests**

```tsx
// Add to existing test file after Rendering describe block

describe("Alert Types", () => {
  const types = [
    { type: "renewal", tone: "teal" },
    { type: "price-increase", tone: "amber" },
    { type: "price-decrease", tone: "green" },
    { type: "blocked", tone: "red" },
    { type: "savings", tone: "green" },
    { type: "system", tone: "slate" },
  ] as const

  types.forEach(({ type, tone }) => {
    it(`applies ${tone} styling for ${type} type`, () => {
      render(<AlertCard alert={{ ...baseAlert, type }} onPress={vi.fn()} />)
      const iconContainer = document.querySelector('[data-slot="alert-icon-container"]')
      expect(iconContainer?.className).toMatch(new RegExp(tone))
    })
  })
})

describe("Keyboard Accessibility", () => {
  it("handles Enter key to trigger onPress", () => {
    const onPress = vi.fn()
    render(<AlertCard alert={baseAlert} onPress={onPress} />)
    const card = screen.getByRole("button", { name: /netflix renewal/i })

    fireEvent.keyDown(card, { key: "Enter" })
    expect(onPress).toHaveBeenCalledTimes(1)
  })

  it("handles Space key to trigger onPress", () => {
    const onPress = vi.fn()
    render(<AlertCard alert={baseAlert} onPress={onPress} />)
    const card = screen.getByRole("button", { name: /netflix renewal/i })

    fireEvent.keyDown(card, { key: " " })
    expect(onPress).toHaveBeenCalledTimes(1)
  })

  it("has correct role and tabIndex for keyboard navigation", () => {
    render(<AlertCard alert={baseAlert} onPress={vi.fn()} />)
    const card = screen.getByRole("button", { name: /netflix renewal/i })

    expect(card).toHaveAttribute("tabIndex", "0")
  })
})
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-card.test.tsx --run`
Expected: PASS (these should pass with current implementation)

**Step 3: No changes needed if tests pass**

**Step 4: Run test to verify it passes**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-card.test.tsx --run`
Expected: PASS

**Step 5: Commit**

```bash
git add klard-web/src/__tests__/components/ui/alert-card.test.tsx
git commit -m "test(web): add AlertCard type styling and keyboard tests"
```

---

### Task 4: Web - Add Tests for Subscription, CTA, and Dismiss

**Files:**
- Modify: `klard-web/src/__tests__/components/ui/alert-card.test.tsx`

**Step 1: Write the failing tests**

```tsx
// Add to existing test file

describe("Subscription", () => {
  it("shows subscription name and logo when provided", () => {
    render(
      <AlertCard
        alert={{
          ...baseAlert,
          subscription: { name: "Spotify", logoUrl: "https://img/spotify.png" },
        }}
        onPress={vi.fn()}
      />
    )
    expect(screen.getByText("Spotify")).toBeInTheDocument()
    expect(screen.getByRole("img", { name: /spotify/i })).toBeInTheDocument()
  })

  it("shows avatar fallback when no logoUrl provided", () => {
    render(
      <AlertCard
        alert={{
          ...baseAlert,
          subscription: { name: "Netflix" },
        }}
        onPress={vi.fn()}
      />
    )
    expect(screen.getByText("Netflix")).toBeInTheDocument()
    // Avatar fallback should show initial
    expect(screen.getByText("N")).toBeInTheDocument()
  })

  it("does not render subscription section when not provided", () => {
    render(<AlertCard alert={baseAlert} onPress={vi.fn()} />)
    expect(document.querySelector('[data-slot="subscription"]')).not.toBeInTheDocument()
  })
})

describe("Action Button (CTA)", () => {
  it("renders CTA button when actionLabel provided", () => {
    render(
      <AlertCard
        alert={{ ...baseAlert, actionLabel: "Review" }}
        onPress={vi.fn()}
      />
    )
    expect(screen.getByRole("button", { name: "Review" })).toBeInTheDocument()
  })

  it("CTA click does not trigger main onPress", () => {
    const onPress = vi.fn()
    render(
      <AlertCard
        alert={{ ...baseAlert, actionLabel: "Review" }}
        onPress={onPress}
      />
    )
    fireEvent.click(screen.getByRole("button", { name: "Review" }))
    // CTA should stop propagation - onPress only called once via CTA action
    expect(onPress).toHaveBeenCalledTimes(1)
  })
})

describe("Dismiss", () => {
  it("shows dismiss button when onDismiss provided", () => {
    render(<AlertCard alert={baseAlert} onPress={vi.fn()} onDismiss={vi.fn()} />)
    expect(screen.getByRole("button", { name: /dismiss/i })).toBeInTheDocument()
  })

  it("does not show dismiss button when onDismiss not provided", () => {
    render(<AlertCard alert={baseAlert} onPress={vi.fn()} />)
    expect(screen.queryByRole("button", { name: /dismiss/i })).not.toBeInTheDocument()
  })

  it("invokes onDismiss and stops propagation", () => {
    const onPress = vi.fn()
    const onDismiss = vi.fn()
    render(<AlertCard alert={baseAlert} onPress={onPress} onDismiss={onDismiss} />)

    fireEvent.click(screen.getByRole("button", { name: /dismiss/i }))
    expect(onDismiss).toHaveBeenCalledTimes(1)
    expect(onPress).not.toHaveBeenCalled()
  })
})

describe("Size Variants", () => {
  it("applies md size by default", () => {
    render(<AlertCard alert={baseAlert} onPress={vi.fn()} />)
    const card = screen.getByRole("button", { name: /netflix renewal/i })
    expect(card.className).toMatch(/px-4|py-3/)
  })

  it("applies sm size when specified", () => {
    render(<AlertCard alert={baseAlert} onPress={vi.fn()} size="sm" />)
    const card = screen.getByRole("button", { name: /netflix renewal/i })
    expect(card.className).toMatch(/px-3|py-2\.5/)
  })
})
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-card.test.tsx --run`
Expected: FAIL - subscription and CTA not implemented yet

**Step 3: Skip implementation (next task)**

**Step 4: Skip**

**Step 5: Commit test file**

```bash
git add klard-web/src/__tests__/components/ui/alert-card.test.tsx
git commit -m "test(web): add AlertCard subscription, CTA, dismiss, size tests"
```

---

### Task 5: Web - Implement Subscription, CTA, and Complete Component (GREEN)

**Files:**
- Modify: `klard-web/src/components/ui/alert-card.tsx`

**Step 1: Already have failing tests from Task 4**

**Step 2: Already verified tests fail**

**Step 3: Write full implementation**

```tsx
// klard-web/src/components/ui/alert-card.tsx
"use client"

import * as React from "react"
import Image from "next/image"
import {
  Calendar,
  TrendingUp,
  TrendingDown,
  Shield,
  PiggyBank,
  Info,
  X,
  type LucideIcon,
} from "lucide-react"
import { cva, type VariantProps } from "class-variance-authority"
import { Button } from "@/components/ui/button"
import { cn } from "@/lib/utils"

// Shared relative time helper (no external deps)
function formatRelative(date: Date, now = new Date()): string {
  const diff = date.getTime() - now.getTime()
  const minutes = Math.round(diff / 60000)
  const absMinutes = Math.abs(minutes)

  if (absMinutes < 60) {
    return new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(minutes, "minute")
  }
  const hours = Math.round(diff / 3600000)
  if (Math.abs(hours) < 24) {
    return new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(hours, "hour")
  }
  const days = Math.round(diff / 86400000)
  return new Intl.RelativeTimeFormat("en", { numeric: "auto" }).format(days, "day")
}

// Type configuration for OCP compliance
type AlertType = "renewal" | "price-increase" | "price-decrease" | "blocked" | "savings" | "system"

interface TypeConfig {
  icon: LucideIcon
  tone: string
}

const typeConfig: Record<AlertType, TypeConfig> = {
  renewal: { icon: Calendar, tone: "teal" },
  "price-increase": { icon: TrendingUp, tone: "amber" },
  "price-decrease": { icon: TrendingDown, tone: "green" },
  blocked: { icon: Shield, tone: "red" },
  savings: { icon: PiggyBank, tone: "green" },
  system: { icon: Info, tone: "slate" },
}

// CVA variants for size
const cardVariants = cva(
  "group relative flex w-full items-start gap-3 rounded-xl border bg-card/70 text-left shadow-sm backdrop-blur-sm transition hover:shadow-md focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",
  {
    variants: {
      size: {
        md: "gap-3 px-4 py-3",
        sm: "gap-2.5 px-3 py-2.5",
      },
    },
    defaultVariants: { size: "md" },
  }
)

const iconVariants = cva("flex shrink-0 items-center justify-center rounded-full", {
  variants: {
    size: {
      md: "mt-0.5 size-9",
      sm: "mt-0.5 size-7",
    },
  },
  defaultVariants: { size: "md" },
})

const iconSizeMap = { md: "size-5", sm: "size-4" } as const

export interface Alert {
  id: string
  type: AlertType
  title: string
  body: string
  timestamp: Date
  read: boolean
  subscription?: { name: string; logoUrl?: string }
  actionLabel?: string
}

export interface AlertCardProps extends VariantProps<typeof cardVariants> {
  alert: Alert
  onPress: () => void
  onDismiss?: () => void
  className?: string
}

export function AlertCard({ alert, onPress, onDismiss, size = "md", className }: AlertCardProps) {
  const { icon: Icon, tone } = typeConfig[alert.type]
  const timeText = formatRelative(alert.timestamp)

  const handleKeyDown = (e: React.KeyboardEvent<HTMLDivElement>) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault()
      onPress()
    }
  }

  return (
    <div
      role="button"
      tabIndex={0}
      data-slot="alert-card"
      onClick={onPress}
      onKeyDown={handleKeyDown}
      className={cn(cardVariants({ size }), className)}
      aria-label={alert.title}
    >
      {/* Icon bubble */}
      <div
        data-slot="alert-icon-container"
        className={cn(
          iconVariants({ size }),
          `bg-${tone}-100/60 dark:bg-${tone}-900/30`
        )}
      >
        <Icon
          data-testid="alert-icon"
          className={cn(iconSizeMap[size ?? "md"], `text-${tone}-700 dark:text-${tone}-400`)}
        />
      </div>

      {/* Content */}
      <div className="flex flex-1 flex-col gap-1.5 min-w-0">
        {/* Title row */}
        <div className="flex items-center gap-2">
          <span className={cn(
            "font-semibold text-foreground line-clamp-1",
            size === "sm" ? "text-sm" : "text-[15px]"
          )}>
            {alert.title}
          </span>
          {!alert.read && (
            <span
              aria-label="unread"
              className="size-2 rounded-full bg-primary shrink-0"
            />
          )}
        </div>

        {/* Body */}
        <p className={cn(
          "text-muted-foreground line-clamp-2",
          size === "sm" ? "text-xs" : "text-sm"
        )}>
          {alert.body}
        </p>

        {/* Footer: time, subscription, CTA */}
        <div className="flex flex-wrap items-center gap-2 text-xs text-muted-foreground/70">
          <span aria-label={`Received ${timeText}`}>{timeText}</span>

          {/* Subscription chip */}
          {alert.subscription && (
            <div
              data-slot="subscription"
              className="flex items-center gap-1.5 rounded-full bg-muted/60 px-2 py-1"
            >
              {alert.subscription.logoUrl ? (
                <Image
                  src={alert.subscription.logoUrl}
                  alt={alert.subscription.name}
                  width={20}
                  height={20}
                  className="size-5 rounded-full object-cover"
                />
              ) : (
                <div className="flex size-5 items-center justify-center rounded-full bg-muted text-[10px] font-semibold text-muted-foreground">
                  {alert.subscription.name[0]}
                </div>
              )}
              <span className="text-xs font-medium text-foreground">
                {alert.subscription.name}
              </span>
            </div>
          )}

          {/* CTA button */}
          {alert.actionLabel && (
            <Button
              variant="outline"
              size="sm"
              className="h-7 text-xs"
              onClick={(e) => {
                e.stopPropagation()
                onPress()
              }}
            >
              {alert.actionLabel}
            </Button>
          )}
        </div>
      </div>

      {/* Dismiss button (appears on hover) */}
      {onDismiss && (
        <button
          type="button"
          onClick={(e) => {
            e.stopPropagation()
            onDismiss()
          }}
          className={cn(
            "absolute top-2 right-2 p-1.5 rounded-full",
            "text-muted-foreground hover:text-foreground",
            "hover:bg-muted/80 opacity-0 group-hover:opacity-100",
            "transition-opacity focus:opacity-100",
            "focus:outline-none focus:ring-2 focus:ring-primary"
          )}
          aria-label={`Dismiss ${alert.title}`}
        >
          <X className="size-4" />
        </button>
      )}
    </div>
  )
}
```

**Step 4: Run test to verify it passes**

Run: `pnpm --filter klard-web test src/__tests__/components/ui/alert-card.test.tsx --run`
Expected: PASS

**Step 5: Commit**

```bash
git add klard-web/src/components/ui/alert-card.tsx
git commit -m "feat(web): complete AlertCard with subscription, CTA, size variants"
```

---

### Task 6: Web - Export from Index and TypeScript Check

**Files:**
- Modify: `klard-web/src/components/ui/index.ts`

**Step 1: Add export**

```tsx
// Add to klard-web/src/components/ui/index.ts
export { AlertCard, type AlertCardProps, type Alert } from './alert-card';
```

**Step 2: Run TypeScript check**

Run: `pnpm --filter klard-web exec tsc --noEmit`
Expected: No errors

**Step 3: Run all web tests**

Run: `pnpm --filter klard-web test --run`
Expected: All tests pass

**Step 4: Commit**

```bash
git add klard-web/src/components/ui/index.ts
git commit -m "feat(web): export AlertCard from UI components index"
```

---

### Task 7: Mobile - Write Failing Tests for Basic Rendering

**Files:**
- Create: `klard-mobile/src/__tests__/components/ui/AlertCard.test.tsx`

**Step 1: Write the failing test**

```tsx
// klard-mobile/src/__tests__/components/ui/AlertCard.test.tsx
/**
 * Tests for AlertCard Component (Mobile)
 *
 * TDD: Write failing tests first, then implement to pass.
 */

import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react-native';
import * as Haptics from 'expo-haptics';
import { AlertCard } from '@/components/ui/AlertCard';

// Mock expo-haptics
jest.mock('expo-haptics', () => ({
  impactAsync: jest.fn(),
  ImpactFeedbackStyle: {
    Light: 'light',
    Medium: 'medium',
    Heavy: 'heavy',
  },
}));

// Mock expo-image
jest.mock('expo-image', () => {
  const React = require('react');
  const { View, Image } = require('react-native');
  return {
    Image: ({ testID, source, accessibilityLabel, ...props }: any) => (
      <Image
        testID={testID || 'expo-image'}
        source={source}
        accessibilityLabel={accessibilityLabel}
        {...props}
      />
    ),
  };
});

// Mock vector icons
jest.mock('@expo/vector-icons', () => {
  const React = require('react');
  const { Text } = require('react-native');
  return {
    Ionicons: ({ name, testID }: { name: string; testID?: string }) => (
      <Text testID={testID || 'ionicon'}>{name}</Text>
    ),
  };
});

const baseAlert = {
  id: '1',
  type: 'renewal' as const,
  title: 'Netflix renewal',
  body: 'Renews in 3 days',
  timestamp: new Date('2024-01-01T12:00:00Z'),
  read: false,
};

describe('AlertCard (Mobile)', () => {
  beforeEach(() => {
    jest.useFakeTimers().setSystemTime(new Date('2024-01-02T12:00:00Z'));
    jest.clearAllMocks();
  });

  afterEach(() => {
    jest.useRealTimers();
  });

  describe('Rendering', () => {
    it('renders title, body, relative time, and unread dot', () => {
      render(<AlertCard alert={baseAlert} onPress={jest.fn()} />);

      expect(screen.getByText('Netflix renewal')).toBeTruthy();
      expect(screen.getByText('Renews in 3 days')).toBeTruthy();
      expect(screen.getByText('1 day ago')).toBeTruthy();
      expect(screen.getByLabelText(/unread/i)).toBeTruthy();
    });

    it('hides unread dot when alert.read is true', () => {
      render(<AlertCard alert={{ ...baseAlert, read: true }} onPress={jest.fn()} />);
      expect(screen.queryByLabelText(/unread/i)).toBeNull();
    });

    it('has correct accessibility role', () => {
      render(<AlertCard alert={baseAlert} onPress={jest.fn()} testID="alert-card" />);
      const card = screen.getByTestID('alert-card');
      expect(card.props.accessibilityRole).toBe('button');
    });
  });
});
```

**Step 2: Run test to verify it fails**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/AlertCard.test.tsx --run`
Expected: FAIL with "Cannot find module '@/components/ui/AlertCard'"

**Step 3: Skip implementation (next task)**

**Step 4: Skip**

**Step 5: Commit test file**

```bash
git add klard-mobile/src/__tests__/components/ui/AlertCard.test.tsx
git commit -m "test(mobile): add failing AlertCard basic rendering tests"
```

---

### Task 8: Mobile - Implement Basic AlertCard (GREEN)

**Files:**
- Create: `klard-mobile/src/components/ui/AlertCard/AlertCard.tsx`
- Create: `klard-mobile/src/components/ui/AlertCard/alert-card.styles.ts`
- Create: `klard-mobile/src/components/ui/AlertCard/index.ts`

**Step 1: Already have failing tests from Task 7**

**Step 2: Already verified tests fail**

**Step 3: Write minimal implementation**

```tsx
// klard-mobile/src/components/ui/AlertCard/AlertCard.tsx
import React from 'react';
import {
  View,
  Text,
  Pressable,
  type StyleProp,
  type ViewStyle,
} from 'react-native';
import { Image } from 'expo-image';
import { Ionicons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';
import { styles, variantStyles, iconColors, sizeStyles, textSizeStyles } from './alert-card.styles';

// Shared relative time helper
function formatRelative(date: Date, now = new Date()): string {
  const diff = date.getTime() - now.getTime();
  const minutes = Math.round(diff / 60000);
  const absMinutes = Math.abs(minutes);

  if (absMinutes < 60) {
    return new Intl.RelativeTimeFormat('en', { numeric: 'auto' }).format(minutes, 'minute');
  }
  const hours = Math.round(diff / 3600000);
  if (Math.abs(hours) < 24) {
    return new Intl.RelativeTimeFormat('en', { numeric: 'auto' }).format(hours, 'hour');
  }
  const days = Math.round(diff / 86400000);
  return new Intl.RelativeTimeFormat('en', { numeric: 'auto' }).format(days, 'day');
}

type AlertType = 'renewal' | 'price-increase' | 'price-decrease' | 'blocked' | 'savings' | 'system';

interface TypeConfig {
  icon: keyof typeof Ionicons.glyphMap;
}

const typeConfig: Record<AlertType, TypeConfig> = {
  renewal: { icon: 'calendar' },
  'price-increase': { icon: 'trending-up' },
  'price-decrease': { icon: 'trending-down' },
  blocked: { icon: 'shield' },
  savings: { icon: 'cash-outline' },
  system: { icon: 'information-circle' },
};

export interface Alert {
  id: string;
  type: AlertType;
  title: string;
  body: string;
  timestamp: Date;
  read: boolean;
  subscription?: { name: string; logoUrl?: string };
  actionLabel?: string;
}

export interface AlertCardProps {
  alert: Alert;
  onPress: () => void;
  onDismiss?: () => void;
  size?: 'md' | 'sm';
  style?: StyleProp<ViewStyle>;
  testID?: string;
}

export function AlertCard({
  alert,
  onPress,
  onDismiss,
  size = 'md',
  style,
  testID,
}: AlertCardProps) {
  const { icon } = typeConfig[alert.type];
  const timeText = formatRelative(alert.timestamp);
  const iconSize = size === 'sm' ? 16 : 20;

  const handlePress = async () => {
    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    onPress();
  };

  const handleDismiss = async () => {
    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    onDismiss?.();
  };

  return (
    <Pressable
      onPress={handlePress}
      accessibilityRole="button"
      accessibilityLabel={alert.title}
      style={({ pressed }) => [
        styles.container,
        sizeStyles[size],
        pressed && styles.pressed,
        style,
      ]}
      testID={testID}
    >
      {/* Icon bubble */}
      <View style={[styles.iconBubble, variantStyles[alert.type]]}>
        <Ionicons
          name={icon}
          size={iconSize}
          color={iconColors[alert.type]}
          testID="alert-icon"
        />
      </View>

      {/* Content */}
      <View style={styles.content}>
        {/* Title row */}
        <View style={styles.titleRow}>
          <Text
            style={[styles.title, textSizeStyles[size].title]}
            numberOfLines={1}
          >
            {alert.title}
          </Text>
          {!alert.read && (
            <View
              style={styles.unreadDot}
              accessibilityLabel="unread"
            />
          )}
        </View>

        {/* Body */}
        <Text
          style={[styles.body, textSizeStyles[size].body]}
          numberOfLines={2}
        >
          {alert.body}
        </Text>

        {/* Footer */}
        <View style={styles.footer}>
          <Text style={styles.time}>{timeText}</Text>

          {/* Subscription chip */}
          {alert.subscription && (
            <View style={styles.subscription}>
              {alert.subscription.logoUrl ? (
                <Image
                  source={alert.subscription.logoUrl}
                  style={styles.subscriptionLogo}
                  contentFit="cover"
                  accessibilityLabel={alert.subscription.name}
                />
              ) : (
                <View style={[styles.subscriptionLogo, styles.subscriptionFallback]}>
                  <Text style={styles.subscriptionInitial}>
                    {alert.subscription.name[0]}
                  </Text>
                </View>
              )}
              <Text style={styles.subscriptionText}>{alert.subscription.name}</Text>
            </View>
          )}

          {/* CTA button */}
          {alert.actionLabel && (
            <Pressable
              onPress={(e) => {
                e.stopPropagation?.();
                handlePress();
              }}
              style={styles.cta}
              accessibilityLabel={alert.actionLabel}
            >
              <Text style={styles.ctaText}>{alert.actionLabel}</Text>
            </Pressable>
          )}
        </View>
      </View>

      {/* Dismiss button */}
      {onDismiss && (
        <Pressable
          onPress={handleDismiss}
          style={styles.dismissButton}
          hitSlop={{ top: 8, bottom: 8, left: 8, right: 8 }}
          accessibilityLabel={`Dismiss ${alert.title}`}
          accessibilityRole="button"
        >
          <Ionicons name="close" size={16} color="#94A3B8" />
        </Pressable>
      )}
    </Pressable>
  );
}
```

```tsx
// klard-mobile/src/components/ui/AlertCard/alert-card.styles.ts
import { StyleSheet } from 'react-native';

export const styles = StyleSheet.create({
  container: {
    flexDirection: 'row',
    gap: 12,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: 'rgba(148,163,184,0.3)',
    backgroundColor: 'rgba(255,255,255,0.95)',
    position: 'relative',
  },
  pressed: {
    opacity: 0.95,
    transform: [{ scale: 0.99 }],
  },
  iconBubble: {
    width: 36,
    height: 36,
    borderRadius: 18,
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: 2,
  },
  content: {
    flex: 1,
    gap: 6,
  },
  titleRow: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
  },
  title: {
    fontWeight: '600',
    color: '#0F172A',
    flex: 1,
  },
  unreadDot: {
    width: 8,
    height: 8,
    borderRadius: 4,
    backgroundColor: '#15B5B0',
  },
  body: {
    color: '#475569',
    lineHeight: 20,
  },
  footer: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
    flexWrap: 'wrap',
  },
  time: {
    fontSize: 12,
    color: '#64748B',
  },
  subscription: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 6,
    paddingHorizontal: 8,
    paddingVertical: 4,
    backgroundColor: 'rgba(148,163,184,0.15)',
    borderRadius: 999,
  },
  subscriptionLogo: {
    width: 20,
    height: 20,
    borderRadius: 10,
  },
  subscriptionFallback: {
    backgroundColor: '#E2E8F0',
    alignItems: 'center',
    justifyContent: 'center',
  },
  subscriptionInitial: {
    fontSize: 10,
    fontWeight: '600',
    color: '#0F172A',
  },
  subscriptionText: {
    fontSize: 12,
    fontWeight: '600',
    color: '#0F172A',
  },
  cta: {
    paddingHorizontal: 10,
    paddingVertical: 6,
    backgroundColor: '#E2E8F0',
    borderRadius: 10,
  },
  ctaText: {
    fontSize: 12,
    fontWeight: '600',
    color: '#0D7C7A',
  },
  dismissButton: {
    position: 'absolute',
    top: 8,
    right: 8,
    padding: 4,
  },
});

export const variantStyles = StyleSheet.create({
  renewal: { backgroundColor: 'rgba(13,124,122,0.15)' },
  'price-increase': { backgroundColor: 'rgba(245,158,11,0.15)' },
  'price-decrease': { backgroundColor: 'rgba(16,185,129,0.15)' },
  blocked: { backgroundColor: 'rgba(239,68,68,0.15)' },
  savings: { backgroundColor: 'rgba(16,185,129,0.15)' },
  system: { backgroundColor: 'rgba(71,85,105,0.15)' },
});

export const iconColors: Record<string, string> = {
  renewal: '#0D7C7A',
  'price-increase': '#F59E0B',
  'price-decrease': '#10B981',
  blocked: '#EF4444',
  savings: '#10B981',
  system: '#475569',
};

export const sizeStyles = StyleSheet.create({
  md: { padding: 14 },
  sm: { padding: 10, gap: 10 },
});

export const textSizeStyles = {
  md: StyleSheet.create({
    title: { fontSize: 15 },
    body: { fontSize: 14 },
  }),
  sm: StyleSheet.create({
    title: { fontSize: 14 },
    body: { fontSize: 13 },
  }),
};
```

```tsx
// klard-mobile/src/components/ui/AlertCard/index.ts
export { AlertCard, type AlertCardProps, type Alert } from './AlertCard';
```

**Step 4: Run test to verify it passes**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/AlertCard.test.tsx --run`
Expected: PASS

**Step 5: Commit**

```bash
git add klard-mobile/src/components/ui/AlertCard/
git commit -m "feat(mobile): add AlertCard component with basic rendering"
```

---

### Task 9: Mobile - Add Remaining Tests

**Files:**
- Modify: `klard-mobile/src/__tests__/components/ui/AlertCard.test.tsx`

**Step 1: Add comprehensive tests**

```tsx
// Add to existing test file after Rendering describe block

describe('Alert Types', () => {
  const types = ['renewal', 'price-increase', 'price-decrease', 'blocked', 'savings', 'system'] as const;

  types.forEach((type) => {
    it(`renders ${type} alert with icon`, () => {
      render(<AlertCard alert={{ ...baseAlert, type }} onPress={jest.fn()} />);
      expect(screen.getByTestId('alert-icon')).toBeTruthy();
    });
  });
});

describe('Interactions', () => {
  it('invokes onPress with haptics on press', async () => {
    const onPress = jest.fn();
    render(<AlertCard alert={baseAlert} onPress={onPress} testID="alert-card" />);

    fireEvent.press(screen.getByTestID('alert-card'));

    await waitFor(() => {
      expect(onPress).toHaveBeenCalledTimes(1);
      expect(Haptics.impactAsync).toHaveBeenCalledWith(Haptics.ImpactFeedbackStyle.Light);
    });
  });

  it('invokes onDismiss without triggering onPress', async () => {
    const onPress = jest.fn();
    const onDismiss = jest.fn();
    render(<AlertCard alert={baseAlert} onPress={onPress} onDismiss={onDismiss} />);

    fireEvent.press(screen.getByLabelText(/dismiss/i));

    await waitFor(() => {
      expect(onDismiss).toHaveBeenCalledTimes(1);
      expect(onPress).not.toHaveBeenCalled();
    });
  });
});

describe('Subscription', () => {
  it('shows subscription with logo when provided', () => {
    render(
      <AlertCard
        alert={{
          ...baseAlert,
          subscription: { name: 'Spotify', logoUrl: 'https://img/spotify.png' },
        }}
        onPress={jest.fn()}
      />
    );
    expect(screen.getByText('Spotify')).toBeTruthy();
    expect(screen.getByLabelText(/spotify/i)).toBeTruthy();
  });

  it('shows initial fallback when no logo', () => {
    render(
      <AlertCard
        alert={{
          ...baseAlert,
          subscription: { name: 'Netflix' },
        }}
        onPress={jest.fn()}
      />
    );
    expect(screen.getByText('Netflix')).toBeTruthy();
    expect(screen.getByText('N')).toBeTruthy();
  });
});

describe('CTA Button', () => {
  it('renders CTA when actionLabel provided', () => {
    render(
      <AlertCard
        alert={{ ...baseAlert, actionLabel: 'Review' }}
        onPress={jest.fn()}
      />
    );
    expect(screen.getByText('Review')).toBeTruthy();
  });
});

describe('Size Variants', () => {
  it('renders with md size by default', () => {
    render(<AlertCard alert={baseAlert} onPress={jest.fn()} testID="alert" />);
    const card = screen.getByTestID('alert');
    expect(card).toBeTruthy();
  });

  it('renders with sm size when specified', () => {
    render(<AlertCard alert={baseAlert} onPress={jest.fn()} size="sm" testID="alert" />);
    const card = screen.getByTestID('alert');
    expect(card).toBeTruthy();
  });
});
```

**Step 2: Run all tests**

Run: `pnpm --filter klard-mobile test src/__tests__/components/ui/AlertCard.test.tsx --run`
Expected: PASS

**Step 3: Commit**

```bash
git add klard-mobile/src/__tests__/components/ui/AlertCard.test.tsx
git commit -m "test(mobile): add comprehensive AlertCard tests"
```

---

### Task 10: Mobile - Export from Index and TypeScript Check

**Files:**
- Modify: `klard-mobile/src/components/ui/index.ts`

**Step 1: Add export**

```tsx
// Add to klard-mobile/src/components/ui/index.ts
export { AlertCard, type AlertCardProps, type Alert } from './AlertCard';
```

**Step 2: Run TypeScript check**

Run: `pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 3: Run all mobile tests**

Run: `pnpm --filter klard-mobile test --run`
Expected: All tests pass

**Step 4: Commit**

```bash
git add klard-mobile/src/components/ui/index.ts
git commit -m "feat(mobile): export AlertCard from UI components index"
```

---

### Task 11: Final Verification and Spec Update

**Step 1: Run all web tests**

Run: `pnpm --filter klard-web test --run`
Expected: All tests pass

**Step 2: Run all mobile tests**

Run: `pnpm --filter klard-mobile test --run`
Expected: All tests pass

**Step 3: Run TypeScript checks for both**

Run: `pnpm --filter klard-web exec tsc --noEmit && pnpm --filter klard-mobile exec tsc --noEmit`
Expected: No errors

**Step 4: Update spec to DONE**

Edit `docs/screens/batch/Klard_Component_Specifications.md`:
- Replace `<!-- IN-PROGRESS:5.6-alert-card -->` with `<!-- DONE:5.6-alert-card -->`

**Step 5: Final commit**

```bash
git add docs/screens/batch/Klard_Component_Specifications.md
git commit -m "docs: mark 5.6-alert-card as DONE"
```

---

## Verification Checklist

- [ ] Component renders without errors (web + mobile)
- [ ] All props implemented + typed (AlertCardProps, Alert type)
- [ ] All 6 alert types render with correct styling
- [ ] Size variants (md/sm) work correctly
- [ ] Unread indicator shows/hides based on read state
- [ ] Relative timestamp displays correctly
- [ ] Subscription chip with logo/fallback works
- [ ] CTA button renders and handles clicks
- [ ] Dismiss button works with event stopPropagation
- [ ] Keyboard accessibility (Enter/Space) on web
- [ ] Haptic feedback on mobile press
- [ ] TypeScript passes with no errors
- [ ] All tests passing (web + mobile)
- [ ] Exported from components/ui/index.ts (both packages)
- [ ] Spec marker updated to DONE

---

## Merged Improvements from Both Plans

| Feature | Source | Benefit |
|---------|--------|---------|
| Size variants (md/sm) | Old plan | Supports compact list contexts |
| Keyboard tests (Enter/Space) | Old plan | Better a11y coverage |
| CVA for variants | Old plan | Flexible, type-safe styling |
| Glassmorphism (backdrop-blur) | Old plan | Matches Klard design system |
| Custom Intl.RelativeTimeFormat | Old plan | No extra dependencies |
| Folder structure (mobile) | New plan | Matches existing codebase |
| Strict RED-GREEN task structure | New plan | Better TDD discipline |
| 11 bite-sized tasks | New plan | 2-5 min granularity |
| Explicit test commits first | New plan | True TDD flow |
| data-slot attributes | New plan | Consistent with shadcn |